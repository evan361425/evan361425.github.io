<!DOCTYPE HTML>
<html lang="zh-TW" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Container Orchestration and Misc. - 呂學洲</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="各種紀錄和連結">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../../favicon.svg">
                        <link rel="shortcut icon" href="../../favicon.png">
                <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
                <link rel="stylesheet" href="../../style.css">
                <link rel="stylesheet" href="../../pagetoc.css">
        
                <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
                 <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-P67FD9XP83"></script>
        <script>
            if (["localhost", "127.0.0.1", ""].indexOf(document.location.hostname) === -1) {
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());
                gtag('config', 'G-P67FD9XP83');
            }
        </script>
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "rust" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../introduction.html">自我介紹</a></li><li class="chapter-item "><a href="../../projects/index.html">開源專案</a></li><li class="chapter-item expanded "><a href="../../feedback/index.html">讀書心得（照字母排序）</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../feedback/designing-data-intensive-applications/introduction.html">撰寫中 - Designing Data-intensive Applications</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../feedback/designing-data-intensive-applications/data-model.html">Data Model</a></li><li class="chapter-item "><a href="../../feedback/designing-data-intensive-applications/db-index.html">DB Index</a></li><li class="chapter-item "><a href="../../feedback/designing-data-intensive-applications/encoding-evolution.html">Encoding and Schema Evolution</a></li><li class="chapter-item "><a href="../../feedback/designing-data-intensive-applications/read-intensive-db.html">Read Intensive DB</a></li></ol></li><li class="chapter-item expanded "><a href="../../feedback/distributed-systems-with-node.js/introduction.html">Distributed Systems with Node.js</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../feedback/distributed-systems-with-node.js/protocol.html">Protocol</a></li><li class="chapter-item "><a href="../../feedback/distributed-systems-with-node.js/sla-and-load-testing.html">SLA and Load Testing</a></li><li class="chapter-item "><a href="../../feedback/distributed-systems-with-node.js/observability.html">Observability</a></li><li class="chapter-item "><a href="../../feedback/distributed-systems-with-node.js/container.html">Container</a></li><li class="chapter-item expanded "><a href="../../feedback/distributed-systems-with-node.js/container-orchestration-and-misc.html" class="active">Container Orchestration and Misc.</a></li></ol></li></ol></li><li class="chapter-item "><a href="../../essay/index.html">隨筆</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../essay/made-container.html">如何製作 Docker Container</a></li><li class="chapter-item "><a href="../../essay/node.js-best-practice.html">Node.js 最佳實作</a></li><li class="chapter-item "><a href="../../essay/node.js-error.html">Node.js 的錯誤有哪些</a></li><li class="chapter-item "><a href="../../essay/pki-checklist.html">建置 PKI 注意事項</a></li><li class="chapter-item "><a href="../../essay/questionnaire-principal.html">問卷設計指南</a></li><li class="chapter-item "><a href="../../essay/retry-strategy.html">Retry 的策略</a></li><li class="chapter-item "><a href="../../essay/replace-docker-desktop.html">取代 Docker Desktop</a></li><li class="chapter-item "><a href="../../essay/url-structure.html">URL 長什麼樣子</a></li><li class="chapter-item "><a href="../../essay/vault/index.html">Vault</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../essay/vault/introduction.html">介紹</a></li><li class="chapter-item "><a href="../../essay/vault/implementation.html">實作</a></li><li class="chapter-item "><a href="../../essay/vault/engine-pki.html">PKI</a></li><li class="chapter-item "><a href="../../essay/vault/engine-transit.html">Transit</a></li></ol></li><li class="chapter-item "><a href="../../essay/web-security/index.html">網路安全</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../essay/web-security/cross-origin-resources-sharing.html">CORS</a></li><li class="chapter-item "><a href="../../essay/web-security/mixed-content.html">Mixed Content</a></li><li class="chapter-item "><a href="../../essay/web-security/owasp-api-top10.html">OWASP API Top 10</a></li><li class="chapter-item "><a href="../../essay/web-security/owasp-authentication-best-practice.html">OWASP 驗證機制最佳指南</a></li><li class="chapter-item "><a href="../../essay/web-security/owasp-mobile-risk-top10.html">OWASP 行動裝置風險</a></li></ol></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">呂學洲</h1>

                    <div class="right-buttons">
                                                                        <a href="https://github.com/evan361425/evan361425.github.io" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                                        <a href="https://github.com/evan361425/evan361425.github.io/edit/master/src/feedback/distributed-systems-with-node.js/container-orchestration-and-misc.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <nav class="pagetoc"></nav>

                    <main>
                        <h1 id="container-orchestration-and-misc"><a class="header" href="#container-orchestration-and-misc">Container Orchestration and Misc.</a></h1>
<p>上一份報告說明 Container 的價值和建構邏輯。而 Docker 不僅作為包裝應用程式的工具，也幫我們管理 Container。</p>
<p>但是仍有一些狀況需要解決：</p>
<ul>
<li>如何做 Scaling，單一或多台機器</li>
<li>Load Balance</li>
<li>Health Check and Replacement</li>
<li>多服務間的溝通，docker-compose 僅能在單一台機器下協助溝通</li>
<li>新版本的應用程式如何無縫接軌</li>
</ul>
<p>這時便需要一個調度容器（Container）的工具。</p>
<h2 id="kubernetes"><a class="header" href="#kubernetes">Kubernetes</a></h2>
<p>Kubernetes 可以解決上述提到的問題。接下來會先簡單介紹其中各名詞代表的意義，然後再實作，這樣對於實作時操作的各個指令就會比較有感。</p>
<h3 id="單位"><a class="header" href="#單位">單位</a></h3>
<p>以下將逐一介紹 Kubernetes 的基本單位。</p>
<ul>
<li>Container</li>
<li>Volume</li>
<li>Pod</li>
<li>Node</li>
<li>Master</li>
<li>Cluster</li>
</ul>
<h4 id="container"><a class="header" href="#container">Container</a></h4>
<p>管理容器化的應用程式，除了 Docker 外，上一份報告提到的 rkt 也是允許的應用程式。</p>
<h4 id="volume"><a class="header" href="#volume">Volume</a></h4>
<p>和 Host 的 filesystem 做連接的服務，對 Container 提供資料存取的地方。</p>
<h4 id="pod"><a class="header" href="#pod">Pod</a></h4>
<p>用來包裝 Container 和 Volume 的單位，一個 Pod 會被分配到一個 IP。若 Pod 中含有多的 Container 的話，各個 Container 會共用該組 IP。</p>
<p>有上述三個單位可以畫出一個圖：</p>
<img style="display: block; margin-left: auto;margin-right: auto" width="50%" src="https://i.imgur.com/ESmuJ0d.png"/>
<h4 id="node"><a class="header" href="#node">Node</a></h4>
<p>如同 Docker 管理 Container 一般，Node 就是管理 Pod 的單位。
一個 Node 底下需要一些輔助工具來幫助管理各個 Pod 和 Container：</p>
<ul>
<li>Kubernetes Daemon（稱作 Kubelet）</li>
<li>Container Daemon（如：Docker）</li>
<li>Network Proxy（稱作 Kube Proxy）</li>
</ul>
<pre><code>┌─────────────────────────────┐
│                             │
│     Kubernetes Node         │
│                             │
│  ┌────────────┐             │
│  │ Kubernetes │   Kubelet   │
│  │     Pod    │             │
│  └────────────┘   Docker    │
│                             │
│  ┌────────────┐  Kube proxy │
│  │ Kubernetes │             │
│  │     Pod    │             │
│  └────────────┘             │
│                             │
└─────────────────────────────┘
</code></pre>
<h4 id="master"><a class="header" href="#master">Master</a></h4>
<p>用來管理 Node，並對外開放 API，提供途徑去操作各個 Node。
如：開發者可以通過 <code>kubectl</code> 透過 Master 去操作各個 Node。
（類似於 <code>Docker CLI</code> 透過 <code>Daemon</code> 去操作各個 <code>Container</code>）</p>
<h4 id="cluster"><a class="header" href="#cluster">Cluster</a></h4>
<p>一組由 Master 和多個 Node 組成的群組。</p>
<h4 id="完整概略圖"><a class="header" href="#完整概略圖">完整概略圖</a></h4>
<p><img src="https://i.imgur.com/mkcGdX3.png" alt="" /></p>
<h3 id="概念"><a class="header" href="#概念">概念</a></h3>
<p>每次呼叫 Master 做事情，事實上就是指定一個 Cluster 應該有的狀態，如：</p>
<blockquote>
<p>我希望某某 Node 裡面有 10 個版本 2 的 Pod。</p>
</blockquote>
<p>此時 Kubernetes 就會針對該狀態開始做事，不管是降低、升高數量或升降版本的操作都是由 Kubernetes 去執行。</p>
<blockquote>
<p>此處包括執行邏輯，例如預期 10 個 Pod，現有 4 個，需增加 6 個，此處的 6 個就是 Kubernetes 自行去計算出的數字。</p>
</blockquote>
<p>接下來會介紹幾個在本次實作會應用到的觀念。</p>
<ul>
<li>Deployment</li>
<li>Selector</li>
<li>Label</li>
<li>Scheduler</li>
<li>Controller</li>
<li>ReplicaSet</li>
<li>Probe</li>
</ul>
<pre><code>                              ┌─┬─────────┐
                              │L│ Defined │
                              │a│  Pod B  │
                              │b│         │
                              │e│         │
                              │l│         │
                              │ │         │
         ┌──────────┐         │B│         │
kubectl─►│Deployment│         └─┴─────────┘
         └─────┬────┘
               │              ┌─┬─────────┐
               │              │L│ Defined │
               │ Selector     │a│  Pod A  │
               └───────────►  │b│         │
                              │e│         │
                              │l│         │  ┌────────────┐
                              │ │         │  │ ReplicaSet │
                              │A│         │  │            │
                              └─┴─────────┘  │ ┌───────┐  │
┌─┬─────────┐                                │ │Pod A-1│  │
│L│ Defined │                                │ └───────┘  │
│a│  Pod A  │                                │            │
│b│         │Scheduler   ┌─────┐Controller   │ ┌───────┐  │
│e│         ├───────────►│Ready├───────────► │ │Pod A-2│  │
│l│         │Pending     └─────┘Creating     │ └───────┘  │
│ │         │                                │            │
│A│         │                Probe           │ ┌───────┐  │
└─┴─────────┘               ─────────────────┼─►Pod A-N│  │
                             Health Checking │ └───────┘  │
                                             │            │
                                             └────────────┘
</code></pre>
<h4 id="deployment"><a class="header" href="#deployment">Deployment</a></h4>
<p>用來表達部署時欲達成的狀態，通常是最常接觸的工具。</p>
<p>狀態可能包括數量、版本等。</p>
<h4 id="selector"><a class="header" href="#selector">Selector</a></h4>
<p>用來指定特定 Pod 的條件，例如：有高運算需求的就會要求有 <code>machine:physical</code> 這個 Label 的 Pod。</p>
<h4 id="label"><a class="header" href="#label">Label</a></h4>
<p>用來幫 Node 和 Pod 貼標籤，以 Node.js 為例：</p>
<ul>
<li><code>platform:node</code></li>
<li><code>playform-version:v14</code></li>
<li><code>machine:physical</code></li>
<li><code>kernel:3.16</code></li>
<li><code>app:web-api</code> <code>app:recipe-api</code></li>
</ul>
<blockquote>
<p>Label 不必唯一，你可以重複設定一樣的 key，如：<code>platform:node</code>、<code>platform:alpine</code></p>
</blockquote>
<pre><code>                              ┌─┬─────────┐
                              │L│ Defined │
                              │a│  Pod B  │
                              │b│         │
                              │e│         │
                              │l│         │
                              │ │         │
         ┌──────────┐         │B│         │
kubectl─►│Deployment│         └─┴─────────┘
         └─────┬────┘
               │              ┌─┬─────────┐
               │              │L│ Defined │
               │ Selector     │a│  Pod A  │
               └───────────►  │b│         │
                              │e│         │
                              │l│         │
                              │ │         │
                              │A│         │
                              └─┴─────────┘
</code></pre>
<h4 id="scheduler"><a class="header" href="#scheduler">Scheduler</a></h4>
<p>Kubernetes 會測試現有環境（如 CPU/Memory）是否適合添加 Pod。若無，則等待。</p>
<p>預設做 Scheduling 的工具為 <em>kube-scheduler</em>。</p>
<h4 id="controller"><a class="header" href="#controller">Controller</a></h4>
<p>用來控制 Kubernetes 各種狀態的控制器，通常開發者不會直接接觸。</p>
<h4 id="replicaset"><a class="header" href="#replicaset">ReplicaSet</a></h4>
<p>除了 ReplicaSet 外，根據需求還有其他種類的群組，如：</p>
<ul>
<li>StatefulSet 是可以提供狀態儲存的群組。</li>
</ul>
<blockquote>
<p>Stateful 的應用程式在這幾次報告都不會討論，因為對於需要儲存狀態的應用程式，其建構、部署的策略是另一項領域。</p>
</blockquote>
<h4 id="probe"><a class="header" href="#probe">Probe</a></h4>
<p>用來做 Health Check。</p>
<pre><code>                                             ┌────────────┐
                                             │ ReplicaSet │
                                             │            │
                                             │ ┌───────┐  │
┌─┬─────────┐                                │ │Pod A-1│  │
│L│ Defined │                                │ └───────┘  │
│a│  Pod A  │                                │            │
│b│         │Scheduler   ┌─────┐Controller   │ ┌───────┐  │
│e│         ├───────────►│Ready├───────────► │ │Pod A-2│  │
│l│         │Pending     └─────┘Creating     │ └───────┘  │
│ │         │                                │            │
│A│         │                Probe           │ ┌───────┐  │
└─┴─────────┘               ─────────────────┼─►Pod A-N│  │
                             Health Checking │ └───────┘  │
                                             │            │
                                             └────────────┘
</code></pre>
<ul>
<li>Ingress</li>
<li>Service</li>
</ul>
<pre><code>                │ Request
┌───────────────▼──────────────┐
│            Ingress           │
├──────┬───────────────────────┤
│      │                       │
│ ┌────▼───┐    ┌────────────┐ │
│ │        ├────►  Service   │ │
│ │ Master │    ┌────────────┤ │
│ │        │    │ Node       │ │
│ └────────┘    │            │ │
│               │   Pod1     │ │
│               │   Pod2     │ │
│               │   ...      │ │
│               └────────────┘ │
│                              │
└──────────────────────────────┘
</code></pre>
<h4 id="service"><a class="header" href="#service">Service</a></h4>
<p>如同 Docker 會決定哪一個 Container 有對外的 port 一樣，Service 也會利用 Selector 決定哪一個 Pod 是可以對外的。
類似於 reverse-proxy 般，決定外部哪些請求可以送進 Pod 裏面。</p>
<blockquote>
<p>在前幾次報告中常常提到 service，其代表的意義是服務或應用程式，有別於此處提到的 Service</p>
</blockquote>
<h4 id="ingress"><a class="header" href="#ingress">Ingress</a></h4>
<p>管理 Cluster 外部的請求。</p>
<h3 id="alternatives"><a class="header" href="#alternatives">Alternatives</a></h3>
<p>由上述可知，Kubernetes 擁有非常豐富的功能，並且可以透過多種方式達成同一個目的（例如 dev/stg 的環境分割）。這裡也並未完全涵蓋 Kubernetes 的概念（例如以 <a href="https://etcd.io">etcd</a> 做儲存的演算法）</p>
<blockquote>
<p><em>Apache Mesos</em> 和 <em>Apache Marathon</em> 的組合能達到類似 Kubernetes 的功能。
<em>Docker Swarm</em> 是 <em>Docker</em> 原生的容器化調度工具，但 <em>Docker</em> 已經捨棄並改採和 Kubernetes 的兼容了。</p>
</blockquote>
<h2 id="minikube"><a class="header" href="#minikube">minikube</a></h2>
<p>為了簡化實作上需要做的設定，本次實作會透過 <em>minikube</em> 來操作。<em>minikube</em> 是一個簡化版的 Kubernetes，他減少很多功能的設定，讓使用者可以快速開始實作，並且把 Master/Node 融合再一起。</p>
<ul>
<li>確認 kubectl 的安裝：<code>kubectl version --client</code></li>
</ul>
<blockquote>
<p><code>brew install kubernetes-cli</code></p>
</blockquote>
<ul>
<li>確認 minikube 的安裝：<code>minikube version</code></li>
</ul>
<blockquote>
<p><code>brew install minikube</code></p>
</blockquote>
<h3 id="kubectl"><a class="header" href="#kubectl">kubectl</a></h3>
<ul>
<li>啟動</li>
</ul>
<pre><code class="language-bash=">$ minikube start
😄  minikube v1.20.0 on Darwin 11.4
🎉  minikube 1.22.0 is available! Download it: https://github.com/kubernetes/minikube/releases/tag/v1.22.0
✨  Using the hyperkit driver based on existing profile
💡  To disable this notice, run: 'minikube config set WantUpdateNotification false'

👍  Starting control plane node minikube in cluster minikube
🔄  Restarting existing hyperkit VM for &quot;minikube&quot; ...
🐳  Preparing Kubernetes v1.20.2 on Docker 20.10.6 ...
🔎  Verifying Kubernetes components...
    ▪ Using image k8s.gcr.io/ingress-nginx/controller:v0.44.0
    ▪ Using image kubernetesui/dashboard:v2.1.0
    ▪ Using image docker.io/jettech/kube-webhook-certgen:v1.5.1
    ▪ Using image kubernetesui/metrics-scraper:v1.0.4
    ▪ Using image gcr.io/k8s-minikube/storage-provisioner:v5
    ▪ Using image docker.io/jettech/kube-webhook-certgen:v1.5.1
🔎  Verifying ingress addon...
🌟  Enabled addons: storage-provisioner, default-storageclass, ingress, dashboard
🏄  Done! kubectl is now configured to use &quot;minikube&quot; cluster and &quot;default&quot; namespace by default
</code></pre>
<ul>
<li>查看現有 Pods</li>
</ul>
<pre><code class="language-bash=">$ kubectl get pods
No resources found in default namespace.
</code></pre>
<p>因為預設使用 <code>default</code> namespace</p>
<ul>
<li>查看所有 namespace</li>
</ul>
<pre><code class="language-bash=">$ kubectl get namespace
NAME                   STATUS   AGE
default                Active   48d
ingress-nginx          Active   48d
kube-node-lease        Active   48d
kube-public            Active   48d
kube-system            Active   48d
kubernetes-dashboard   Active   48d
</code></pre>
<ul>
<li>查看系統的 Pods</li>
</ul>
<pre><code class="language-bash=">$ kubectl get pods --namespace=kube-system
NAME                               READY   STATUS    RESTARTS   AGE
coredns-74ff55c5b-sq5jt            1/1     Running   1          48d
etcd-minikube                      1/1     Running   1          48d
kube-apiserver-minikube            1/1     Running   1          48d
kube-controller-manager-minikube   1/1     Running   1          48d
kube-proxy-vslx5                   1/1     Running   1          48d
kube-scheduler-minikube            1/1     Running   1          48d
storage-provisioner                1/1     Running   2          48d
</code></pre>
<ul>
<li>查看 Node</li>
</ul>
<pre><code class="language-bash=">$ kubectl get nodes
NAME       STATUS   ROLES                  AGE   VERSION
minikube   Ready    control-plane,master   48d   v1.20.2
</code></pre>
<ul>
<li>使用 minikube 的 Docker</li>
</ul>
<pre class="mermaid">graph TD

  1[Docker] --&gt; 0[Container]
  00[Container]
  2[Local 端的 Daemon] --&gt; 1
  3[Docker CLI] -..-&gt; 2
  4[Kubernetes 端的 Daemon] --&gt; 12[Docker]
  12 --&gt; 00
  3 --&gt; 4

</pre>
<ol>
<li>先查看現有 Docker process list：<code>docker ps</code></li>
<li>再套用 minikube 的 Docker daemon <code>eval $(minikube -p minikube docker-env)</code></li>
</ol>
<pre><code class="language-bash=">$ minikube -p minikube docker-env
export DOCKER_TLS_VERIFY=&quot;1&quot;
export DOCKER_HOST=&quot;tcp://192.168.64.2:2376&quot;
export DOCKER_CERT_PATH=&quot;/Users/evan.lu/.minikube/certs&quot;
export MINIKUBE_ACTIVE_DOCKERD=&quot;minikube&quot;

# To point your shell to minikube's docker-daemon, run:
# eval $(minikube -p minikube docker-env)
</code></pre>
<ol start="3">
<li>再一次呼叫 <code>docker ps</code></li>
</ol>
<pre><code class="language-bash=">$ docker ps
CONTAINER ID   IMAGE                  COMMAND                  CREATED          STATUS          PORTS                                                                      NAMES
c3a17f71f9f9   435df390f367           &quot;/usr/bin/dumb-init …&quot;   35 minutes ago   Up 35 minutes                                                                              k8s_controller_ingress-nginx-controller-5d88495688-ljjlx_ingress-nginx_44335178-30e5-4dc5-a481-7980627f281d_1
825f8d008c8f   86262685d9ab           &quot;/metrics-sidecar&quot;       35 minutes ago   Up 35 minutes                                                                              k8s_dashboard-metrics-scraper_dashboard-metrics-scraper-f6647bd8c-zbbkd_kubernetes-dashboard_13929488-084b-407c-9339-1b6b7b7feb2d_1
8258d336d0d1   6e38f40d628d           &quot;/storage-provisioner&quot;   35 minutes ago   Up 35 minutes                                                                              k8s_storage-provisioner_storage-provisioner_kube-system_182b3e9c-2cd2-429f-aa0f-3103f916f32a_2
9edd75250040   9a07b5b4bfac           &quot;/dashboard --insecu…&quot;   35 minutes ago   Up 35 minutes                                                                              k8s_kubernetes-dashboard_kubernetes-dashboard-968bcb79-4l99k_kubernetes-dashboard_5cfcc5ce-7fb2-4304-baa1-6bf491e71469_1
c53e01b79ee7   k8s.gcr.io/pause:3.2   &quot;/pause&quot;                 35 minutes ago   Up 35 minutes   0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp, :::443-&gt;443/tcp   k8s_POD_ingress-nginx-controller-5d88495688-ljjlx_ingress-nginx_44335178-30e5-4dc5-a481-7980627f281d_1
72d0bf46751a   k8s.gcr.io/pause:3.2   &quot;/pause&quot;                 35 minutes ago   Up 35 minutes                                                                              k8s_POD_storage-provisioner_kube-system_182b3e9c-2cd2-429f-aa0f-3103f916f32a_1
b5ef7f9450a2   43154ddb57a8           &quot;/usr/local/bin/kube…&quot;   35 minutes ago   Up 35 minutes                                                                              k8s_kube-proxy_kube-proxy-vslx5_kube-system_e9319a11-d048-41ed-8cb1-92a0a17d67b5_1
0cb200215df8   bfe3a36ebd25           &quot;/coredns -conf /etc…&quot;   35 minutes ago   Up 35 minutes                                                                              k8s_coredns_coredns-74ff55c5b-sq5jt_kube-system_8f238e64-e20d-4899-8a46-96d783fa8250_1
7ffd1a33f25c   k8s.gcr.io/pause:3.2   &quot;/pause&quot;                 35 minutes ago   Up 35 minutes                                                                              k8s_POD_dashboard-metrics-scraper-f6647bd8c-zbbkd_kubernetes-dashboard_13929488-084b-407c-9339-1b6b7b7feb2d_1
b589a1d27625   k8s.gcr.io/pause:3.2   &quot;/pause&quot;                 35 minutes ago   Up 35 minutes                                                                              k8s_POD_kubernetes-dashboard-968bcb79-4l99k_kubernetes-dashboard_5cfcc5ce-7fb2-4304-baa1-6bf491e71469_1
809d46696a2e   k8s.gcr.io/pause:3.2   &quot;/pause&quot;                 35 minutes ago   Up 35 minutes                                                                              k8s_POD_kube-proxy-vslx5_kube-system_e9319a11-d048-41ed-8cb1-92a0a17d67b5_1
a6e5be9a3bb9   k8s.gcr.io/pause:3.2   &quot;/pause&quot;                 35 minutes ago   Up 35 minutes                                                                              k8s_POD_coredns-74ff55c5b-sq5jt_kube-system_8f238e64-e20d-4899-8a46-96d783fa8250_1
41d81fb8bbd9   0369cf4303ff           &quot;etcd --advertise-cl…&quot;   35 minutes ago   Up 35 minutes                                                                              k8s_etcd_etcd-minikube_kube-system_cf26ec9554c6f440822285b6ff9668f3_1
c7a6eca2d3f9   ed2c44fbdd78           &quot;kube-scheduler --au…&quot;   35 minutes ago   Up 35 minutes                                                                              k8s_kube-scheduler_kube-scheduler-minikube_kube-system_6b4a0ee8b3d15a1c2e47c15d32e6eb0d_1
3e9a5a9df7da   a27166429d98           &quot;kube-controller-man…&quot;   35 minutes ago   Up 35 minutes                                                                              k8s_kube-controller-manager_kube-controller-manager-minikube_kube-system_474c55dfb64741cc485e46b6bb9f2dc0_1
dcbf747b8975   a8c2fdb8bf76           &quot;kube-apiserver --ad…&quot;   35 minutes ago   Up 35 minutes                                                                              k8s_kube-apiserver_kube-apiserver-minikube_kube-system_0a7845e36bfd593e2ff9a027038089d3_1
ac54b241757d   k8s.gcr.io/pause:3.2   &quot;/pause&quot;                 35 minutes ago   Up 35 minutes                                                                              k8s_POD_kube-scheduler-minikube_kube-system_6b4a0ee8b3d15a1c2e47c15d32e6eb0d_1
6a91f7f8e57c   k8s.gcr.io/pause:3.2   &quot;/pause&quot;                 35 minutes ago   Up 35 minutes                                                                              k8s_POD_kube-controller-manager-minikube_kube-system_474c55dfb64741cc485e46b6bb9f2dc0_1
495996cf491c   k8s.gcr.io/pause:3.2   &quot;/pause&quot;                 35 minutes ago   Up 35 minutes                                                                              k8s_POD_kube-apiserver-minikube_kube-system_0a7845e36bfd593e2ff9a027038089d3_1
6ea9c36a7ff8   k8s.gcr.io/pause:3.2   &quot;/pause&quot;                 35 minutes ago   Up 35 minutes                                                                              k8s_POD_etcd-minikube_kube-system_cf26ec9554c6f440822285b6ff9668f3_1
</code></pre>
<h3 id="dashboard"><a class="header" href="#dashboard">Dashboard</a></h3>
<p>有一個 UI 介面會讓你對 Kubernetes 更了解</p>
<pre><code class="language-bash=">$ minikube dashboard
🤔  Verifying dashboard health ...
🚀  Launching proxy ...
🤔  Verifying proxy health ...
🎉  Opening http://127.0.0.1:56616/api/v1/namespaces/kubernetes-dashboard/services/http:kubernetes-dashboard:/proxy/ in your default browser...
</code></pre>
<blockquote>
<p>minikube 很適合用來做 local 端測試或教學，但是對於線上環境，仍建議直接安裝 Kubernetes。</p>
</blockquote>
<h2 id="部署應用程式"><a class="header" href="#部署應用程式">部署應用程式</a></h2>
<p>目標：</p>
<pre><code>     ┌────┐   ┌────┐   ┌─────────┐   ┌────┐  ┌────────────┐
     │    │   │    ├───► Web Pod ├───►    ├──► Recipe Pod │
     │    │   │    │   └─────────┘   │ R  │  └────────────┘
     │    │   │    │                 │ e  │
     │    │   │ W  │                 │ c  │  ┌────────────┐
     │ I  │   │ e  │                 │ i  ├──► Recipe Pod │
R    │ n  │   │ b  │                 │ p  │  └────────────┘
e    │ g  │   │    │                 │ e  │
q    │ r  │   │ S  │   ┌─────────┐   │    │  ┌────────────┐
u────► e  ├───► e  ├───► Web Pod ├───► S  ├──► Recipe Pod │
e    │ s  │   │ r  │   └─────────┘   │ e  │  └────────────┘
s    │ s  │   │ v  │                 │ r  │
t    │    │   │ i  │                 │ v  │  ┌────────────┐
     │    │   │ c  │                 │ i  ├──► Recipe Pod │
     │    │   │ e  │                 │ c  │  └────────────┘
     │    │   │    │                 │ e  │
     │    │   │    │   ┌─────────┐   │    │  ┌────────────┐
     │    │   │    ├───► Web Pod ├───►    ├──► Recipe Pod │
     └────┘   └────┘   └─────────┘   └────┘  └────────────┘
</code></pre>
<p>開始部署應用程式之前，先把應用程式用 image 包裝好。</p>
<h3 id="應用程式"><a class="header" href="#應用程式">應用程式</a></h3>
<p>必須使用 minikube 的 Docker 建置 image。</p>
<pre><code class="language-bash=">$ eval $(minikube -p minikube docker-env)
$ docker build . -t recipe-api:latest
</code></pre>
<h3 id="部署"><a class="header" href="#部署">部署</a></h3>
<p>分別部署應用程式和 Service</p>
<h4 id="應用程式-1"><a class="header" href="#應用程式-1">應用程式</a></h4>
<pre><code>     ******   ******   ┌─────────┐   ******  ┌─────────┐
     *    *   *    *───►   Web   ├───►    *──► Recipe  │
     *    *   *    *   └─────────┘   * R  *  └─────────┘
     *    *   *    *                 * e  *
     *    *   * W  *                 * c  *  ┌─────────┐
     * I  *   * e  *                 * i  *──► Recipe  │
R    * n  *   * b  *                 * p  *  └─────────┘
e    * g  *   *    *                 * e  *
q    * r  *   * S  *   ┌─────────┐   *    *  ┌─────────┐
u────* e  *───► e  *───►   Web   ├───► S  *──► Recipe  │
e    * s  *   * r  *   └─────────┘   * e  *  └─────────┘
s    * s  *   * v  *                 * r  *
t    *    *   * i  *                 * v  *  ┌─────────┐
     *    *   * c  *                 * i  *──► Recipe  │
     *    *   * e  *                 * c  *  └─────────┘
     *    *   *    *                 * e  *
     *    *   *    *   ┌─────────┐   *    *  ┌─────────┐
     *    *   *    *───►   Web   ├───►    *──► Recipe  │
     ******   ******   └─────────┘   ******  └─────────┘
</code></pre>
<p>使用設定檔來部署應用程式。</p>
<blockquote>
<p>這裡不細講設定檔各行意義，僅概述。
<a href="https://github.com/evan361425/distributed-node/blob/master/minikube/web-deployment.yml">web-deployment</a>、<a href="https://github.com/evan361425/distributed-node/blob/master/minikube/recipe-deployment.yml">recipe-deployment</a></p>
</blockquote>
<ul>
<li>定義 Pod 和 Label</li>
<li>透過 Selector 決定 scaling 要使用哪一些 Pod</li>
<li>要求達到的狀態。以此設定檔為例：長到 3/5 個 Pods</li>
<li>Container 設定。版本、port 和 health-check</li>
</ul>
<p>套用至 minikube：</p>
<pre><code class="language-bash=">$ kubectl apply -f minikube/recipe-deployment.yml
</code></pre>
<p>這時可以看看是否都啟動成功</p>
<pre><code class="language-bash=">$ kubectl get deployment
NAME         READY   UP-TO-DATE   AVAILABLE   AGE
recipe-api   5/5     5            5           19h
web-api      3/3     3            3           18h
</code></pre>
<h4 id="service-1"><a class="header" href="#service-1">Service</a></h4>
<pre><code>     ┌────┐   ┌────┐   ***********   ┌────┐  ***********
     │    │   │    ├───►   Web   *───►    ├──► Recipe  *
     │    │   │    │   ***********   │ R  │  ***********
     │    │   │    │                 │ e  │
     │    │   │ W  │                 │ c  │  ***********
     │ I  │   │ e  │                 │ i  ├──► Recipe  *
R    │ n  │   │ b  │                 │ p  │  ***********
e    │ g  │   │    │                 │ e  │
q    │ r  │   │ S  │   ***********   │    │  ***********
u────► e  ├───► e  ├───►   Web   *───► S  ├──► Recipe  *
e    │ s  │   │ r  │   ***********   │ e  │  ***********
s    │ s  │   │ v  │                 │ r  │
t    │    │   │ i  │                 │ v  │  ***********
     │    │   │ c  │                 │ i  ├──► Recipe  *
     │    │   │ e  │                 │ c  │  ***********
     │    │   │    │                 │ e  │
     │    │   │    │   ***********   │    │  ***********
     │    │   │    ├───►   Web   *───►    ├──► Recipe  *
     └────┘   └────┘   ***********   └────┘  ***********
</code></pre>
<p>使用設定檔來部署 Service。</p>
<blockquote>
<p>在 web-service 中一同設定 Ingress。
<a href="https://github.com/evan361425/distributed-node/blob/master/minikube/web-service.yml">web-service</a>、<a href="https://github.com/evan361425/distributed-node/blob/master/minikube/recipe-service.yml">recipe-service</a></p>
</blockquote>
<ul>
<li>定義應用程式對外的 port（Node 外、Cluster 內）</li>
<li>設定 Ingress 導引條件，放如 <code>host1</code> 引到 <code>Service A</code> 或 <code>/api/v1</code> 引到 <code>Service B</code></li>
</ul>
<p>套用至 minikube：</p>
<pre><code class="language-bash=">$ kubectl apply -f minikube/recipe-service.yml
</code></pre>
<h3 id="測試"><a class="header" href="#測試">測試</a></h3>
<p>取得 Cluster Ingress address</p>
<pre><code class="language-bash=">$ kubectl get ingress
</code></pre>
<pre><code>NAME              CLASS    HOSTS         ADDRESS        PORTS   AGE
web-api-ingress   &lt;none&gt;   example.org   192.168.64.2   80      96s
</code></pre>
<pre><code class="language-bash=">$ curl -H &quot;Host: example.org&quot; http://192.168.64.2
</code></pre>
<h2 id="核心價值"><a class="header" href="#核心價值">核心價值</a></h2>
<p>上述範例可以透過 docker-compose 達成，但是 Kubernetes 不僅如此。</p>
<h3 id="版本"><a class="header" href="#版本">版本</a></h3>
<p>當有新版本的應用程式需要部署時，Kubernetes 會先把新版本的 Pod 啟起來，等舊版本的 Pod 處理完請求時，取代之。</p>
<p>先把設定檔 <code>web-deployment.yml</code> 對 Container 的版本調整至 <code>v2</code>，再套用新的設定檔到 minikube。</p>
<blockquote>
<p><code>--record=true</code> 可以記錄本次指令到 revision，幫助未來退版確認版本</p>
</blockquote>
<pre><code class="language-bash=">$ kubectl apply -f minikube/web-deployment.yml --record=true
</code></pre>
<blockquote>
<p>Kubernetes 足夠聰明去判斷你改動了哪裡，然後作出調整。</p>
</blockquote>
<p>現在來看看部署的過程吧。</p>
<blockquote>
<p><code>-w</code> 可以用來監控狀況，<code>-l</code> 篩選特定 label 的 Pod</p>
</blockquote>
<pre><code class="language-bash=">$ kubectl get pods -w -l app=web-api
NAME                       READY   STATUS              RESTARTS   AGE
web-api-769dc9c8b7-5824q   1/1     Running             0          19h
web-api-769dc9c8b7-6x9bc   1/1     Terminating         0          19h
web-api-769dc9c8b7-hk2dp   1/1     Running             0          19h
web-api-d85b66d56-pkrv5    1/1     Running             0          3s
web-api-d85b66d56-bgw55    1/1     Running             0          2s
web-api-769dc9c8b7-hk2dp   1/1     Terminating         0          19h
web-api-d85b66d56-6qsp4    0/1     Pending             0          0s
web-api-d85b66d56-6qsp4    0/1     ContainerCreating   0          0s
web-api-d85b66d56-6qsp4    1/1     Running             0          2s
web-api-769dc9c8b7-5824q   1/1     Terminating         0          19h
</code></pre>
<p>時相圖說明實際運作的狀況：</p>
<pre><code>┌────┐      ┌────┐ ┌────┐      ┌────┐ ┌────┐      ┌────┐
│v1-a│      │v1-a│ │v2-a│      │v1-a│ │v2-a│      │v2-a│
└────┘      └────┘ └────┘      └────┘ └────┘      └────┘

┌────┐      ┌────┐ ┌────┐      ┌────┐ ┌────┐      ┌────┐
│v1-b│ ───► │v1-b│ │v2-b│ ───► │v1-c│ │v2-b│ ───► │v2-b│
└────┘      └────┘ └────┘      └────┘ └────┘      └────┘
                             Terminating
┌────┐      ┌────┐ Container          ┌────┐      ┌────┐
│v1-c│      │v1-c│ Creating           │v2-c│      │v2-c│
└────┘      └────┘                    └────┘      └────┘
Running     Running                   Running     Running
</code></pre>
<p>你也可以看看有過哪些資源。</p>
<pre><code class="language-bash=">$ kubectl get rs -l app=web-api
NAME                 DESIRED   CURRENT   READY   AGE
web-api-769dc9c8b7   0         0         0       20h
web-api-d85b66d56    3         3         3       6m34s
</code></pre>
<p>退版時，先確認版本號碼：</p>
<pre><code class="language-bash=">$ kubectl rollout history deployment.v1.apps/web-api
REVISION  CHANGE-CAUSE
1         &lt;none&gt;
2         kubectl apply --filename=web-api-deployment.yml --record=true
</code></pre>
<p>退版：</p>
<pre><code class="language-bash=">$ kubectl rollout undo deployment.v1.apps/web-api \
  --to-revision=1
</code></pre>
<h3 id="scaling"><a class="header" href="#scaling">Scaling</a></h3>
<p>手動增長到十個</p>
<pre><code class="language-bash=">$ kubectl scale deployment.apps/recipe-api --replicas=10
deployment.apps/recipe-api scaled
$ kubectl get deployment
NAME         READY   UP-TO-DATE   AVAILABLE   AGE
recipe-api   5/10    10           5           1m
web-api      3/3     3            3           1m
</code></pre>
<blockquote>
<p>除了透過指令增減 Pod 數量，也可以改動 Deployment 檔，再引入。</p>
</blockquote>
<p>在 scaling 的過程中，Kubernetes 會確定可以被引用才引用，移除時亦同。</p>
<blockquote>
<p>這裡的 scaling 是動態調整的，而 docker-compose 是當初設定的數量後做啟動，並非 scaling。</p>
</blockquote>
<p>除了手動增長減少，Kubernetes 也可以自動化：</p>
<ul>
<li><a href="https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/">Horizontal Autoscaler</a> 透過 CPU 或其他系統資源去增減 Pod。</li>
<li>Cron Job 透過排程去增減 Pod。</li>
</ul>
<blockquote>
<p>Kubernetes 還有很多功能，我自己也才剛開始摸索，希望未來有人能深入瞭解並和大家分享！</p>
</blockquote>
<h2 id="misc"><a class="header" href="#misc">Misc.</a></h2>
<ul>
<li>Live migration</li>
<li>Retry strategy</li>
<li>Chaos resiliency</li>
<li>Data atomicity</li>
<li>Dependency security</li>
<li>Dependency upgrade</li>
</ul>
<blockquote>
<p>上述這些在本書中都有討論到，個人覺得也很有趣，有興趣的人都可以看看。</p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../../feedback/distributed-systems-with-node.js/container.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../../essay/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../../feedback/distributed-systems-with-node.js/container.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../../essay/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/8.12.1/mermaid.min.js"></script>
                <script type="text/javascript" src="../../pagetoc.js"></script>
                <script type="text/javascript" src="../../mermaid-init.js"></script>
        
        
    </body>
</html>
