<!DOCTYPE HTML>
<html lang="zh" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Observability - 呂學洲</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="各種紀錄和連結">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../../favicon.svg">
                        <link rel="shortcut icon" href="../../favicon.png">
                <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
                <link rel="stylesheet" href="../../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
                <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "rust" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../../introduction.html"><strong aria-hidden="true">1.</strong> 自我介紹</a></li><li class="chapter-item expanded "><a href="../../projects/index.html"><strong aria-hidden="true">2.</strong> 開源專案</a></li><li class="chapter-item expanded "><a href="../../feedback/index.html"><strong aria-hidden="true">3.</strong> 讀書心得（照字母排序）</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../feedback/designing-data-intensive-applications/introduction.html"><strong aria-hidden="true">3.1.</strong> Designing Data-intensive Applications</a></li><li class="chapter-item expanded "><a href="../../feedback/distributed-systems-with-node.js/introduction.html"><strong aria-hidden="true">3.2.</strong> Distributed Systems with Node.js</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../feedback/distributed-systems-with-node.js/protocol.html"><strong aria-hidden="true">3.2.1.</strong> Protocol</a></li><li class="chapter-item expanded "><a href="../../feedback/distributed-systems-with-node.js/sla-and-load-testing.html"><strong aria-hidden="true">3.2.2.</strong> SLA and Load Testing</a></li><li class="chapter-item expanded "><a href="../../feedback/distributed-systems-with-node.js/observability.html" class="active"><strong aria-hidden="true">3.2.3.</strong> Observability</a></li><li class="chapter-item expanded "><a href="../../feedback/distributed-systems-with-node.js/container.html"><strong aria-hidden="true">3.2.4.</strong> Container</a></li><li class="chapter-item expanded "><a href="../../feedback/distributed-systems-with-node.js/container-orchestration-and-misc.html"><strong aria-hidden="true">3.2.5.</strong> Container Orchestration and Misc.</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../essay/index.html"><strong aria-hidden="true">4.</strong> 隨筆</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../essay/made-container.html"><strong aria-hidden="true">4.1.</strong> 如何製作 Docker Container</a></li><li class="chapter-item expanded "><a href="../../essay/node.js-best-practice.html"><strong aria-hidden="true">4.2.</strong> Node.js 最佳實作</a></li><li class="chapter-item expanded "><a href="../../essay/node.js-error.html"><strong aria-hidden="true">4.3.</strong> Node.js 的錯誤有哪些</a></li><li class="chapter-item expanded "><a href="../../essay/pki-checklist.html"><strong aria-hidden="true">4.4.</strong> 建置 PKI 注意事項</a></li><li class="chapter-item expanded "><a href="../../essay/questionnaire-principal.html"><strong aria-hidden="true">4.5.</strong> 問卷設計指南</a></li><li class="chapter-item expanded "><a href="../../essay/retry-strategy.html"><strong aria-hidden="true">4.6.</strong> Retry 的策略</a></li><li class="chapter-item expanded "><a href="../../essay/url-structure.html"><strong aria-hidden="true">4.7.</strong> URL 長什麼樣子</a></li><li class="chapter-item expanded "><a href="../../essay/vault/index.html"><strong aria-hidden="true">4.8.</strong> Vault</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../essay/vault/introduction.html"><strong aria-hidden="true">4.8.1.</strong> 介紹</a></li><li class="chapter-item expanded "><a href="../../essay/vault/implementation.html"><strong aria-hidden="true">4.8.2.</strong> 實作</a></li><li class="chapter-item expanded "><a href="../../essay/vault/engine-pki.html"><strong aria-hidden="true">4.8.3.</strong> PKI</a></li><li class="chapter-item expanded "><a href="../../essay/vault/engine-transit.html"><strong aria-hidden="true">4.8.4.</strong> Transit</a></li></ol></li><li class="chapter-item expanded "><a href="../../essay/web-security/index.html"><strong aria-hidden="true">4.9.</strong> 網路安全</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../essay/web-security/cross-origin-resources-sharing.html"><strong aria-hidden="true">4.9.1.</strong> CORS</a></li><li class="chapter-item expanded "><a href="../../essay/web-security/mixed-content.html"><strong aria-hidden="true">4.9.2.</strong> Mixed Content</a></li><li class="chapter-item expanded "><a href="../../essay/web-security/owasp-api-top10.html"><strong aria-hidden="true">4.9.3.</strong> OWASP API Top 10</a></li><li class="chapter-item expanded "><a href="../../essay/web-security/owasp-authentication-best-practice.html"><strong aria-hidden="true">4.9.4.</strong> OWASP 驗證機制最佳指南</a></li><li class="chapter-item expanded "><a href="../../essay/web-security/owasp-mobile-risk-top10.html"><strong aria-hidden="true">4.9.5.</strong> OWASP 行動裝置風險</a></li></ol></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">呂學洲</h1>

                    <div class="right-buttons">
                                                <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/evan361425/evan361425.github.io" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="說明"><a class="header" href="#說明">說明</a></h2>
<p>應用程式是需要維運的，分散式系統的維運和傳統上有什麼差異呢？</p>
<p>本章會依序介紹 Log、Tracing、Metric、Alert 和 Health Check。</p>
<h3 id="log"><a class="header" href="#log">Log</a></h3>
<p>在本地端測試時，時常用 <code>console.log</code> 或 <code>print</code> 這類函示來確認請求在執行過程中沒有發生什麼意料之外的事。</p>
<p>若在線上部署後，我要怎麼從遠在他方的 server 中取得相關訊息？</p>
<p>下面會介紹 <a href="https://www.elastic.co/what-is/elk-stack">ELK</a>（<code>Elasticsearch</code>, <code>Logstash</code>, and <code>Kibana</code>）怎麼讓你拿到 server 的 log 資訊。</p>
<h3 id="tracing"><a class="header" href="#tracing">Tracing</a></h3>
<p>若一個請求歷程會經過多項服務，我要怎麼區分不同的請求？</p>
<blockquote>
<p>例如：發現 A 服務在和 B 服務請求資料時，得到錯誤資料。
於是接著查看 B 服務的 log，然而同一時間卻有很多請求，茫茫大海如何尋？</p>
</blockquote>
<p>此時就可以使用 Tracing 的機制，範例中會使用 <a href="https://zipkin.io">Zipkin</a>。</p>
<pre><code>┌────┐ Request┌───────┐ Request┌──────────┐
│user├────────►web-api├────────►recipe-api│
└────┘        └───────┘        └──────────┘
</code></pre>
<blockquote>
<p><code>request ID</code> 代表各個請求的 ID，必須是不能重複的字串。</p>
</blockquote>
<h3 id="metric"><a class="header" href="#metric">Metric</a></h3>
<p>除了針對單一請求的流程檢閱，若我要做統計呢？</p>
<blockquote>
<p>例如：機器的 CPU 使用率、回應 4xx/5xx 的比率、API 使用分佈</p>
</blockquote>
<p>這一類需要累積的資料，我們便稱其為 Metric，範例中會使用 <a href="https://graphiteapp.org">Graphite</a>，<a href="https://github.com/statsd/statsd">StatsD</a> 和 <a href="https://grafana.com">Grafana</a>。</p>
<h3 id="alert"><a class="header" href="#alert">Alert</a></h3>
<p>有了 Metric，我們便可以設定些閥值，來通知開發人員以及早得知服務的狀態。</p>
<blockquote>
<p>例如 5xx 比率超過 3% 時，提出警告通知</p>
</blockquote>
<p>範例中會使用 <a href="https://grafana.com">Grafana</a>。</p>
<h3 id="health-check"><a class="header" href="#health-check">Health Check</a></h3>
<p>若服務的依賴（例如 DB）連線斷掉或甚至服務本身斷線時，我們能否及早知道？同時自動重新建立連線，或甚至重新啟動該服務。</p>
<p>範例中會使用 <a href="http://www.haproxy.org">HAProxy</a></p>
<h3 id="比較"><a class="header" href="#比較">比較</a></h3>
<table><thead><tr><th>種類</th><th>多服務才有意義</th><th>功能</th><th>所屬（概略）</th></tr></thead><tbody>
<tr><td>Log</td><td>X</td><td>Debug</td><td>Dev</td></tr>
<tr><td>Tracing</td><td>O</td><td>Debug</td><td>Dev-Ops</td></tr>
<tr><td>Metric</td><td>X</td><td>統計</td><td>Ops</td></tr>
<tr><td>Alert</td><td>X</td><td>分析</td><td>Dev-Ops SE</td></tr>
</tbody></table>
<h2 id="實作"><a class="header" href="#實作">實作</a></h2>
<p>接下來進入一系列實作。</p>
<h3 id="log-1"><a class="header" href="#log-1">Log</a></h3>
<p><code>ELK</code> 是 <a href="https://www.elastic.co">Elastic</a> 開發的開源產品，其開發的不僅僅是 <code>ELK</code> 這三項產品。</p>
<p>本範例僅會討論 <code>ELK</code> 代表的 Elasticsearch、Logstash、Kibana 這三個，其中各產品定位和功能如下。</p>
<h4 id="elasticsearch"><a class="header" href="#elasticsearch">Elasticsearch</a></h4>
<p>一種資料庫，並對外提供 API，會高效的搜尋相關資訊。並且有其標準的 query 語法。</p>
<blockquote>
<p>Elasticsearch is fast. Really, really fast.</p>
</blockquote>
<blockquote>
<p>Elasticsearch 擁有很多功能，本次僅會示範幾種，若需要更多資訊，<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/index.html">詳見</a>。</p>
</blockquote>
<h4 id="logstash"><a class="header" href="#logstash">Logstash</a></h4>
<p>Elasticsearch 是一種資料庫，但是儲存的資料需要有人給他，這便是 Logstash 的功能。負責把收到的資料整合送給 Elasticsearch。</p>
<blockquote>
<p>送什麼資料是由應用程式方決定的，可以是 log file、HTTP 等。
本範例是透過 HTTP on UDP 來傳送。</p>
</blockquote>
<h4 id="kibana"><a class="header" href="#kibana">Kibana</a></h4>
<p>Elasticsearch 是一種資料庫，但是並未提供 UI 介面，這時 Kibana 就是把 API 轉成可讓人透過網頁的方式來操作。</p>
<h4 id="架構圖"><a class="header" href="#架構圖">架構圖</a></h4>
<pre><code>                ┌────────────────────────────┐
                │            ELK             │
┌─────────┐     │ ┌────────┐                 │
│ Browser ├─────┼─► Kibana │ ┌─────────────┐ │
└─────────┘     │ └────────┘ │Elasticsearch│ │
                │            └─────────────┘ │
┌─────────┐ UDP │ ┌──────────┐               │
│   APP   ├─────┼─► Logstash │               │
└─────────┘     │ └──────────┘               │
                └────────────────────────────┘
</code></pre>
<h4 id="範例程式碼"><a class="header" href="#範例程式碼">範例程式碼</a></h4>
<p><a href="https://github.com/evan361425/distributed-node/blob/master/src/web-api/consumer-http-logs.ts">web-api</a></p>
<p>對使用來說，不需要去考慮傳送到 Logstash 的邏輯</p>
<pre><code class="language-javascript=">logger.info(
  {
    path: req.url,
    method: req.method,
    ip: req.ip,
    ua: req.headers['user-agent'] || null,
  },
  'request-incoming',
);
</code></pre>
<blockquote>
<p>無論用什麼格式撰寫 log，統一就好。</p>
</blockquote>
<p>初始化 logger</p>
<pre><code class="language-javascript=">const client = dgram.createSocket('udp4');
const stream = {
  write: (msg: string) =&gt; {
    client.send(msg, LS_PORT, LS_HOST);
  },
};
const logger = pino({ level: 'trace' }, stream);
</code></pre>
<h4 id="alternative"><a class="header" href="#alternative">Alternative</a></h4>
<ul>
<li><a href="https://datadoghq.com">Datadog</a></li>
<li><a href="https://sumologic.com">Sumo Logic</a></li>
<li><a href="https://splunk.com">Splunk</a></li>
<li>Cloud (AWS, GCP, ELK)</li>
</ul>
<h3 id="metrics"><a class="header" href="#metrics">Metrics</a></h3>
<p>其架構會和 Log 很像，Elasticsearch 也包含這類的 query 語法。
其重點差異便是在 log 處理對象為單一請求，而 metrics 處理的是服務在累積流量或時間後的狀態，如<a href="#metric">上</a>所述。</p>
<p>範例中會使用的是 <code>Grafana</code>、<code>Graphite</code> 和 <code>StatsD</code>。</p>
<h4 id="架構"><a class="header" href="#架構">架構</a></h4>
<pre><code>                ┌──────────────────────────┐
                │        Metrics           │
┌─────────┐     │ ┌─────────┐              │
│ Browser ├─────┼─► Grafana │ ┌──────────┐ │
└─────────┘     │ └─────────┘ │ Graphite │ │
                │             └──────────┘ │
┌─────────┐ UDP │ ┌────────┐               │
│ Service ├─────┼─► StatDs │               │
└─────────┘     │ └────────┘               │
                └──────────────────────────┘
graph LR
  0[Browser]
  1[Service]
  subgraph Metrics
    2[Grafana]
    3[Graphite]
    4[StatsD]
  end
  0 --&gt; 2
  2 --&gt; 3
  3 --&gt; 2

  1 -- UDP --&gt;4
  4 --&gt; 3
</code></pre>
<blockquote>
<p>和 log 非常相似，這裡就不贅述其意義。</p>
</blockquote>
<h4 id="程式碼"><a class="header" href="#程式碼">程式碼</a></h4>
<p><a href="https://github.com/evan361425/distributed-node/blob/master/src/web-api/consumer-http-metrics.ts">web-api</a></p>
<p>初始化 client</p>
<pre><code class="language-javascript=">const client = new StatsDClient({
  host: 'localhost',
  port: 8125,
  prefix: 'web-api',
});
</code></pre>
<p>統計請求時間和次數</p>
<pre><code class="language-javascript=">const begin = new Date();

await got(`http://${TARGET}/recipes/42`);

client.timing('outbound.recipe-api.request-time', begin);
client.increment('outbound.recipe-api.request-count');
</code></pre>
<p>統計系統資源</p>
<pre><code class="language-javascript=">setInterval(() =&gt; {
  client.gauge('server.conn', server.connections);

  const m = process.memoryUsage();
  client.gauge('server.memory.used', m.heapUsed);
  client.gauge('server.memory.total', m.heapTotal);

  const h = v8.getHeapStatistics();
  client.gauge('server.heap.size', h.used_heap_size);
  client.gauge('server.heap.limit', h.heap_size_limit);

  // try to mock memory heap
  fs.readdir(__dirname, (err, list) =&gt; {
    if (err) return;
    client.gauge('server.descriptors', list.length);
  });
}, 10_000);
</code></pre>
<blockquote>
<p>範例中，把記憶體等相關資訊放在應用程式中。
實際上，為了避免應用程式斷線，導致收集不到服務的資訊，這類的資料收集應在服務外使用。</p>
</blockquote>
<h4 id="alternative-1"><a class="header" href="#alternative-1">Alternative</a></h4>
<ul>
<li><code>Graphite</code> -&gt; Prometheus, InfluxDB</li>
<li><code>StatsD</code> -&gt; cAdvisor, MetricBeat</li>
</ul>
<h3 id="tracing-1"><a class="header" href="#tracing-1">Tracing</a></h3>
<p>在分散式系統中，多個服務間的溝通或請求都可能在過程中得到非預期的結果，為了能快速找到問題點，需要辨別同一支請求在各個服務中的位置。</p>
<blockquote>
<p>透過建立 request ID 來辨別同一支請求在多個服務中的位置。</p>
</blockquote>
<h4 id="架構-1"><a class="header" href="#架構-1">架構</a></h4>
<pre><code>               ┌────────────────┐
               │       APP      │
┌────────┐     │  ┌─────────┐   │ info ┌────────────┐
│ Client ├─────┼──► web-api ├───┼─────►│            │
└────────┘     │  └──▲────┬─┘   │      │            │
           Response  │    │Request ID  │   Zipkin   │
               │ ┌───┴────▼───┐ │      │            │
               │ │ recipe-api ├─┼──────┤            │
               │ └────────────┘ │ info └────────────┘
               └────────────────┘
</code></pre>
<p>產出範例：</p>
<pre><code class="language-mermaid">gantt
dateFormat m:s
axisFormat %S
todayMarker off
title Request 1

task1 :des1, 10:1, 5s

fetch :des2, 10:7, 10s
recipe :des4, 10:8, 8s

task2 :des3, 10:18, 3s
</code></pre>
<blockquote>
<p>web-api 會傳送 <code>task1</code>、<code>fetch</code> 和 <code>task2</code>
recipe-api 會傳送 <code>recipe</code></p>
</blockquote>
<h4 id="程式碼-1"><a class="header" href="#程式碼-1">程式碼</a></h4>
<p><a href="https://github.com/evan361425/distributed-node/blob/master/src/web-api/consumer-http-zipkin.ts">web-api</a></p>
<pre><code class="language-javascript=">const tracer = new Tracer({
  ctxImpl,
  recorder,
  localServiceName: 'web-api',
  sampler: new sampler.CountingSampler(1),
});
</code></pre>
<p>紀錄請求開始時和結束時</p>
<pre><code class="language-javascript=">app.use(expressMiddleware({ tracer }));
</code></pre>
<p>紀錄需要執行 100ms 的任務</p>
<pre><code class="language-javascript=">await tracer.local&lt;Promise&lt;void&gt;&gt;(
  'do_some_task',
  () =&gt; new Promise((resolve) =&gt; setTimeout(resolve, 100)),
);
</code></pre>
<p>使用包裝後的 <code>got</code> 來去請求，在使用時不需要考慮其 tracing 邏輯。</p>
<pre><code class="language-javascript=">await instance(`http://${TARGET}/recipes/42`).json();
</code></pre>
<pre><code class="language-javascript=">const instance = got.extend({
  hooks: {
    init: [
      (opts) =&gt; opts._zipkin.parentId = tracer.id,
    ],
    beforeRequest: [
      (opts) =&gt; {
        // ...
      },
    ],
    afterResponse: [
      (res) =&gt; {
        // ...
      },
    ],
    beforeError: [
      (err) =&gt; {
        // ...
        return err;
      },
    ],
  },
});
</code></pre>
<p><a href="https://github.com/evan361425/distributed-node/blob/master/src/recipe-api/producer-http-zipkin.ts">recipe-api</a></p>
<p><img src="https://i.imgur.com/hAfYQhP.png" alt="" /></p>
<h3 id="alert-1"><a class="header" href="#alert-1">Alert</a></h3>
<p>Demo in production</p>
<h3 id="health-check-1"><a class="header" href="#health-check-1">Health Check</a></h3>
<p>這大部分會和 Alert 一起實作，目的是持續打特定 route 去得知服務現有狀況。</p>
<p>但現有狀況會有些模糊地帶，例如：</p>
<p>有產品使用 cache 去達到 SLA。當 cache 失去運作，對應用程式來說仍能運行。但整體效率會降低，進而提高 Latency，這時服務的狀態算是健康還是不健康？</p>
<blockquote>
<p>這種模糊地帶被稱作 <code>degraded</code>，至於該怎麼處理，就和商務邏輯的實作有關了。</p>
</blockquote>
<h4 id="範例"><a class="header" href="#範例">範例</a></h4>
<blockquote>
<p>範例中，會用 r-proxy 做 health check 且應用程式綁在一起。
但實作上，仍建議讓應用程式外的產品或甚至外單位的產品去做 health check。
例如：<a href="https://pagerduty.com">PagerDuty</a>、<a href="https://nagios.org">Nagios</a>、<a href="https://pingdom.com/">Pingdom</a>。
除了 r-proxy，專做 health check 的開源軟體有：<a href="https://cabotapp.com/">Cabot</a>。</p>
</blockquote>
<p>HAProxy 的設定黨</p>
<pre><code># ...

backend web-api
  option httpchk GET /health
  server web-api-1 localhost:3001 check
  server web-api-2 localhost:3002 check
</code></pre>
<p><a href="https://github.com/evan361425/distributed-node/blob/master/src/web-api/consumer-http-healthcheck.ts">web-api</a></p>
<pre><code class="language-javascript=">app.get('/health', (_req, res) =&gt; {
  return res.send('OK');
});
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../../feedback/distributed-systems-with-node.js/sla-and-load-testing.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../../feedback/distributed-systems-with-node.js/container.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../../feedback/distributed-systems-with-node.js/sla-and-load-testing.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../../feedback/distributed-systems-with-node.js/container.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
                <script type="text/javascript" src="../../mermaid.min.js"></script>
                <script type="text/javascript" src="../../mermaid-init.js"></script>
        
        
    </body>
</html>
