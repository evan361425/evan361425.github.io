<!DOCTYPE HTML>
<html lang="zh-TW" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Read Intensive DB - 呂學洲</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="各種紀錄和連結">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../../favicon.svg">
                        <link rel="shortcut icon" href="../../favicon.png">
                <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
                <link rel="stylesheet" href="../../style.css">
                <link rel="stylesheet" href="../../pagetoc.css">
        
                <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
                 <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-P67FD9XP83"></script>
        <script>
            if (["localhost", "127.0.0.1", ""].indexOf(document.location.hostname) === -1) {
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());
                gtag('config', 'G-P67FD9XP83');
            }
        </script>
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "rust" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../introduction.html">自我介紹</a></li><li class="chapter-item "><a href="../../projects/index.html">開源專案</a></li><li class="chapter-item expanded "><a href="../../feedback/index.html">讀書心得（照字母排序）</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../feedback/designing-data-intensive-applications/introduction.html">撰寫中 - Designing Data-intensive Applications</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../feedback/designing-data-intensive-applications/data-model.html">Data Model</a></li><li class="chapter-item "><a href="../../feedback/designing-data-intensive-applications/db-index.html">DB Index</a></li><li class="chapter-item "><a href="../../feedback/designing-data-intensive-applications/encoding-evolution.html">Encoding and Schema Evolution</a></li><li class="chapter-item expanded "><a href="../../feedback/designing-data-intensive-applications/read-intensive-db.html" class="active">Read Intensive DB</a></li></ol></li><li class="chapter-item "><a href="../../feedback/distributed-systems-with-node.js/introduction.html">Distributed Systems with Node.js</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../feedback/distributed-systems-with-node.js/protocol.html">Protocol</a></li><li class="chapter-item "><a href="../../feedback/distributed-systems-with-node.js/sla-and-load-testing.html">SLA and Load Testing</a></li><li class="chapter-item "><a href="../../feedback/distributed-systems-with-node.js/observability.html">Observability</a></li><li class="chapter-item "><a href="../../feedback/distributed-systems-with-node.js/container.html">Container</a></li><li class="chapter-item "><a href="../../feedback/distributed-systems-with-node.js/container-orchestration-and-misc.html">Container Orchestration and Misc.</a></li></ol></li></ol></li><li class="chapter-item "><a href="../../essay/index.html">隨筆</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../essay/made-container.html">如何製作 Docker Container</a></li><li class="chapter-item "><a href="../../essay/node.js-best-practice.html">Node.js 最佳實作</a></li><li class="chapter-item "><a href="../../essay/node.js-error.html">Node.js 的錯誤有哪些</a></li><li class="chapter-item "><a href="../../essay/pki-checklist.html">建置 PKI 注意事項</a></li><li class="chapter-item "><a href="../../essay/questionnaire-principal.html">問卷設計指南</a></li><li class="chapter-item "><a href="../../essay/retry-strategy.html">Retry 的策略</a></li><li class="chapter-item "><a href="../../essay/replace-docker-desktop.html">取代 Docker Desktop</a></li><li class="chapter-item "><a href="../../essay/url-structure.html">URL 長什麼樣子</a></li><li class="chapter-item "><a href="../../essay/vault/index.html">Vault</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../essay/vault/introduction.html">介紹</a></li><li class="chapter-item "><a href="../../essay/vault/implementation.html">實作</a></li><li class="chapter-item "><a href="../../essay/vault/engine-pki.html">PKI</a></li><li class="chapter-item "><a href="../../essay/vault/engine-transit.html">Transit</a></li></ol></li><li class="chapter-item "><a href="../../essay/web-security/index.html">網路安全</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../essay/web-security/cross-origin-resources-sharing.html">CORS</a></li><li class="chapter-item "><a href="../../essay/web-security/mixed-content.html">Mixed Content</a></li><li class="chapter-item "><a href="../../essay/web-security/owasp-api-top10.html">OWASP API Top 10</a></li><li class="chapter-item "><a href="../../essay/web-security/owasp-authentication-best-practice.html">OWASP 驗證機制最佳指南</a></li><li class="chapter-item "><a href="../../essay/web-security/owasp-mobile-risk-top10.html">OWASP 行動裝置風險</a></li></ol></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">呂學洲</h1>

                    <div class="right-buttons">
                                                                        <a href="https://github.com/evan361425/evan361425.github.io" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                                        <a href="https://github.com/evan361425/evan361425.github.io/edit/master/src/feedback/designing-data-intensive-applications/read-intensive-db.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <nav class="pagetoc"></nav>

                    <main>
                        <h2 id="什麼是-oltpolap-和-dw"><a class="header" href="#什麼是-oltpolap-和-dw">什麼是 OLTP、OLAP 和 DW</a></h2>
<p>一般來說，資料庫對於服務使用者來說，即是在一群資料中找出特定資料，做讀寫的動作。這種操作，稱為<em>線上交易處理</em>（online transaction processing，OLTP）。</p>
<blockquote>
<p>早期資料庫的操作幾乎是商務交易，所以保留舊稱「交易」（transaction）。</p>
</blockquote>
<p>然而，隨著資料的增加，開始需要對資料庫做一些分析。幫助服務管理者去做一些特定的決策，例如：</p>
<ul>
<li>購物者在一天中購買的時間分佈</li>
<li>哪個商品賣最好</li>
</ul>
<p>這一類的行為，常常需要針對所有的資料做讀取，而不需要寫入。我們稱之為<em>線上分析處理</em>（online analytic processing，OLAP）。</p>
<p>針對這種和 OLTP 的操作有很大差異的資料，而去做設計的資料庫，我們稱之為資料儲倉（Data Warehouse，DW）。</p>
<p>有時候並不是那麼清楚就可以區分 OLTP 和 OLAP，但是仍有一些主要的差異：</p>
<table><thead><tr><th>屬性</th><th>OLTP</th><th>OLAP</th></tr></thead><tbody>
<tr><td>主要的讀取模式</td><td>小量資料，且透過 key 篩選</td><td>聚合（aggregate）大量資料</td></tr>
<tr><td>主要的寫入模式</td><td>低潛時（latency ），且隨機寫入</td><td>一次性大量寫入，或透過事件流入</td></tr>
<tr><td>主要使用於</td><td>透過網路溝通的服務使用者</td><td>內部分析師，幫助決策</td></tr>
<tr><td>資料代表什麼</td><td>最新狀態</td><td>事件的歷史紀錄</td></tr>
<tr><td>資料庫大小</td><td>GB~TB</td><td>TB~PB</td></tr>
</tbody></table>
<h3 id="比較"><a class="header" href="#比較">比較</a></h3>
<p>OLTP 類型資料庫通常是服務使用者直接接觸的。這代表大量的請求會被需要處理，為了處理這類需求，請求通常只會接觸資料庫中一部份資料。應用程式可能會透過索引（index）來加速搜尋。這類的資料庫通常注重從磁碟中找尋的速度（<a href="https://en.wikipedia.org/wiki/Hard_disk_drive_performance_characteristics#seek-time">seek time</a>，找尋特定資料位置的速度）。</p>
<p>OLAP 類型資料庫較少被知道，因為這類型資料庫是用來做分析，而非讓服務使用者直接存取。雖然請求量比 OLTP 低，但是每次請求可能都需要遍歷資料庫來取得特定分析結果。這類的資料庫通常注重從磁碟中的頻寬（<a href="http://matthewrocklin.com/blog/work/2015/12/29/disk-bandwidth">bandwidth</a>，讀取大量資料的速度）。</p>
<h2 id="data-warehouse"><a class="header" href="#data-warehouse">Data Warehouse</a></h2>
<p>對於公司來說可能會有很多資料庫去滿足各個單位的需求。這些資料庫很可能彼此是各自獨立的，但卻都是在替同一群使用者。例如：人力銀行的</p>
<ul>
<li>求職者履歷資料庫</li>
<li>求職者的性向測驗</li>
</ul>
<p>除此之外，這些資料庫為了滿足 OLTP 低潛時性，當你要下指令去搜集全域的資訊時，你很可能會被 DBA 拒絕。為了同時滿足線上使用者高效率的運作和分析師的數據爬取，這時資料儲倉（Data Warehouse，DW）便出現了。</p>
<p>其特性會把所有不同服務的資料，定時（periodic data dump）或持續（continuous stream of updates）從資料庫中擷取資料。並存入適合分析的綱目（schema），做一些重複資料的清理等等。這一系列的行為稱作萃取、變換及載入（Extract–Transform–Load，ETL）。</p>
<p><img src="https://i.imgur.com/dBdom2a.png" alt="" /></p>
<p>我們之前學到的索引（index）演算法，並不適合這類分析性的行為。所以雖然大部分 DW 都是關連式資料庫，其內部運算邏輯卻和常見的 OLTP 關連式資料庫不同。目前也越來越多資料庫針對不同場域做特定的優化，也就是很少會看到一個資料庫同時滿足 OLTP 和 OLAP。</p>
<h3 id="一些-dw-資料庫"><a class="header" href="#一些-dw-資料庫">一些 DW 資料庫</a></h3>
<ul>
<li>收費的
<ul>
<li><a href="https://www.teradata.com">Teradata</a></li>
<li><a href="https://www.vertica.com">Vertica</a></li>
<li>SAP <a href="https://www.sap.com/taiwan/products/hana.html">HANA</a></li>
<li><a href="https://www.actian.com">ParAccel</a></li>
<li>Amazon <a href="https://aws.amazon.com/tw/redshift">Redshift</a> based on <a href="https://www.actian.com">ParAccel</a> and PostgreSQL</li>
</ul>
</li>
<li>開源的 SQL-on-Hadoop 專案
<ul>
<li>Google's <a href="https://research.google/pubs/pub36632">Dremel</a> paper</li>
<li>Apache <a href="https://github.com/apache/hive">Hive</a></li>
<li>Apache <a href="https://github.com/apache/spark">Spark</a></li>
<li>Cloudera <a href="https://github.com/apache/impala">Impala</a></li>
<li>Facebook <a href="https://github.com/prestodb/presto">Presto</a></li>
<li>Apache <a href="https://github.com/apache/drill">Drill</a></li>
</ul>
</li>
</ul>
<h3 id="綱目"><a class="header" href="#綱目">綱目</a></h3>
<p>DW 可能的綱目（schema）設計有兩種：</p>
<ul>
<li>星狀綱目（star schema）
<ul>
<li>DW 的資料和其他資料庫的資量關系，樣子就好像星星發出來的光一樣</li>
</ul>
</li>
<li>雪花綱目（snowflake schema）
<ul>
<li>資料和資料的關係層層交疊</li>
</ul>
</li>
</ul>
<h4 id="星狀綱目"><a class="header" href="#星狀綱目">星狀綱目</a></h4>
<p>以書中範例做介紹：</p>
<p><img src="https://i.imgur.com/DhsZMwJ.png" alt="" /></p>
<p>在細看這些資料代表的意義之前，先注意到表（table）的前綴詞有兩種：</p>
<ul>
<li><code>dim</code> 對資料提供維度（dimension）的表</li>
<li><code>fact</code> 展示所有狀態的表，事實表</li>
</ul>
<p>以上述圖片為例子，產品、商店、顧客、日期、推廣活動等等就是提高事實表維度的資料庫。而 <code>fact_sales</code> 就是銷售相關的事實表，或者說該表紀錄了所有銷售相關的行為（事件）。</p>
<p>儘管有些是對照其他表的外區鍵（foreign key），但仍有很多欄位是相關行為（事件）的屬性，例如：該「顧客」於該「商店」購買該「產品」的數量、原價、售價等等。由此可知，若提供細節信息，該表格將會有非常多的欄位，或者說屬性（property），甚至可能到數百種屬性。</p>
<h4 id="雪花綱目"><a class="header" href="#雪花綱目">雪花綱目</a></h4>
<p>類似於星狀綱目，只是他的維度表可能會有很多層，例如：「產品表」又會有外區鍵連到「品牌表」和「種類表」。</p>
<h4 id="比較-1"><a class="header" href="#比較-1">比較</a></h4>
<p>大部分資料庫選擇使用星狀綱目，因為其</p>
<ul>
<li>好擴充，例如：當有新的種類，就不用同時去改種類表和產品表</li>
<li>適合壓縮和優化搜尋速度（透過 Bitmap Index），後面會介紹</li>
<li>好調整，新增屬性時，不需要考慮放在哪個表比較適合</li>
<li>較好理解，不用層層堆砌，層層解析</li>
</ul>
<h2 id="列式資料庫"><a class="header" href="#列式資料庫">列式資料庫</a></h2>
<p>在一般 OLAP 中，只會讀取部分欄位，以上述表格為例：在假日購買特定種類的數量：</p>
<pre><code class="language-sql">SELECT
  dim_date.weekday, dim_product.category,
  SUM(fact_sales.quantity) AS quantity_sold
FROM fact_sales
  JOIN dim_date    ON fact_sales.date_key   = dim_date.date_key
  JOIN dim_product ON fact_sales.product_sk = dim_product.product_sk
WHERE
  dim_date.year = 2013 AND
  dim_product.category IN ('Fresh fruit', 'Candy')
GROUP BY
  dim_date.weekday, dim_product.category;
</code></pre>
<p>由此例可知，在該特性下，若每次操作僅拿取部分資料做運算，是否有必要做功讓其他欄位的資料一起從磁碟（disk）中讀取出來？</p>
<blockquote>
<p>尤其是在資料量有好幾 PB，而每一行可能有好幾百個屬性時，這類「小缺點」將會被放大。</p>
</blockquote>
<p>列式資料庫（column-oriented storage）的概念就是由此而生，我不以每列為單位做儲存，而是改為每欄為單位。這樣在讀取時，就只需要讀取少部分的資料。</p>
<blockquote>
<p>並非只有關連式資料庫適合做列式資料庫，僅僅因為關連式資料庫在講解上是最好理解的。<a href="https://github.com/apache/parquet-mr">Parquet</a> 就是一個以 Google's <a href="https://research.google/pubs/pub36632">Dremel</a> paper 為基礎的文件式資料庫。</p>
</blockquote>
<blockquote>
<p>這同時也代表，每一欄位都需要擁有相同順序和數量的行位，而這條件在 OLAP 是符合的，因為其不會刪除任一行資料。</p>
</blockquote>
<h3 id="壓縮"><a class="header" href="#壓縮">壓縮</a></h3>
<p>好的資料壓縮，可以降低在讀取海量資料的時間，而 OLAP 還有個特性，就是欄位可能的值是有限的。例如：產品數量可能只有數萬或數十萬個，但是購物操作卻可能每年有好幾億筆。</p>
<p>因此，以操作為欄，產品編號為列，可得下表：</p>
<table><thead><tr><th>產品編號</th><th>操作 1</th><th>操作 2</th><th>操作 3</th><th>...</th></tr></thead><tbody>
<tr><td>1</td><td>1</td><td>0</td><td>1</td><td>...</td></tr>
<tr><td>2</td><td>0</td><td>1</td><td>0</td><td>...</td></tr>
<tr><td>3</td><td>0</td><td>0</td><td>0</td><td>...</td></tr>
<tr><td>...</td><td>-</td><td>-</td><td>-</td><td>...</td></tr>
</tbody></table>
<p>其意義代表：</p>
<ul>
<li><code>操作 1</code> 購買 <code>產品 1</code></li>
<li><code>操作 2</code> 購買 <code>產品 2</code></li>
<li><code>操作 3</code> 購買 <code>產品 1</code></li>
<li>...</li>
</ul>
<p>此時並不能壓縮資料，事實上，他只是把各操作的各產品編號，展開成二進位而已。也就是，位元映射（<em>bitmap encoding</em>）。然而，因為 OLAP 的特性讓每列有多個為 0 的欄位，此時就可以透過執行長度編碼（<em>run-length encoded</em>）進行壓縮。</p>
<p><img src="https://i.imgur.com/B7RbDBw.png" alt="" /></p>
<p>而展開成二進位的格式，不止利於壓縮，在計算時，也可以單純透過 OR AND 去做計算。例如：</p>
<pre><code class="language-sql">WHERE product_sk IN (30, 68, 69)
</code></pre>
<p>我們讀取產品的位元映射表中的第 <code>30</code>，<code>68</code> 和 <code>69</code> 行，然後拿出三段位元向量（bit vector）做位元間的 OR 運算。</p>
<pre><code class="language-sql">WHERE product_sk = 31 AND store_sk = 3
</code></pre>
<p>我們讀取位產品的元映射表中的第 <code>31</code> 行，然後讀取商店的元映射表中的第 <code>3</code> 行做位元間的 AND 運算。</p>
<blockquote>
<p>這類操作之所以可以運作，就是因為我們在儲存欄位時，同步所有列的數量和順序。</p>
</blockquote>
<p>若需要查看更多壓縮的演算法，可以查看 <a href="http://www.cs.umd.edu/%7Eabadi/papers/abadi-column-stores.pdf">The Design and Implementation of Modern Column-Oriented Database Systems. Ct4-2</a>。</p>
<blockquote>
<p><a href="https://en.wikipedia.org/wiki/Column_family"><em>Column Family</em></a> 和 <em>Column Oriented</em> 是不同的概念，其被應用於基於 <a href="http://research.google.com/archive/bigtable.html">Bigtable</a> 架構的資料庫 <a href="https://github.com/apache/cassandra">Cassandra</a> 和 <a href="https://github.com/apache/hbase">HBase</a> 中。其原理是把部分列（column）從行（row）中拉出整合成一個單位，類似於關連式資料庫的表（table），並且不會對這單位進行列壓縮（<em>column compression</em>），因此該模型仍主要是以行式資料庫（row-oriented）為主。</p>
</blockquote>
<h3 id="硬體面優化"><a class="header" href="#硬體面優化">硬體面優化</a></h3>
<p>當進行運算和分析時，系統必須從硬體磁碟（disk）中讀取資料並存進記憶體（memory）中。除了這一段的頻寬需要考量外，還需要考量記憶體進入 CPU 快取中的頻寬。在執行這些行為的訊號時，盡可能避免快取層級的誤判和整合進單一 CPU 運行的大小（page size），並使用現代 CPU 中的 SIMD（single-instruction-multi-data） 指令。</p>
<table><thead><tr><th>指令</th><th>1/1,000,000,000 秒 = 1 奈秒</th></tr></thead><tbody>
<tr><td>讀取第一層快取</td><td>0.5 ns</td></tr>
<tr><td>快取層級誤判</td><td>5 ns</td></tr>
<tr><td>讀取第二層快取</td><td>7 ns</td></tr>
<tr><td>互斥鎖的加鎖和解鎖</td><td>25 ns</td></tr>
<tr><td>讀取主記憶體</td><td>100 ns</td></tr>
<tr><td>在 1Gbps 的網路送出 2KB 的資料</td><td>20,000 ns</td></tr>
<tr><td>從主記憶體中讀取 1MB 的連續資料</td><td>250,000 ns</td></tr>
<tr><td>取得磁碟中的新位置（需要搜尋）</td><td>8,000,000 ns</td></tr>
<tr><td>從磁碟中讀取 1MB 的連續資料</td><td>20,000,000 ns</td></tr>
<tr><td>讓一個封包從美國到歐洲來回</td><td>150 ms = 150,000,000 ns</td></tr>
</tbody></table>
<blockquote>
<p>參考：https://hackmd.io/ysFkocN0RreKgzJk_7B-0g?view</p>
</blockquote>
<p>除了盡可能減少拉取的資料，每次拉取時也須有效的配合 CPU 的週期。例如，搜尋引擎會把壓縮後的列式資料分成好幾段（chunk），並持續且緊密地（也就是過程中不呼叫任何函示，避免 function call/jump）放進 CPU 第一層快取中。除此之外每一段（chunk）彼此間都可以直接使用電晶體去執行 AND 或 OR 等邏輯運算。</p>
<p>這一系列的技巧稱為向量處理（vectorized processing）。</p>
<h3 id="排序"><a class="header" href="#排序">排序</a></h3>
<p>把資料經過排序後再儲存除了加速搜尋也可以讓長度編碼（run-length encoded）更緊密。例如 <code>00001000100</code> 排序後變成 <code>1,2,0,9</code>。</p>
<p>可以透過之前提過的 <a href="db-index.html#sstables">SSTable</a> 來做排序，需要注意的是，雖然是把每列作為儲存單位，在排序時仍要讓該行的各列資料同時保持相同順序。</p>
<p>但是，排序的效果僅在做第一組資料排序最有效，例如：</p>
<p><img src="https://i.imgur.com/DhsZMwJ.png" alt="" /></p>
<p>若發現常常使用日期單位做搜尋，如每月的購買產品總數，則可以使用 <code>date_key</code>。但是對於以產品為底的搜尋，如購買該產品的會員年齡就沒有使用到排序的好處。這時就發展出新的小技巧。例如 <a href="https://www.vertica.com">Vertica</a> 的資料庫：</p>
<p>反正資料都要做備份（和 HA）複製到各機器，你就可以把各機器的資料做不同方式去儲存。例如資料庫 A 以日期作為 <code>sort key</code>，資料庫 B 以產品作為 <code>sort key</code>。</p>
<blockquote>
<p>可以想像其和行式資料庫的多索引的差異。行式資料庫在多索引中，常常會在索引中儲存檔案的來源，例如 <a href="db-index.html#index-%E6%8E%92%E5%BA%8F">heap file 等等</a>。而列式資料庫則直接儲存資料</p>
</blockquote>
<h3 id="暫存聚合"><a class="header" href="#暫存聚合">暫存聚合</a></h3>
<p>搜尋時，常常會用到聚合（aggregation）資料，例如總數（sum）、平均（avg）等等。而這類操作常常都需要遍歷資料庫，既然這些資料很耗時又需要常常用到，就暫存他吧。這類暫存後的聚合資料，稱為物化聚合（materialized aggregates），而展示這類資料的圖或表（table）稱為物化視圖（materialized view）。</p>
<blockquote>
<p>物化視圖和關連式資料庫常見的標準視圖（standard/virtual view）有所差異，標準視圖只是把查詢記錄整合在一起，當被使用時，仍然會執行其中一系列的查詢。</p>
</blockquote>
<p><img src="images/data-cube.png" alt="" /></p>
<p>圖中展示，二維資料在做物化整合時的方式。每一個單元（cell）儲存某一天的某一個產品銷售總額，行尾儲存某一天的所有產品銷售總額，列尾儲存某一產品的所有銷售總額。</p>
<p>當然，資料更可能被進行多維度的儲存，例如購物者的年齡等等。</p>
<h3 id="寫入"><a class="header" href="#寫入">寫入</a></h3>
<p>上述提到的壓縮、硬體優化、排序、暫存聚合都是在提高讀取效率，雖然這實際就是資料儲倉大部分的業務需求，但在從各個子資料庫中拉取資料時仍需要寫入。該怎麼做到有效的寫入呢？</p>
<p>可以透過先前提到的 <a href="db-index.html#sstables">LSM-Tree</a>，分成磁碟上的資料和記憶體中的資料，記憶體的資料方便做排序和插入。當記憶體達到一定大小後，寫入磁碟中。而磁碟中的資料定期做整合和壓縮。<a href="https://www.vertica.com">Vertica</a> 的資料庫便是依此方式。</p>
<blockquote>
<p>從這也可以看到 LSM-Tree 對於資料庫的演算法有很重大的影響。</p>
</blockquote>
<hr />

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../../feedback/designing-data-intensive-applications/encoding-evolution.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../../feedback/distributed-systems-with-node.js/introduction.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../../feedback/designing-data-intensive-applications/encoding-evolution.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../../feedback/distributed-systems-with-node.js/introduction.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
                <script type="text/javascript" src="../../pagetoc.js"></script>
                <script type="text/javascript" src="../../mermaid.min.js"></script>
                <script type="text/javascript" src="../../mermaid-init.js"></script>
        
        
    </body>
</html>
