<!DOCTYPE HTML>
<html lang="zh-TW" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Encoding and Schema Evolution - 呂學洲</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="各種紀錄和連結">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../../favicon.svg">
                        <link rel="shortcut icon" href="../../favicon.png">
                <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
                <link rel="stylesheet" href="../../style.css">
                <link rel="stylesheet" href="../../pagetoc.css">
        
                <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
                 <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-P67FD9XP83"></script>
        <script>
            if (["localhost", "127.0.0.1", ""].indexOf(document.location.hostname) === -1) {
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());
                gtag('config', 'G-P67FD9XP83');
            }
        </script>
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "rust" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../introduction.html">自我介紹</a></li><li class="chapter-item "><a href="../../projects/index.html">開源專案</a></li><li class="chapter-item expanded "><a href="../../feedback/index.html">讀書心得（照字母排序）</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../feedback/designing-data-intensive-applications/introduction.html">撰寫中 - Designing Data-intensive Applications</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../feedback/designing-data-intensive-applications/data-model.html">Data Model</a></li><li class="chapter-item "><a href="../../feedback/designing-data-intensive-applications/db-index.html">DB Index</a></li><li class="chapter-item expanded "><a href="../../feedback/designing-data-intensive-applications/encoding-evolution.html" class="active">Encoding and Schema Evolution</a></li><li class="chapter-item "><a href="../../feedback/designing-data-intensive-applications/read-intensive-db.html">Read Intensive DB</a></li></ol></li><li class="chapter-item "><a href="../../feedback/distributed-systems-with-node.js/introduction.html">Distributed Systems with Node.js</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../feedback/distributed-systems-with-node.js/protocol.html">Protocol</a></li><li class="chapter-item "><a href="../../feedback/distributed-systems-with-node.js/sla-and-load-testing.html">SLA and Load Testing</a></li><li class="chapter-item "><a href="../../feedback/distributed-systems-with-node.js/observability.html">Observability</a></li><li class="chapter-item "><a href="../../feedback/distributed-systems-with-node.js/container.html">Container</a></li><li class="chapter-item "><a href="../../feedback/distributed-systems-with-node.js/container-orchestration-and-misc.html">Container Orchestration and Misc.</a></li></ol></li></ol></li><li class="chapter-item "><a href="../../essay/index.html">隨筆</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../essay/made-container.html">如何製作 Docker Container</a></li><li class="chapter-item "><a href="../../essay/node.js-best-practice.html">Node.js 最佳實作</a></li><li class="chapter-item "><a href="../../essay/node.js-error.html">Node.js 的錯誤有哪些</a></li><li class="chapter-item "><a href="../../essay/pki-checklist.html">建置 PKI 注意事項</a></li><li class="chapter-item "><a href="../../essay/questionnaire-principal.html">問卷設計指南</a></li><li class="chapter-item "><a href="../../essay/retry-strategy.html">Retry 的策略</a></li><li class="chapter-item "><a href="../../essay/replace-docker-desktop.html">取代 Docker Desktop</a></li><li class="chapter-item "><a href="../../essay/url-structure.html">URL 長什麼樣子</a></li><li class="chapter-item "><a href="../../essay/vault/index.html">Vault</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../essay/vault/introduction.html">介紹</a></li><li class="chapter-item "><a href="../../essay/vault/implementation.html">實作</a></li><li class="chapter-item "><a href="../../essay/vault/engine-pki.html">PKI</a></li><li class="chapter-item "><a href="../../essay/vault/engine-transit.html">Transit</a></li></ol></li><li class="chapter-item "><a href="../../essay/web-security/index.html">網路安全</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../essay/web-security/cross-origin-resources-sharing.html">CORS</a></li><li class="chapter-item "><a href="../../essay/web-security/mixed-content.html">Mixed Content</a></li><li class="chapter-item "><a href="../../essay/web-security/owasp-api-top10.html">OWASP API Top 10</a></li><li class="chapter-item "><a href="../../essay/web-security/owasp-authentication-best-practice.html">OWASP 驗證機制最佳指南</a></li><li class="chapter-item "><a href="../../essay/web-security/owasp-mobile-risk-top10.html">OWASP 行動裝置風險</a></li></ol></li></ol></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">呂學洲</h1>

                    <div class="right-buttons">
                                                                        <a href="https://github.com/evan361425/evan361425.github.io" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                                        <a href="https://github.com/evan361425/evan361425.github.io/edit/master/src/feedback/designing-data-intensive-applications/encoding-evolution.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>
                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <nav class="pagetoc"></nav>

                    <main>
                        <p>資料在做儲存或輸出的時候是需要編碼（encoding）的，除了可以幫助壓縮資料量，好的編碼方式會在綱目（Schema）調整後，仍能做編（解）碼，也就是綱目演變（schema evolution）後，仍能保持前後相容。</p>
<p>當你把資料存進記憶體中，可以透過各種資料型別去對資料進行操作，例如陣列、物件等等。然而當把資料存進磁碟（filesystem）中或者透過網路傳送給其他服務時，就需要以編碼後的資料（例如 JSON 格式）來儲存或輸出。</p>
<h2 id="程式碼內建編碼方式"><a class="header" href="#程式碼內建編碼方式">程式碼內建編碼方式</a></h2>
<p>我們都會透過程式語言來和記憶體溝通，不同程式語言預設就有些編碼方式，Java：<code>java.io.Serializable</code>、Ruby：<code>Marshal</code>、Python：<code>pickle</code>，然而</p>
<ul>
<li>通常不同語言之間是無法互相接通的</li>
<li>可能會觸發物件的建置，有安全性疑慮</li>
<li>較少考慮前後相容</li>
<li>效率通常很差</li>
</ul>
<h2 id="方便人類閱讀的格式"><a class="header" href="#方便人類閱讀的格式">方便人類閱讀的格式</a></h2>
<p>JSON、XML、CSV，這些格式都很常見，不需要綱目就能解碼。然而</p>
<ul>
<li>無法儲存二進位文字，雖然可以使用 Base64 把二進位轉換成 Unicode 文字，缺需要額外的效能和體積
<ul>
<li>Base64 每 6 個 bit 轉成一個 ASCII 字元（1 個 byte），所以體積會比直接做二進位轉換大 1.3 倍</li>
</ul>
</li>
<li>沒有綱目，花時間理解和管理</li>
<li>大數字不好儲存，整數、小數的區分</li>
</ul>
<p>然而這些仍是主要的編碼方式，也因為大家很習慣這些方式的編碼，導致更有效和更方便管理的編碼方式很難吸引到大家的目光。</p>
<h3 id="二進位-json"><a class="header" href="#二進位-json">二進位 JSON</a></h3>
<p>有些格式是以 JSON 為基礎做演化的，其嘗試解決上述問題，但是效率仍無法贏過專門的二進位編碼，以下圖為範例：</p>
<p>原始 JSON 資料：</p>
<pre><code class="language-json">{
  &quot;userName&quot;: &quot;Martin&quot;,
  &quot;favoriteNumber&quot;: 1337,
  &quot;interests&quot;: [&quot;daydreaming&quot;, &quot;hacking&quot;]
}
</code></pre>
<p><img src="images/bjson-message-pack.png" alt="" /></p>
<p>我們可以得到 66 Bytes 的資料，確實比原本 88 Bytes 好，但是和待會我們可以看到減少到 32 Bytes 的方式仍有差異。</p>
<h2 id="二進位編碼"><a class="header" href="#二進位編碼">二進位編碼</a></h2>
<p>二進位編碼並不是新東西，早在 1984 年就有協定 <a href="https://www.oss.com/asn1/resources/books-whitepapers-pubs/larmouth-asn1-book.pdf">ASN.1</a> 闡述如何進行二進位編碼，他和 <a href="#thrift">Thrift</a>、<a href="#protocol-buffer">Protocol Buffer</a> 一樣都使用 tag ID。且其應用（DER）如今仍被大量使用於 X.509。</p>
<p>但是他卻有過於複雜且綱目（Schema）建置困難的缺點，由此發展出以下幾個較新的方式。</p>
<ul>
<li><a href="http://thrift.apache.org">Apache Thrift</a> - 初始於 Facebook</li>
<li><a href="https://developers.google.com/protocol-buffers">Protocol Buffer</a> - Google</li>
<li><a href="http://avro.apache.org">Apache Avro</a></li>
</ul>
<p>上述方式可以降低磁碟的使用量、高效能編（解）碼、有效製作文件檔，但缺點就是需要解碼才能讓人類讀懂訊息。</p>
<h3 id="前後相容"><a class="header" href="#前後相容">前後相容</a></h3>
<p>在做編碼時都需要去考慮前後相容：</p>
<ul>
<li>向後相容：舊的程式碼讀到的資料含有新的綱目定義的欄位時，仍然可以運行</li>
<li>向前相容：新的程式碼讀到的資料含有已經被刪除的欄位時，仍然可以運行</li>
</ul>
<p>由此可知，JSON 這類編碼方式新舊版本都可以做解碼，只要在程式邏輯上注意一下就可以保持前後相容。</p>
<p>除此之外還需要注意新的程式碼撰寫資料時，被同時存在的舊程式碼覆蓋掉：</p>
<p><img src="images/data-flow-db-compitable.png" alt="" /></p>
<blockquote>
<p>在資料準備要送到資料儲倉（warehouse）時，也需要編碼，這時候可以把資料轉換成友善於列式資料庫（column-oriented database）的格式，例如 <a href="https://parquet.apache.org">Parquet</a>。</p>
</blockquote>
<h3 id="thrift"><a class="header" href="#thrift">Thrift</a></h3>
<p>綱目：</p>
<pre><code>struct Person {
  1: required string       userName,
  2: optional i64          favoriteNumber,
  3: optional list&lt;string&gt; interests
}
</code></pre>
<h4 id="binaryprotocol"><a class="header" href="#binaryprotocol">BinaryProtocol</a></h4>
<p>59 Bytes</p>
<p><img src="images/bencode-thrift-binary-protocol.png" alt="" /></p>
<h4 id="compactprotocol"><a class="header" href="#compactprotocol">CompactProtocol</a></h4>
<p>34 Bytes</p>
<p><img src="images/bencode-thrift-compact-protocol.png" alt="" /></p>
<h3 id="protocol-buffer"><a class="header" href="#protocol-buffer">Protocol Buffer</a></h3>
<p>綱目：</p>
<pre><code>message Person {
  required string user_name       = 1;
  optional int64  favorite_number = 2;
  repeated string interests       = 3;
}
</code></pre>
<p>33 Bytes</p>
<p><img src="images/bencode-protocol-buffers.png" alt="" /></p>
<h3 id="註"><a class="header" href="#註">註</a></h3>
<ul>
<li><code>required</code> 和 <code>optional</code> 在編碼時，不影響結果，僅會在做解碼時 runtime 輸出錯誤。</li>
<li>每個 tag ID 不去更動來保持前後相容。當使用舊的綱目去讀取未知欄位時，省略之。</li>
<li>新增欄位時若設定 <code>required</code> 會讓舊程式碼輸出錯誤，需要給定預設值。</li>
<li>變更檔案格式可能導致資料不完全，例如 <code>int8</code> 轉到 <code>int16</code></li>
<li><em>ProtocolBuffers</em> 沒有 <code>list</code> 資料型態，讓他很好從 <code>repeated</code> 轉到 <code>optional</code>，但巢狀結構就會需要額外功來達成。</li>
</ul>
<h3 id="avro"><a class="header" href="#avro">Avro</a></h3>
<p>綱目：</p>
<pre><code class="language-IDL">record Person {
  string               userName;
  union { null, long } favoriteNumber = null;
  array&lt;string&gt;        interests;
}
</code></pre>
<p>這裡多了一個 union，到時候在 encoding 時需要設定以說明該值屬於哪種型別。</p>
<p>32 Bytes</p>
<p><img src="images/bencode-avro.png" alt="" /></p>
<h3 id="比較"><a class="header" href="#比較">比較</a></h3>
<p>Avro 並沒有使用 tag ID 來辨認每個資料的位置，而是透過綱目不同版本間的轉換：</p>
<p><img src="images/bencode-avro-schema-translator.png" alt="" /></p>
<blockquote>
<p>因此讀取資料時，需要先確保撰寫資料所使用的綱目版本。</p>
</blockquote>
<p>Avro 也利用 <code>union { null, int }</code> 來當作資料的 <em>required/optional</em>，同時給予預設值來滿足向後（前）相容。</p>
<p>除此之外，Avro 還允許更改資料的<strong>型別</strong>和<strong>名稱</strong>，但只能滿足向後相容：</p>
<ul>
<li>提供<strong>型別</strong>的轉換器</li>
<li>設定 <code>alias</code> 來滿足名稱的轉換</li>
</ul>
<h4 id="如何知道撰寫者的綱目版本"><a class="header" href="#如何知道撰寫者的綱目版本">如何知道撰寫者的綱目版本</a></h4>
<p>根據應用程式而有差異：</p>
<ul>
<li>若資料庫是在 Hadoop 架構之上，就可以在每份檔案前面添加綱目版本。</li>
<li>若資料庫的每筆資料都可能會有不同的版本，就需要在每筆資料前設定版本，如 <a href="https://dbdb.io/db/espresso">Espresso</a>。</li>
<li>若是在網路上進行雙向溝通的應用程式，可以協商出彼此的版本，如 <a href="https://avro.apache.org/docs/current/spec.html#Protocol+Declaration">Avro RPC</a></li>
</ul>
<h4 id="不需要使用-tag-id-有什麼好處"><a class="header" href="#不需要使用-tag-id-有什麼好處">不需要使用 tag ID 有什麼好處</a></h4>
<p>資料輸出成檔案時（Hadoop 架構下的資料庫常做的事），我可以很方便地從資料庫的綱目轉換成 Avro Schema，然後把檔案撰寫成二位元。同樣的，當資料庫的綱目更新時，已經輸出過的檔案就不再需要轉換，而是透過上述版本轉換機制。</p>
<p>相反的，用 Protocol Buffers 或 Thrift 就需要謹慎使用 tag ID 來避免任何衝突。</p>
<blockquote>
<p>Protocol Buffers、Thrift 並不是為了這類操作而設計的編碼格式</p>
</blockquote>
<h4 id="弱型別語言上的應用"><a class="header" href="#弱型別語言上的應用">弱型別語言上的應用</a></h4>
<p>Protocol Buffers、Thrift 在強型別的語言（Java、C++、Dart）上很好用，因爲可以透過綱目去產生編碼後的程式碼，並執行二位元編碼的解碼。但是在弱型別的語言（JavaScript、Python、Ruby、PHP）上就需要做額外的功，如 TypeScript。除此之外，動態產生的綱目，如透過資料庫的綱目產生 Avro Schema，對於弱型別的語言就更麻煩。</p>
<p>Avro 提供一些手段減少這類困擾，例如在 Hadoop 架構之上的檔案，都包含綱目，也就是讓這份檔案能夠自描述（self-describing）。你可以直接透過程式庫打開這份檔案，並且操作上如同 JSON 格式的資料。</p>
<p>分析工具 <a href="https://github.com/apache/pig">Apache Pig</a> 就是運用這特性，讓使用者直接透過 SQL 語法在 Hadoop 架構之上的資料庫進行分析，而不需要考慮任何綱目上的問題。</p>
<h2 id="複習差異"><a class="header" href="#複習差異">複習差異</a></h2>
<p>JSON（Schema-less 編碼）可以透過文件方式補足綱目，有其優點：</p>
<ul>
<li>在解碼時不會受綱目影響，可輕易允許向後（前）的相容。</li>
<li>綱目因為是文件形式，能詳細限制資料。如：數字只能在 0~1 之間。</li>
</ul>
<p>然而二進位編碼也有其好處：</p>
<ul>
<li>儲存更緊密，體積小。</li>
<li>因為綱目（Schema）是必須的，不會出現文件和實際運作有落差（忘記補文件）。</li>
<li>在 compile 過程就能檢查程式碼是否符合綱目。</li>
<li>透過一些機制仍能保持向前（後）的相容</li>
</ul>
<h2 id="編解碼的使用情境"><a class="header" href="#編解碼的使用情境">編（解）碼的使用情境</a></h2>
<ul>
<li>資料庫同一個服務編（解）碼。也就是：
<ul>
<li>資料庫編、解碼，或者</li>
<li>資料庫需求者編、解碼</li>
</ul>
</li>
<li>RPC/REST/SOAP APIs，兩個服務或使用者彼此編解碼。也就是：
<ul>
<li>請求者把請求資訊編碼</li>
<li>服務者解碼</li>
<li>服務者把回應編碼</li>
<li>請求者解碼</li>
</ul>
</li>
<li>RPC 的編碼使用
<ul>
<li>Protocol Buffers - Google <a href="https://github.com/grpc">gRPC</a>
<ul>
<li>之前有撰寫過<a href="../distributed-systems-with-node.js/protocol.html">心得</a></li>
</ul>
</li>
<li>Thrift - Twitter <a href="https://github.com/twitter/finagle">Finagle</a></li>
<li>JSON - LinkedIn <a href="http://github.com/linkedin/rest.li/">Rest.li</a></li>
<li>若對外，無法保證 client 使用最新版本的 Schema，所以較難維運。反之，RESTful API 可以利用：
<ul>
<li>前綴詞加上版本</li>
<li>HTTP 標頭（<em>Accept</em>）寫明使用版本</li>
<li>請求時需攜帶 Token</li>
</ul>
</li>
</ul>
</li>
<li>在發送者和接收者間非同步訊息傳遞（Asynchronous message passing）。也就是：
<ul>
<li>發送者編碼</li>
<li>接收者解碼</li>
</ul>
</li>
</ul>
<h3 id="非同步訊息傳遞"><a class="header" href="#非同步訊息傳遞">非同步訊息傳遞</a></h3>
<p>這塊較不熟悉，因此另外搜集資料。非同步訊息和同步訊息的差異在於</p>
<ul>
<li>同步訊息預期收到請求，例如 REST API。這代表當沒收到請求時，需要做錯誤處理（Error handling）</li>
<li>非同步訊息則相反，送出訊息後，在確認對方收到前（根據設定可能不需要確認）可能又再送出一則訊息</li>
</ul>
<p>非同步訊息傳遞書中主要介紹兩種方式：</p>
<ul>
<li>消息代理（Message brokers）</li>
</ul>
<p><img src="images/message-broker-explained.png" alt="message broker explained" /></p>
<p><a href="https://www.codeproject.com/Tips/1169118/Message-Broker-Pattern-using-Csharp">Referrer</a></p>
<ul>
<li>演員模型（Actor model）</li>
</ul>
<p>除此之外，另外可能還有：</p>
<ul>
<li>事件流式架構（Event streaming platforms）
<ul>
<li>僅提供多對一（pub/sub）的服務</li>
<li>較適合處理大量訊息</li>
</ul>
</li>
</ul>
<p><img src="../stream-processing-cep-event-sourcing-and-data-streaming-explained/images/event-stream-explained.png" alt="" /></p>
<p><a href="https://www.confluent.io/blog/making-sense-of-stream-processing/">Referrer</a></p>
<p>事件架構對於資料傳遞和整個組織的資料整合來說非常好用，未來會補個<a href="../index#%E8%AE%80%E5%AE%8C">說明</a></p>
<ul>
<li>企業服務匯流排（Enterprise service bus）
<ul>
<li>較大型的消息代理者，處理多對多的溝通，會負責把傳遞中的訊息格式統一。例如 XML 轉成 JSON</li>
<li><a href="https://www.ibm.com/cloud/learn/message-brokers#toc-message-br-oBdNX5GN">慢慢式微</a>，因為會越搞越複雜</li>
</ul>
</li>
</ul>
<p><img src="images/enterprise-service-bus-explained.png" alt="" /></p>
<p><a href="https://zh.wikipedia.org/wiki/%E4%BC%81%E4%B8%9A%E6%9C%8D%E5%8A%A1%E6%80%BB%E7%BA%BF">Referrer</a></p>
<h4 id="演員模型actor-model"><a class="header" href="#演員模型actor-model">演員模型（Actor model）</a></h4>
<p>演員模型是一種程式設計的哲學，其主旨是獨立每個運行的邏輯和其狀態，並把這獨立的單位稱為演員（Actor）。</p>
<p>例如現在有個演員會負責輸出「Hello World」，我們傳遞一個訊息給這個演員，告訴他我這裡有個變數 3，作出任何你應該要做的事情吧。
然後這個演員就會開始輸出「Hello World」三次。</p>
<p>以 Java 的套件 <a href="https://github.com/akka/akka">Akka</a> 為例，該套件是以演員模型為核心思想去實踐一個框架的：</p>
<pre><code class="language-java">public class HelloWorld extends AbstractBehavior&lt;HelloWorld.Command&gt; {

  interface Command {}

  public enum SayHello implements Command {
    INSTANCE
  }

  public static class ChangeMessage implements Command {
    public final String newMessage;

    public ChangeMessage(String newMessage) {
      this.newMessage = newMessage;
    }
  }

  public static Behavior&lt;Command&gt; create() {
    return Behavior.setup(context -&gt; new HelloWorld(context));
  }

  private String message = &quot;Hello World&quot;;

  private HelloWorld(ActorContext&lt;Command&gt; context) {
    super(context);
  }

  @Override
  public Receive&lt;Command&gt; createReceive() {
    return newReceiveBuilder()
      .onMessageEquals(SayHello.INSTANCE, this::onSayHello)
      .onMessage(ChangeMessage.class,this::onMessageChange)
      .build();
  }

  private Behavior&lt;Command&gt; onSayHello() {
    System.out.println(message);
    return this;
  }

  private Behavior&lt;Command&gt; onMessageChange(ChangeMessage command) {
    message = command.newMessage;
    return this;
  }
}
</code></pre>
<p>上述演員在收到 <code>SayHello.INSTANCE</code> 就會執行 <code>onSayHello</code>，收到 <code>ChangeMessage</code> 這一類別的訊息時會執行 <code>onMessageChange</code>。</p>
<p>準備好演員，就可以開始執行劇場工作囉：</p>
<pre><code class="language-java">ActorSystem&lt;HelloWorld.Command&gt; mySystem = ActorSystem.create(HelloWorld.create(), &quot;MySystem&quot;);

// 告訴演員 `HelloWorld.SayHello.INSTANCE` 這則訊息
mySystem.tell(HelloWorld.SayHello.INSTANCE);
mySystem.tell(HelloWorld.SayHello.INSTANCE);
// 告訴演員 `HelloWorld.ChangeMessage` 這個型別的訊息
mySystem.tell(new HelloWorld.ChangeMessage(&quot;Hello Actor World!!&quot;));
mySystem.tell(HelloWorld.SayHello.INSTANCE);
mySystem.tell(HelloWorld.SayHello.INSTANCE);
// 最後輸出：
// Hello World
// Hello World
// Hello Actor World!!
// Hello Actor World!!
</code></pre>
<p>演員模型的價值在於它不只局限於程式碼之間的訊息傳遞，你一樣可以通過網際網路的方式傳遞，就好像 API 一樣（類似 RPC 想做的事）。</p>
<p><a href="https://youtu.be/rIFqJxMJ1MM">Referrer</a></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../../feedback/designing-data-intensive-applications/db-index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../../feedback/designing-data-intensive-applications/read-intensive-db.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../../feedback/designing-data-intensive-applications/db-index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../../feedback/designing-data-intensive-applications/read-intensive-db.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
                <script type="text/javascript" src="../../pagetoc.js"></script>
                <script type="text/javascript" src="../../mermaid.min.js"></script>
                <script type="text/javascript" src="../../mermaid-init.js"></script>
        
        
    </body>
</html>
