
<!DOCTYPE html>

<html class="no-js" lang="zh-TW">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="各種紀錄和心得" name="description"/>
<link href="https://evan361425.github.io/essay/web/tcp/" rel="canonical"/>
<link href="../network-books/" rel="prev"/>
<link href="../ntp/" rel="next"/>
<link href="../../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.0, mkdocs-material-9.5.30" name="generator"/>
<meta content="COb7MqeOYLfRXXUOsXWaQvnr1_Xb33a0aP_Y8UC3U5Y" name="google-site-verification"/>
<meta content="TCP" property="og:title"/>
<title>TCP - 心得與記錄</title>
<link href="../../../assets/stylesheets/main.3cba04c6.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet"/>
<style>
    /**
    * Center the table
    */
    .md-typeset__table {
      margin-left: auto;
      margin-right: auto;
      display: table;
    }

    /**
    * Center the image
    */
    figure img {
      margin-left: auto;
      margin-right: auto;
    }

    .md-typeset :is(.admonition, details) {
      font-size: .8rem;
    }

    /**
    * It will wider than mjx-math and cause screen broken.
    * This element is for screen-reader, see detailed in
    * https://docs.mathjax.org/en/latest/basic/accessibility.html#screen-reader-support
    */
    .MathJax mjx-assistive-mml {
      display: none !important;
    }
    /**
    * Keep zoomed-in image on the top of palette
    */
    .medium-zoom-image--opened {
      z-index: 10;
    }
  </style>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=-apple-system,+BlinkMacSystemFont,+" rel="stylesheet" segoe+ui",+"helvetica+neue",+helvetica,+roboto,+arial,+"pingfang+tc",+"microsoft+jhenghei",+"微軟正黑",+sans-serif,+"apple+color+emoji",+"segoe+ui+emoji",+"segoe+ui+symbol":300,300i,400,400i,700,700i%7croboto+mono:400,400i,700,700i&display='fallback"'/>
<style>:root{--md-text-font:"-apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Helvetica, Roboto, Arial, "PingFang TC", "Microsoft JhengHei", "微軟正黑", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"";--md-code-font:"Roboto Mono"}</style>
<link href="../../../stylesheets/custom.css" rel="stylesheet"/>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-P67FD9XP83"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-P67FD9XP83",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-P67FD9XP83",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
<script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
</head>
<body data-md-color-accent="light-blue" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#tcp">
          跳轉到
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="頁首" class="md-header__inner md-grid">
<a aria-label="心得與記錄" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="心得與記錄">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            心得與記錄
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              TCP
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="黑夜降臨" class="md-option" data-md-color-accent="light-blue" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="黑夜降臨">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"></path></svg>
</label>
<input aria-label="白日昇起" class="md-option" data-md-color-accent="deep-orange" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="blue-grey" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="白日昇起">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"></path></svg>
</label>
</form>
<script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="搜尋" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="搜尋" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="搜尋" class="md-search__options">
<button aria-label="清除" class="md-search__icon md-icon" tabindex="-1" title="清除" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            正在初始化搜尋引擎
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/evan361425/evan361425.github.io" title="前往倉庫">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="標籤" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../..">
        
  
    
  
  自我介紹

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../feedback/">
          
  
    
  
  心得

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../review/">
          
  
    
  
  年度回顧

        </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../../">
          
  
    
  
  隨筆

        </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="導覽列" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="心得與記錄" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="心得與記錄">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    心得與記錄
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/evan361425/evan361425.github.io" title="前往倉庫">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
<span class="md-ellipsis">
    自我介紹
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../feedback/">
<span class="md-ellipsis">
    心得
  </span>
</a>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            心得
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_2" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/">
<span class="md-ellipsis">
    Designing Data-intensive Applications
  </span>
</a>
<label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_2">
<span class="md-nav__icon md-icon"></span>
            Designing Data-intensive Applications
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/foundation-model/">
<span class="md-ellipsis">
    基礎—模型和語法
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/foundation-index/">
<span class="md-ellipsis">
    基礎—索引
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/foundation-dw/">
<span class="md-ellipsis">
    基礎—資料倉儲
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/foundation-encode/">
<span class="md-ellipsis">
    基礎—編碼和進程
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/foundation-ft/">
<span class="md-ellipsis">
    基礎—容錯
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/distributed-replication/">
<span class="md-ellipsis">
    分散式—複製
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/distributed-partition/">
<span class="md-ellipsis">
    分散式—分區
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/distributed-env/">
<span class="md-ellipsis">
    分散式—環境
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/distributed-ft/">
<span class="md-ellipsis">
    分散式—容錯
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/derived-batch/">
<span class="md-ellipsis">
    衍生—批次處理
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/derived-stream/">
<span class="md-ellipsis">
    衍生—串流處理
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/farewell/">
<span class="md-ellipsis">
    總結和整合
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/glossary/">
<span class="md-ellipsis">
    詞彙表
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_3" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../feedback/distributed-systems-with-node.js/">
<span class="md-ellipsis">
    Distributed Systems with Node.js
  </span>
</a>
<label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_3">
<span class="md-nav__icon md-icon"></span>
            Distributed Systems with Node.js
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/distributed-systems-with-node.js/protocol/">
<span class="md-ellipsis">
    協定
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/distributed-systems-with-node.js/sla-and-load-testing/">
<span class="md-ellipsis">
    SLA 和負載測試
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/distributed-systems-with-node.js/observability/">
<span class="md-ellipsis">
    可觀測性
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/distributed-systems-with-node.js/container/">
<span class="md-ellipsis">
    容器化
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/distributed-systems-with-node.js/container-orchestration-and-misc/">
<span class="md-ellipsis">
    容器調度工具和其他
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_4" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../feedback/future-of-fusion-energy/">
<span class="md-ellipsis">
    （WIP）Future Of Fusion Energy
  </span>
</a>
<label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_4">
<span class="md-nav__icon md-icon"></span>
            （WIP）Future Of Fusion Energy
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/future-of-fusion-energy/energy/">
<span class="md-ellipsis">
    能源
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/future-of-fusion-energy/fusion/">
<span class="md-ellipsis">
    核融合
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_5" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../feedback/site-reliability-workbook/">
<span class="md-ellipsis">
    （WIP）SRE Workbook
  </span>
</a>
<label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_5">
<span class="md-nav__icon md-icon"></span>
            （WIP）SRE Workbook
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/site-reliability-workbook/toil/">
<span class="md-ellipsis">
    勞動力
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/site-reliability-workbook/simplicity/">
<span class="md-ellipsis">
    簡化系統
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/site-reliability-workbook/legacy-system/">
<span class="md-ellipsis">
    處理舊有系統
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/site-reliability-workbook/on-call/">
<span class="md-ellipsis">
    待命小組
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/site-reliability-workbook/incident-response/">
<span class="md-ellipsis">
    災難管理
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/site-reliability-workbook/postmortem-culture/">
<span class="md-ellipsis">
    事後析誤文化
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/site-reliability-workbook/managing-load/">
<span class="md-ellipsis">
    負載管理
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/site-reliability-workbook/nalsd/">
<span class="md-ellipsis">
    非抽象大型系統設計
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/site-reliability-workbook/data-pipelines/">
<span class="md-ellipsis">
    資料管線設計
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/site-reliability-workbook/configuration-best-practice/">
<span class="md-ellipsis">
    設定檔的最佳實踐
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/site-reliability-workbook/canary-release/">
<span class="md-ellipsis">
    金絲雀部署
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/release-it/">
<span class="md-ellipsis">
    Release It!
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/adaptive-concurrency/">
<span class="md-ellipsis">
    Adaptive Concurrency
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_8" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../feedback/physics/">
<span class="md-ellipsis">
    Physics
  </span>
</a>
<label class="md-nav__link" for="__nav_2_8" id="__nav_2_8_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_8_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_8">
<span class="md-nav__icon md-icon"></span>
            Physics
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/physics/astronomy/">
<span class="md-ellipsis">
    天文學
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/physics/special-relativity/">
<span class="md-ellipsis">
    （WIP）狹義相對論
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../review/">
<span class="md-ellipsis">
    年度回顧
  </span>
</a>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            年度回顧
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../review/2022-ai/">
<span class="md-ellipsis">
    2022 AI 回顧
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../review/2023/">
<span class="md-ellipsis">
    2023 回顧
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../">
<span class="md-ellipsis">
    隨筆
  </span>
</a>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="true" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            隨筆
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
<span class="md-ellipsis">
    系統架構類
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_2">
<span class="md-nav__icon md-icon"></span>
            系統架構類
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/made-container/">
<span class="md-ellipsis">
    如何製作 Docker Container
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/pki-checklist/">
<span class="md-ellipsis">
    建置 PKI 注意事項
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/replace-docker-desktop/">
<span class="md-ellipsis">
    取代 Docker Desktop
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/tomcat-max-packet-size/">
<span class="md-ellipsis">
    Tomcat 的 max_packet_size
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/tcp-socket-loss-after-dhcp/">
<span class="md-ellipsis">
    TCP socket 連線被清除的錯誤排查
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
<span class="md-ellipsis">
    程式語言類
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_3">
<span class="md-nav__icon md-icon"></span>
            程式語言類
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../code/node.js-best-practice/">
<span class="md-ellipsis">
    Node.js 最佳實作
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../code/node.js-error/">
<span class="md-ellipsis">
    Node.js 的錯誤有哪些
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../code/object-oriented-terms/">
<span class="md-ellipsis">
    物件導向名詞
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_4_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_4" id="__nav_4_4_label" tabindex="0">
<span class="md-ellipsis">
    網路相關
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_4_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_4">
<span class="md-nav__icon md-icon"></span>
            網路相關
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../network-routing/">
<span class="md-ellipsis">
    網路怎麼傳
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../network-details/">
<span class="md-ellipsis">
    網路傳了什麼
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../network-books/">
<span class="md-ellipsis">
    網路推薦書籍
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    TCP
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    TCP
  </span>
</a>
<nav aria-label="目錄" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      目錄
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#osi-中扮演的角色">
<span class="md-ellipsis">
      OSI 中扮演的角色
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#內容物">
<span class="md-ellipsis">
      內容物
    </span>
</a>
<nav aria-label="內容物" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#tcp-信號">
<span class="md-ellipsis">
      TCP 信號
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tcp-選項">
<span class="md-ellipsis">
      TCP 選項
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#範例">
<span class="md-ellipsis">
      範例
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#指標">
<span class="md-ellipsis">
      指標
    </span>
</a>
<nav aria-label="指標" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#backlog">
<span class="md-ellipsis">
      Backlog
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#linger">
<span class="md-ellipsis">
      Linger
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#defer-accept">
<span class="md-ellipsis">
      Defer Accept
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#fast-retransmission">
<span class="md-ellipsis">
      Fast Retransmission
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#zero-window">
<span class="md-ellipsis">
      Zero Window
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#coalescing">
<span class="md-ellipsis">
      Coalescing
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cork">
<span class="md-ellipsis">
      CORK
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#delayed-ack">
<span class="md-ellipsis">
      Delayed ACK
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#selective-ack">
<span class="md-ellipsis">
      Selective ACK
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#syn-cookies">
<span class="md-ellipsis">
      SYN Cookies
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#paws">
<span class="md-ellipsis">
      PAWS
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#forward-rto">
<span class="md-ellipsis">
      Forward RTO
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#fast-open">
<span class="md-ellipsis">
      Fast Open
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#congestion-control">
<span class="md-ellipsis">
      Congestion Control
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#特殊">
<span class="md-ellipsis">
      特殊
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#有用指令">
<span class="md-ellipsis">
      有用指令
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#bsd-socket-api">
<span class="md-ellipsis">
      BSD Socket API
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#問題_4">
<span class="md-ellipsis">
      問題
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#referer">
<span class="md-ellipsis">
      Referer
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ntp/">
<span class="md-ellipsis">
    NTP
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../http/">
<span class="md-ellipsis">
    HTTP
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../retry-strategy/">
<span class="md-ellipsis">
    Retry 的策略
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../certificate-transparency/">
<span class="md-ellipsis">
    Certificate Transparency
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../url-structure/">
<span class="md-ellipsis">
    URL 長什麼樣子
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../maglev/">
<span class="md-ellipsis">
    Maglev
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_5" id="__nav_4_5_label" tabindex="0">
<span class="md-ellipsis">
    網路安全
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_5">
<span class="md-nav__icon md-icon"></span>
            網路安全
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../web-security/cross-origin-resources-sharing/">
<span class="md-ellipsis">
    CORS
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../web-security/mixed-content/">
<span class="md-ellipsis">
    Mixed Content
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../web-security/owasp-api-top10/">
<span class="md-ellipsis">
    OWASP API Top 10
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../web-security/owasp-authentication-best-practice/">
<span class="md-ellipsis">
    OWASP 驗證機制最佳指南
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../web-security/owasp-mobile-risk-top10/">
<span class="md-ellipsis">
    OWASP 行動裝置風險
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_4_6" id="__nav_4_6_label" tabindex="0">
<span class="md-ellipsis">
    其他
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_6_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_6">
<span class="md-nav__icon md-icon"></span>
            其他
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../gpl-check/">
<span class="md-ellipsis">
    GPL 的檢查
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../nginx-changelog/">
<span class="md-ellipsis">
    Nginx 1.18 到 1.22 的差異
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../node-changelog-14-18/">
<span class="md-ellipsis">
    Node.js 14 到 18 的差異
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../questionnaire-principal/">
<span class="md-ellipsis">
    問卷設計指南
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../devex-in-action/">
<span class="md-ellipsis">
    開發體驗的改進
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../pls-sem/">
<span class="md-ellipsis">
    PLS-SEM
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="目錄" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      目錄
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#osi-中扮演的角色">
<span class="md-ellipsis">
      OSI 中扮演的角色
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#內容物">
<span class="md-ellipsis">
      內容物
    </span>
</a>
<nav aria-label="內容物" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#tcp-信號">
<span class="md-ellipsis">
      TCP 信號
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tcp-選項">
<span class="md-ellipsis">
      TCP 選項
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#範例">
<span class="md-ellipsis">
      範例
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#指標">
<span class="md-ellipsis">
      指標
    </span>
</a>
<nav aria-label="指標" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#backlog">
<span class="md-ellipsis">
      Backlog
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#linger">
<span class="md-ellipsis">
      Linger
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#defer-accept">
<span class="md-ellipsis">
      Defer Accept
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#fast-retransmission">
<span class="md-ellipsis">
      Fast Retransmission
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#zero-window">
<span class="md-ellipsis">
      Zero Window
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#coalescing">
<span class="md-ellipsis">
      Coalescing
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cork">
<span class="md-ellipsis">
      CORK
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#delayed-ack">
<span class="md-ellipsis">
      Delayed ACK
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#selective-ack">
<span class="md-ellipsis">
      Selective ACK
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#syn-cookies">
<span class="md-ellipsis">
      SYN Cookies
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#paws">
<span class="md-ellipsis">
      PAWS
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#forward-rto">
<span class="md-ellipsis">
      Forward RTO
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#fast-open">
<span class="md-ellipsis">
      Fast Open
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#congestion-control">
<span class="md-ellipsis">
      Congestion Control
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#特殊">
<span class="md-ellipsis">
      特殊
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#有用指令">
<span class="md-ellipsis">
      有用指令
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#bsd-socket-api">
<span class="md-ellipsis">
      BSD Socket API
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#問題_4">
<span class="md-ellipsis">
      問題
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#referer">
<span class="md-ellipsis">
      Referer
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<a class="md-content__button md-icon" href="https://github.com/evan361425/evan361425.github.io/blob/master/src/essay/web/tcp.md" title="編輯此頁">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5m-7.86-1.75L8.85 19l.29-.74C10.43 15.06 13.5 13 17 13c1.05 0 2.06.21 3 .56V8l-6-6H6c-1.11 0-2 .89-2 2v16a2 2 0 0 0 2 2h4.5c-.55-.66-1-1.42-1.36-2.25M13 3.5 18.5 9H13V3.5Z"></path></svg>
</a>
<h1 id="tcp">TCP<a class="headerlink" href="#tcp" title="Permanent link">¶</a></h1>
<p>Transmission Control Protocol 傳輸控制協定的作用說明。</p>
<h2 id="osi-中扮演的角色">OSI 中扮演的角色<a class="headerlink" href="#osi-中扮演的角色" title="Permanent link">¶</a></h2>
<p>Network 之上，Application 之下。</p>
<p>Network 中的 IP 是一種不考慮連線的協定，他只需要負責把封包路由給指定的目的地。在此之上的 TCP
則會透過類似於 HTTP session 的機制，反復確認段（segment）裡的訊號和編號來確保兩端的連線。</p>
<p>換句話說，TCP 是被設計成雙向（bidirectional）、序列性（ordered）和可靠（reliable）的資料傳輸協定。</p>
<ul>
<li>雙向：開啟連線時，這個連線雙方都可以寫入和讀取的；</li>
<li>序列：透過序列（Sequence 或簡稱 SEQ) 和確認（Acknowledgement 或簡稱 ACK）的編號確認；</li>
<li>可靠：透過反覆寄送、檢查信號 ACK，確認雙方認知一致。</li>
</ul>
<h2 id="內容物">內容物<a class="headerlink" href="#內容物" title="Permanent link">¶</a></h2>
<p><figure><img alt="TCP 標頭的可能內容物" src="https://i.imgur.com/3nh6DOI.png"/><figcaption>TCP 標頭的可能內容物<br/>來源於：<a href="https://notfalse.net/26/tcp-seq">鄭中勝</a></figcaption></figure></p>
<p>TCP 會透過上述各種編號和標記來完成連線所需的溝通。
當建立連線（三次握手）後，雙方就不存在監聽方和發起方。
兩者皆可以做監聽和送訊息，同時雙方也都可以要求中斷連線，
並且雙方都要同意關閉連線，此時連線才能優雅而完整的關閉連線（四次揮手）。
其完整生命的程如下：</p>
<p><figure><img alt="TCP 狀態流程" src="https://imgur.com/jeS7mge.png"/><figcaption>TCP 狀態流程</figcaption></figure></p>
<p>建立連線：</p>
<ul>
<li>監聽方透過 <a href="#bsd-socket-api">socket API</a> CONNECT 來等待連線；</li>
<li>請求方 <em>要求建立</em>；</li>
<li>監聽同樣 <em>要求建立</em> 且透過 ACK 同意原請求；</li>
<li>請求方 <em>同意建立請求</em> 自此，連線完成建立。
  此時，請求方可能會同時把資料一起送出。</li>
</ul>
<p>關閉連線：</p>
<ul>
<li>任意一方 <em>要求關閉</em>，進入主動關閉方；</li>
<li>收到的人，照常回應 ACK 同步認知，進入關閉等待期。
  如確認資料都送出，且同意關閉後會同樣送出 <em>關閉要求</em> 並結束該連線；</li>
<li>此時，主動關閉方根據收到的標記，進入不同狀態，最終走入暫置區（<code>TIME_WAIT</code>)。</li>
</ul>
<p>各個標記（flag）代表的意義在下段展示。</p>
<h3 id="tcp-信號">TCP 信號<a class="headerlink" href="#tcp-信號" title="Permanent link">¶</a></h3>
<p>不同的 TCP 信號代表這個 TCP 段（segment）的意義是什麼，
以下依照該信號在封包的位置順序來排列：</p>
<ul>
<li>Reserved：保留，供未來可能需求使用；</li>
<li>Explicit Congestion Notification, ECN：一種明確告知接收方壅塞的協定<ul>
<li>避免直接透過丟包，來達成壅塞的隱晦告知；</li>
<li>目前預設關閉，但有人分享<a href="https://www.reddit.com/r/linux/comments/933vys/is_tcp_ecn_still_a_problem_today/">啟用後並沒有收到什麼問題</a>。</li>
</ul>
</li>
<li>Urgent, URG，緊急的封包：<ul>
<li>告知接收方這個封包不需要進入佇列（queue），請直接處理；</li>
<li>目前我沒看過這個使用的實際場景。</li>
</ul>
</li>
<li>Acknowledgment, ACK，代表我收到你剛剛的封包了：<ul>
<li>通常用來告知對方，我收到你剛剛傳的信號了；</li>
<li>有時會夾帶其他信號，表明同意某些要求，
  例如 SYN+ACK 代表我收到你的連線要求，我也同時告知對方這個連線應該要被建立。</li>
</ul>
</li>
<li>Push, PSH，代表有資料需要儲存：<ul>
<li>添加這個信號代表接收方不需要做暫存，可以直接把資料往上傳遞</li>
<li>通常用在小段的資料，因為大資料會被分成多段，然後會有順序議題</li>
</ul>
</li>
<li>Reset, RST，代表我不認識這個封包：<ul>
<li>已經捨棄的連線又收到訊號（例如 ACK），就會回應此；</li>
<li>埠不存在，通常是因為你請求的埠沒被打開；</li>
<li>IP 不存在，通常是因為你監聽的 IP 不是 <code>0.0.0.0:port</code>；</li>
<li>連線被棄用，對方會出現 Connection closed by peer 的錯誤；</li>
<li>對方的佇列（queue）已經滿了；</li>
<li>防火牆清除了 session table，導致不認識這段連線，就可能回傳該訊號。</li>
</ul>
</li>
<li>Synchronize, SYN，代表我們來建立連線吧：<ul>
<li>接受者需要回應 ACK。</li>
</ul>
</li>
<li>Finish, FIN，代表連線的關閉：<ul>
<li>被動方需要回應 ACK。</li>
</ul>
</li>
</ul>
<h4 id="建立連線的信號">建立連線的信號<a class="headerlink" href="#建立連線的信號" title="Permanent link">¶</a></h4>
<p><figure><img alt="三次握手的範例" src="https://i.imgur.com/tsr9hCN.png"/><figcaption>三次握手的範例<br/>來源於：<a href="https://notfalse.net/26/tcp-seq">鄭中勝</a></figcaption></figure></p>
<p>彼此會在三次握手中確認接下來的 <code>SEQ</code> 號碼，同時互相確認關係：</p>
<ul>
<li>主動方（或稱發起方、客戶端）送出要求連線的同步信號（Synchronous 或稱 SYN）；</li>
<li>監聽方（或稱服務端、伺服端）允許連線（ACK）並同樣賦予同步信號（SYN）；</li>
<li>主動方允許連線（ACK）並可能同時傳遞資料給監聽方。</li>
</ul>
<h4 id="關閉連線的信號">關閉連線的信號<a class="headerlink" href="#關閉連線的信號" title="Permanent link">¶</a></h4>
<p>主動關閉（Active Close）的那方可以根據需求關閉連線，
但是對被動關閉（Passive Close）的那方來說，傳送的資料可能還沒完成，
這時就需要等應用層資料都送出去之後，才會再一次做關閉的動作。</p>
<p><figure><img alt="TCP 四次揮手流程" src="https://i.imgur.com/qFzjzri.png"/><figcaption>TCP 四次揮手流程</figcaption></figure></p>
<p>所以流程大致如下：</p>
<ul>
<li><em>主動方</em> 要求關閉連線 <code>FIN</code>，並進入 <code>FIN_WAIT1</code> 狀態；</li>
<li><em>被動方</em> 告知收到這個資訊 <code>ACK</code>；</li>
<li><em>被動方</em> 確保資料都送完後，關閉連線 <code>FIN</code>；</li>
<li><em>主動方</em> <code>FIN_WAIT1</code> 時，如果收到 <code>FIN</code> 就進入 <code>Closing</code> 狀態準備直接進入 <code>TIME_WAIT</code>；</li>
<li><em>主動方</em> <code>FIN_WAIT1</code> 時，如果收到 <code>ACK</code> 就進入 <code>FIN_WAIT2</code> 狀態，等待收到 <code>FIN</code> 就直接進入 <code>TIME_WAIT</code>；</li>
<li><em>主動方</em> <code>FIN_WAIT1</code> 時，如果收到 <code>FIN+ACK</code> 就進入 <code>TIME_WAIT</code>；</li>
<li><em>主動方</em> 進入 <code>TIME_WAIT</code> 狀態，等到超過兩次 MSL（Maximum Segment Lifetime）的時間後，關閉連線。</li>
</ul>
<p>這時你就會注意到一件事，<strong>身為主動關閉的那方，是需要付出代價的</strong>。
他需要進入等待對方關閉的狀態（<code>FIN WAIT 1</code> 或 <code>FIN WAIT 2</code>），然後還要再待在 <code>TIME_WAIT</code> 來避免阜的複用。
相較而言，被動那方就只要確認關閉後，就可以瀟灑說再見了。</p>
<p>之所以要進入 <code>TIME_WAIT</code> 這個狀態是因為如果直接使用這個來源埠，
下次的連線很可能會收到上次連線的重送（Retransmission）資訊。</p>
<h3 id="tcp-選項">TCP 選項<a class="headerlink" href="#tcp-選項" title="Permanent link">¶</a></h3>
<p>TCP 選項（TCP Option）大部分都是在握手階段確認的，
<a href="https://www.geeksforgeeks.org/options-field-in-tcp-header/">詳見</a>，這裡列舉幾個：</p>
<ul>
<li>0: End of options</li>
<li>1: no-op</li>
<li>2: MSS(Maximum TCP Segment Size)，協商段的大小</li>
<li>3: Window Scaling，提高客戶端可用頻寬</li>
<li>4: SACK（Selective ACK），避免每次都要等超時才重傳，且只重傳丟失的封包，用來加速重傳的機制</li>
<li>8: Timestamp，精準 RTT</li>
<li>34: TFO（TCP Fast Open）</li>
</ul>
<p>Kernel options 可以參考 <a href="https://sysctl-explorer.net/net/">sysctl-explorer</a>，
更多說明將在<a href="#指標">指標</a>中展示。</p>
<h3 id="範例">範例<a class="headerlink" href="#範例" title="Permanent link">¶</a></h3>
<p>以連線到 google.com 中產生的多個封包做說明。</p>
<blockquote>
<p>如果是 HTTP/3 就不是 TCP 了，到時要看看用什麼網站比較好。</p>
</blockquote>
<div class="highlight"><pre><span></span><code>tcpdump<span class="w"> </span>-i<span class="w"> </span>&lt;interface&gt;<span class="w"> </span>port<span class="w"> </span>&lt;port&gt;<span class="w"> </span>-w<span class="w"> </span>-<span class="w"> </span>-U<span class="w"> </span><span class="p">|</span><span class="w"> </span>tee<span class="w"> </span>/tmp/evan.pcap<span class="w"> </span><span class="p">|</span><span class="w"> </span>tcpdump<span class="w"> </span>-r<span class="w"> </span>-
</code></pre></div>
<h4 id="建立連線階段">建立連線階段<a class="headerlink" href="#建立連線階段" title="Permanent link">¶</a></h4>
<p>MSS(Maximum TCP Segment Size) v.s. MTU(Maximum Transmission Unit):</p>
<div class="highlight"><pre><span></span><code>MTU = MSS + 40 (IP header + TCP header)
</code></pre></div>
<h4 id="sequence-number">SEQuence number<a class="headerlink" href="#sequence-number" title="Permanent link">¶</a></h4>
<p>TBD</p>
<h4 id="acknowledge-number">ACKnowledge number<a class="headerlink" href="#acknowledge-number" title="Permanent link">¶</a></h4>
<p>TBD</p>
<h4 id="options">Options<a class="headerlink" href="#options" title="Permanent link">¶</a></h4>
<p>TBD</p>
<h2 id="指標">指標<a class="headerlink" href="#指標" title="Permanent link">¶</a></h2>
<p>指標名稱都有前綴：<code>node_netstat_TcpExt_</code>。</p>
<div class="admonition note">
<p class="admonition-title">來源</p>
<p>本列表示使用 Node Exporter 提供的指標。</p>
<p>你可以透過以下指令來取得各個指標的上升幅度：</p>
<div class="highlight"><pre><span></span><code>increase(label_replace({__name__=~"node_netstat_Tcp.*"}, "na", "$1", "__name__", "node_netstat_Tcp(.+)")[5m:1m])
</code></pre></div>
</div>
<table>
<thead>
<tr>
<th>名稱</th>
<th>原理</th>
<th>說明</th>
</tr>
</thead>
<tbody>
<tr>
<td>ArpFilter</td>
<td>Basic</td>
<td>接收到 ARP 封包時，拿到未知的 entry 時</td>
</tr>
<tr>
<td>EmbryonicRsts</td>
<td>Basic</td>
<td><code>SYN_RECV</code> 時收到不合理的封包，並回傳 <code>RST</code></td>
</tr>
<tr>
<td>ListenDrops</td>
<td>Basic</td>
<td><code>LISTEN</code> 因任何原因建立連線失敗，大於等於 ListenOverflows</td>
</tr>
<tr>
<td>TCPTimeouts</td>
<td>Basic</td>
<td>第一次發生 RTO 或 SYN-ACK 超時</td>
</tr>
<tr>
<td>TW</td>
<td>Basic</td>
<td><code>TIME_WAIT</code> 數量</td>
</tr>
<tr>
<td>TCPTimeWaitOverflow</td>
<td>Basic</td>
<td><code>TIME_WAIT</code> 數量太多了</td>
</tr>
<tr>
<td>TWKilled</td>
<td>Basic</td>
<td><code>TIME_WAIT</code> 在未達時限時，強制回收的數量</td>
</tr>
<tr>
<td>TWRecycled</td>
<td>Basic</td>
<td><code>TIME_WAIT</code> 被回收的數量</td>
</tr>
<tr>
<td>TCPAbortFailed</td>
<td>Basic</td>
<td>程式發生錯誤時，強制關閉連線</td>
</tr>
<tr>
<td>TCPAbortOnClose</td>
<td>Basic</td>
<td>在進入 <code>FIN_WAIT_1</code> 或 <code>FIN_WAIT_2</code> 時，強制關閉連線</td>
</tr>
<tr>
<td>TCPAbortOnData</td>
<td>Basic</td>
<td>在連線還有資料時，強制關閉連線</td>
</tr>
<tr>
<td>TCPAbortOnMemory</td>
<td>Basic</td>
<td>資源超過限制時，強制關閉連線</td>
</tr>
<tr>
<td>TCPAbortOnTimeout</td>
<td>Basic</td>
<td>RTO/probe/keepalive timer 達到最高上限時，強制關閉連線</td>
</tr>
<tr>
<td>TCPSynRetrans</td>
<td>Basic</td>
<td>重新嘗試送出 <code>SYN</code></td>
</tr>
<tr>
<td>TCPRetransFail</td>
<td>Basic</td>
<td>重新嘗試送出 <code>SYN</code> 卻仍失敗？</td>
</tr>
<tr>
<td>TCPKeepAlive</td>
<td>Basic</td>
<td>Keep-Alive 次數</td>
</tr>
<tr>
<td>TCPFastRetrans</td>
<td><a href="#fast-retransmission">Fast Retransmission</a></td>
<td>收到新的 <code>ACK</code>，舊的還沒收到就直接 retrans</td>
</tr>
<tr>
<td>TCPSlowStartRetrans</td>
<td><a href="#delayed-ack">Delayed ACK</a></td>
<td>Delayed ACK 開始啟用</td>
</tr>
<tr>
<td>DelayedACKLocked</td>
<td><a href="#delayed-ack">Delayed ACK</a></td>
<td>Timer 被本機 lock 住而無法正確發送 <code>ACK</code></td>
</tr>
<tr>
<td>DelayedACKLost</td>
<td><a href="#delayed-ack">Delayed ACK</a></td>
<td>送出的 <code>ACK</code> 被認為不合法</td>
</tr>
<tr>
<td>DelayedACKs</td>
<td><a href="#delayed-ack">Delayed ACK</a></td>
<td>送出 Delayed ACK 次數</td>
</tr>
<tr>
<td>ListenOverflows</td>
<td><a href="#backlog">Backlog</a></td>
<td><code>LISTEN</code> 成功完成握手後，準備移交連線時發現 queue 滿了</td>
</tr>
<tr>
<td>TCPBacklogCoalesce</td>
<td><a href="#backlog">Backlog</a></td>
<td></td>
</tr>
<tr>
<td>TCPBacklogDrop</td>
<td><a href="#backlog">Backlog</a></td>
<td>進入佇列時失敗</td>
</tr>
<tr>
<td>PAWSActive</td>
<td><a href="#paws">PAWS</a></td>
<td><code>SYN_SENT</code> 後的 <code>ACK</code> 檢查 PAWS 失敗</td>
</tr>
<tr>
<td>PAWSPassive</td>
<td><a href="#paws">PAWS</a></td>
<td><code>SYN_RECV</code> 後的 <code>ACK</code> 檢查 PAWS 失敗</td>
</tr>
<tr>
<td>PAWSEstab</td>
<td><a href="#paws">PAWS</a></td>
<td>連線建立後 PAWS 檢查失敗</td>
</tr>
<tr>
<td>TCPTSReorder</td>
<td><a href="#paws">PAWS</a></td>
<td>Timestamp 亂序了</td>
</tr>
<tr>
<td>TCPDSACKIgnoredNoUndo</td>
<td><a href="#selective-ack">Selective ACK</a></td>
<td>收到非法 D-SACK 時，話句話說，SACK 中的序號太舊</td>
</tr>
<tr>
<td>TCPDSACKIgnoredOld</td>
<td><a href="#selective-ack">Selective ACK</a></td>
<td>收到非法 D-SACK 時，話句話說，SACK 中的序號太舊</td>
</tr>
<tr>
<td>TCPDSACKOfoRecv</td>
<td><a href="#selective-ack">Selective ACK</a></td>
<td>本機發送的舊封包還沒送到，新的封包已經送去了</td>
</tr>
<tr>
<td>TCPDSACKOfoSent</td>
<td><a href="#selective-ack">Selective ACK</a></td>
<td>本機舊的封包還沒收到，新的封包已經來了</td>
</tr>
<tr>
<td>TCPDSACKOldSent</td>
<td><a href="#selective-ack">Selective ACK</a></td>
<td>對方傳本機已經看過的封包，換句話說，對方收不到本機的 <code>ACK</code></td>
</tr>
<tr>
<td>TCPDSACKRecv</td>
<td><a href="#selective-ack">Selective ACK</a></td>
<td>對方收到本機的封包重傳，換句話說，本機收不到對方的 <code>ACK</code></td>
</tr>
<tr>
<td>TCPDSACKUndo</td>
<td><a href="#selective-ack">Selective ACK</a></td>
<td></td>
</tr>
<tr>
<td>TCPLostRetransmit</td>
<td><a href="#selective-ack">Selective ACK</a></td>
<td>送過去的封包沒有得到相應的 SACK</td>
</tr>
<tr>
<td>TCPSACKDiscard</td>
<td><a href="#selective-ack">Selective ACK</a></td>
<td>收到非法 SACK 時，話句話說，SACK 中的序號太舊</td>
</tr>
<tr>
<td>TCPSACKReneging</td>
<td><a href="#selective-ack">Selective ACK</a></td>
<td>本機已經丟掉了之前接收的數據，本機食言了</td>
</tr>
<tr>
<td>TCPSACKReorder</td>
<td><a href="#selective-ack">Selective ACK</a></td>
<td>本機收不到對方封包，開始等待舊資料</td>
</tr>
<tr>
<td>TCPSackRecovery</td>
<td><a href="#selective-ack">Selective ACK</a></td>
<td>本機送不出去封包，開始整理封包順序</td>
</tr>
<tr>
<td>TCPSackFailures</td>
<td><a href="#selective-ack">Selective ACK</a></td>
<td>RTO 發生，不再重傳對方沒接收到的封包</td>
</tr>
<tr>
<td>TCPSackRecoveryFail</td>
<td><a href="#selective-ack">Selective ACK</a></td>
<td>RTO 發生，不再重整接收的封包順序</td>
</tr>
<tr>
<td>TCPSackShifted</td>
<td><a href="#selective-ack">Selective ACK</a></td>
<td>Linux 成功整理順序</td>
</tr>
<tr>
<td>TCPSackShiftFallback</td>
<td><a href="#selective-ack">Selective ACK</a></td>
<td>Linux 整理順序失敗</td>
</tr>
<tr>
<td>TCPSackMerged</td>
<td><a href="#selective-ack">Selective ACK</a></td>
<td>得到亂序資料後，進行整併成功</td>
</tr>
<tr>
<td>TCPRenoFailures</td>
<td></td>
<td>在不啟用 SACK 的狀態</td>
</tr>
<tr>
<td>TCPRenoRecovery</td>
<td></td>
<td>在不啟用 SACK 的狀態</td>
</tr>
<tr>
<td>TCPRenoRecoveryFail</td>
<td></td>
<td>在不啟用 SACK 的狀態</td>
</tr>
<tr>
<td>TCPRenoReorder</td>
<td></td>
<td>在不啟用 SACK 的狀態</td>
</tr>
<tr>
<td>TCPDeferAcceptDrop</td>
<td><a href="#defer-accept">Defer Accept</a></td>
<td>Defer accept 的連線被丟棄</td>
</tr>
<tr>
<td>TCPFastOpenActive</td>
<td><a href="#fast-open">Fast Open</a></td>
<td>發送方成功建立</td>
</tr>
<tr>
<td>TCPFastOpenActiveFail</td>
<td><a href="#fast-open">Fast Open</a></td>
<td>發送方建立失敗</td>
</tr>
<tr>
<td>TCPFastOpenBlackhole</td>
<td><a href="#fast-open">Fast Open</a></td>
<td>避免 firewall 阻擋導致失能的機制被觸發</td>
</tr>
<tr>
<td>TCPFastOpenCookieReqd</td>
<td><a href="#fast-open">Fast Open</a></td>
<td>Server 回應 Cookie Required</td>
</tr>
<tr>
<td>TCPFastOpenListenOverflow</td>
<td><a href="#fast-open">Fast Open</a></td>
<td>接收方連線佇列滿溢</td>
</tr>
<tr>
<td>TCPFastOpenPassive</td>
<td><a href="#fast-open">Fast Open</a></td>
<td>接收方獲得新連線</td>
</tr>
<tr>
<td>TCPFastOpenPassiveAltKey</td>
<td><a href="#fast-open">Fast Open</a></td>
<td>接收方獲得新連線且 cookie 有效</td>
</tr>
<tr>
<td>TCPFastOpenPassiveFail</td>
<td><a href="#fast-open">Fast Open</a></td>
<td>接收方嘗試建立連線失敗</td>
</tr>
<tr>
<td>TCPFromZeroWindowAdv</td>
<td><a href="#zero-window">Zero Window</a></td>
<td></td>
</tr>
<tr>
<td>TCPToZeroWindowAdv</td>
<td><a href="#zero-window">Zero Window</a></td>
<td></td>
</tr>
<tr>
<td>TCPWantZeroWindowAdv</td>
<td><a href="#zero-window">Zero Window</a></td>
<td></td>
</tr>
<tr>
<td>TCPZeroWindowDrop</td>
<td><a href="#zero-window">Zero Window</a></td>
<td></td>
</tr>
<tr>
<td>SyncookiesFailed</td>
<td><a href="#syn-cookies">SYN Cookies</a></td>
<td>驗證失敗</td>
</tr>
<tr>
<td>SyncookiesRecv</td>
<td><a href="#syn-cookies">SYN Cookies</a></td>
<td>收到有 cookie 的 SYN</td>
</tr>
<tr>
<td>SyncookiesSent</td>
<td><a href="#syn-cookies">SYN Cookies</a></td>
<td>送出有 cookie 的 SYN</td>
</tr>
<tr>
<td>TCPAutoCorking</td>
<td><a href="#cork">CORK</a></td>
<td>滿了或時間到了，直接送出</td>
</tr>
<tr>
<td>TCPRcvCoalesce</td>
<td><a href="#coalescing">Coalescing</a></td>
<td>收到整併的封包</td>
</tr>
<tr>
<td>TCPAbortOnLinger</td>
<td><a href="#linger">Linger</a></td>
<td>進入 <code>FIN_WAIT_2</code> 時，強制關閉連線</td>
</tr>
<tr>
<td>TCPChallengeACK</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPSYNChallenge</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPACKSkippedChallenge</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPOFODrop</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPOFOMerge</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPOFOQueue</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPMTUPFail</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPMTUPSuccess</td>
<td></td>
<td></td>
</tr>
<tr>
<td>PruneCalled</td>
<td></td>
<td></td>
</tr>
<tr>
<td>OfoPruned</td>
<td></td>
<td></td>
</tr>
<tr>
<td>RcvPruned</td>
<td></td>
<td></td>
</tr>
<tr>
<td>BusyPollRxPackets</td>
<td></td>
<td></td>
</tr>
<tr>
<td>IPReversePathFilter</td>
<td></td>
<td></td>
</tr>
<tr>
<td>LockDroppedIcmps</td>
<td>ICMP</td>
<td>ICMP 封包本應被丟棄，但因為是本機的請求，所以被 handle 了</td>
</tr>
<tr>
<td>OutOfWindowIcmps</td>
<td>ICMP</td>
<td>在已有的連線中偵測出錯誤狀態</td>
</tr>
<tr>
<td>PFMemallocDrop</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPACKSkippedFinWait2</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPACKSkippedPAWS</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPACKSkippedSeq</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPACKSkippedSynRecv</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPACKSkippedTimeWait</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPAckCompressed</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPPureAcks</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPFullUndo</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPPartialUndo</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPLossUndo</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPDelivered</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPDeliveredCE</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPHPAcks</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPHPHits</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPHystartDelayCwnd</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPHystartDelayDetect</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPHystartTrainCwnd</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPHystartTrainDetect</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPLossFailures</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPLossProbeRecovery</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPLossProbes</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPMemoryPressures</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPMemoryPressuresChrono</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPMinTTLDrop</td>
<td>Basic</td>
<td>封包的 TTL 過小，換句話說，傳了太久或太遠</td>
</tr>
<tr>
<td>TCPOrigDataSent</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPRcvCollapsed</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPRcvQDrop</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPReqQFullDoCookies</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPReqQFullDrop</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPSpuriousRTOs</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPSpuriousRtxHostQueues</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPWinProbe</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPWqueueTooBig</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPMD5Failure</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPMD5NotFound</td>
<td></td>
<td></td>
</tr>
<tr>
<td>TCPMD5Unexpected</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>相關說明可以參考：</p>
<ul>
<li><a href="https://loicpefferkorn.net/2018/09/linux-network-statistics-reference/#tcpext">Linux Network Statistics Reference</a></li>
<li><a href="https://www.cnblogs.com/lovemyspring/articles/5087895.html">TCP netstat -s 各项参数意义</a></li>
</ul>
<h3 id="backlog">Backlog<a class="headerlink" href="#backlog" title="Permanent link">¶</a></h3>
<p>連線建立後會被儲存在一個佇列中，這個佇列稱為 backlog。
Linux 的實作是把 <em>三次握手階段</em> 和 <em>連線建立完成</em> 分別放在不同的佇列。</p>
<p>詳見 Linux man page <a href="https://linux.die.net/man/2/listen">listen</a>，
以及 <a href="https://veithen.io/2014/01/01/how-tcp-backlog-works-in-linux.html">How TCP backlog works in Linux</a>。</p>
<h3 id="linger">Linger<a class="headerlink" href="#linger" title="Permanent link">¶</a></h3>
<ul>
<li><a href="https://breezetemple.github.io/2019/07/04/tcp-option-SO-LINGER/">參考</a></li>
</ul>
<p>Linux 透過 <code>SO_LINGER</code> 來啟用，透過 <code>RST</code> 來關閉連線。
這時可能會遇到緩衝區還有資料時，被迫中斷。</p>
<p>有兩種階段，這邊不贅述。</p>
<h3 id="defer-accept">Defer Accept<a class="headerlink" href="#defer-accept" title="Permanent link">¶</a></h3>
<p>Linux 透過 <code>TCP_DEFER_ACCEPT</code> 來啟用，只在收到資料後才把該連線認定為成功。</p>
<h3 id="fast-retransmission">Fast Retransmission<a class="headerlink" href="#fast-retransmission" title="Permanent link">¶</a></h3>
<p>本來如果送出的封包在 <code>RTO</code> 內沒有收到 ACK，則會重新發送（retransmission），
但是如果發送方收到大於最低的 ACK 號碼時，就會直接回傳舊的封包，一種快速回傳的機制。</p>
<h3 id="zero-window">Zero Window<a class="headerlink" href="#zero-window" title="Permanent link">¶</a></h3>
<ul>
<li><a href="https://blog.51cto.com/u_15060507/3641387">參考</a></li>
</ul>
<p>當接受方的緩存滿溢了，代表接受方實在過於忙碌，消化不完寄過來的封包。</p>
<p>Full window 則代表發送方需要等待對方的 <code>ACK</code> 以接著發送更多資訊，換句話說，對方一直沒有回 <code>ACK</code> 給我，
我不敢送更多封包給他。</p>
<h3 id="coalescing">Coalescing<a class="headerlink" href="#coalescing" title="Permanent link">¶</a></h3>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc896">RFC-896</a></li>
<li>相關：<a href="#delayed-ack">Delayed ACK</a>、<a href="#cork">Cork</a></li>
</ul>
<p>用來減少網路負荷的，等到時機純熟後一次性送出多個封包，時機包括：</p>
<ul>
<li>累積的封包超過 MSS（Maximum Segment Size, <code>MSS=MTU – 40</code>）</li>
<li>所有送出的封包都收到相應的 <code>ACK</code></li>
</ul>
<p>透過 <code>TCP_NODELAY=1</code> 來單獨為特定 socket 關閉本功能。</p>
<h4 id="問題">問題<a class="headerlink" href="#問題" title="Permanent link">¶</a></h4>
<p>如果搭配 <a href="#delayed-ack">Delayed ACK</a> 可能會造成我在等你的 <code>ACK</code> 再繼續送封包，而你在等我的 <code>ACK</code> 才會繼續送封包。</p>
<h3 id="cork">CORK<a class="headerlink" href="#cork" title="Permanent link">¶</a></h3>
<ul>
<li><a href="https://baus.net/on-tcp_cork/">參考</a></li>
<li>相關：<a href="#coalescing">Coalescing</a></li>
</ul>
<p>和 <a href="#coalescing">Coalescing</a> 相似，等到緩衝填滿了才把資料送出，
這個功能適用於有多個分段的區塊要送出，例如 HTTP Header 和 HTTP Body。</p>
<p>和 <a href="#coalescing">Coalescing</a> 的差異主要在於：</p>
<ul>
<li>無視上段封包送回的 <code>ACK</code></li>
<li>200 ms 過後就會強制送出封包</li>
</ul>
<p>透過 <code>TCP_CORK=1</code> 來單獨為特定 socket 開啟本功能。</p>
<h3 id="delayed-ack">Delayed ACK<a class="headerlink" href="#delayed-ack" title="Permanent link">¶</a></h3>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc1122">RFC-1122</a></li>
<li>相關：<a href="#coalescing">Coalescing</a></li>
</ul>
<p>用來減少網路負荷的，不用每次收到封包都回 ACK，而是：</p>
<ul>
<li>整合達到一定數目後再送一個 ACK；</li>
<li>超過時限，500ms，仍沒收到資料就直接回傳 ACK。</li>
</ul>
<p>Linux 透過 <code>TCP_QUICKACK=1</code> 來關閉本功能。</p>
<h4 id="問題_1">問題<a class="headerlink" href="#問題_1" title="Permanent link">¶</a></h4>
<p>如果搭配 <a href="#coalescing">Coalescing</a> 可能會造成我在等你的 <code>ACK</code> 再繼續送封包，而你在等我的 <code>ACK</code> 才會繼續送封包。</p>
<h3 id="selective-ack">Selective ACK<a class="headerlink" href="#selective-ack" title="Permanent link">¶</a></h3>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc2018">RFC-2018</a></li>
<li><a href="https://blog.csdn.net/wdscq1234/article/details/52503315">參考</a></li>
</ul>
<p>用來避免重複傳送的機制，可以指定特定封包重傳，而不用一直等待最舊的那個重傳。</p>
<h4 id="duplicated">Duplicated<a class="headerlink" href="#duplicated" title="Permanent link">¶</a></h4>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc2883">RFC-2883</a></li>
<li>相關：<a href="#forward-rto">Forward RTO</a></li>
</ul>
<p>透過 SACK 來告知對方我收到了重複的封包，例如：</p>
<p><figure><img alt="告知重複接收了舊封包" src="https://i.imgur.com/KzOierA.png"/><figcaption>告知重複接收了舊封包</figcaption></figure></p>
<p>或者告知舊的封包還沒收到，新的封包已經來了（Out-of-order, OFO），例如：</p>
<p><figure><img alt="舊的封包還沒收到，新的封包已經來了" src="https://i.imgur.com/997qP23.png"/><figcaption>舊的封包還沒收到，新的封包已經來了</figcaption></figure></p>
<h3 id="syn-cookies">SYN Cookies<a class="headerlink" href="#syn-cookies" title="Permanent link">¶</a></h3>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc4987">RFC-4987</a></li>
<li><a href="https://cs.pynote.net/net/tcp/202205052/">參考</a></li>
</ul>
<p>接收方在收到 <code>SYN</code> 時，回傳一個 cookie，
並等到下次收到相應 cookie 的 <code>ACK</code> 後才開始分配記憶體給這個連線。
這樣可以避免大量 <code>SYN</code> 傳入時，每個都分配相應連線的記憶體時，導致的服務忙碌。</p>
<p><figure><img alt="SYN Cookies 流程" src="https://i.imgur.com/rxS0uva.png"/><figcaption>SYN Cookies 流程</figcaption></figure></p>
<h4 id="問題_2">問題<a class="headerlink" href="#問題_2" title="Permanent link">¶</a></h4>
<p>一開始小封包的延遲，可能會造成封包順序的誤判，詳見
<a href="https://wpbolt.com/syn-cookies-ate-my-dog-breaking-tcp-on-linux/">SYN cookies ate my dog</a>。</p>
<!-- ### TLP

https://perthcharles.github.io/2015/10/31/wiki-network-tcp-tlp/ -->
<h3 id="paws">PAWS<a class="headerlink" href="#paws" title="Permanent link">¶</a></h3>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc1323">RFC-1323</a></li>
<li><a href="https://blog.csdn.net/mrpre/article/details/124633999">參考</a></li>
</ul>
<p>PAWS(Protection Against Wrapping Sequence)，是用來避免 <code>SEQ</code> 溢位造成的判斷錯誤。
實作上會使用時間戳記來驗證之。</p>
<p>每個 TCP 封包都會有個 <code>SEQ</code> 號碼來代表之，如果收到舊的 <code>SEQ</code> 號碼就代表這是之前重傳的封包，需要捨棄之，如下圖所示。</p>
<pre class="mermaid"><code>---
title: TCP Sequence Number
---
sequenceDiagram
    Client--&gt;Server: Initialize SEQ as 100
    Client-&gt;&gt;+Server: Length 33, SEQ-100
    Client--&gt;&gt;Network: Length 33, SEQ-100
    Server-&gt;&gt;-Client: ACK-133
    Client-&gt;&gt;+Server: Length 44, SEQ 133
    Server-&gt;&gt;-Client: ACK-177
    Network-&gt;&gt;Server: Length 33, SEQ-100
    Note right of Server: ⚠️Drop!
</code></pre>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>初始化的 <code>SEQ</code> 是隨機產生的，避免被猜到，做出偽造封包的攻擊。</p>
</div>
<p>SEQ 是一個 <span class="arithmatex">\(2^32\)</span> 的值，最大的值約為 43 億，換句話說一條連線如果傳送了 4GB 的資料，就會遇到溢位，然後就會丟棄該封包。
不管這個連線是長連線還是短時間大量資料傳遞。</p>
<pre class="mermaid"><code>---
title: TCP Sequence Number Overflow
---
sequenceDiagram
    Client--&gt;Server: Initialize SEQ as 1G
    Client-&gt;&gt;+Server: Length 1G, SEQ-1G
    Client-&gt;&gt;+Server: Length 1G, SEQ-2G
    Client-&gt;&gt;+Server: Length 1G, SEQ-3G
    Client-&gt;&gt;+Server: Length 1G, SEQ-4G
    Client-&gt;&gt;+Server: Length 1G, SEQ-1G(Overflow)
    Note right of Server: ⚠️Drop!
</code></pre>
<p>於是就開始使用時間戳記（Timestamp, TS）在每個封包上，這樣即時傳大量的資料，仍不會因為溢位而拒絕封包。</p>
<pre class="mermaid"><code>---
title: TCP Sequence Number Overflow
---
sequenceDiagram
    Client--&gt;Server: Initialize SEQ as 1G
    Client-&gt;&gt;+Server: Length 1G, SEQ-1G, TS-1
    Client-&gt;&gt;+Server: Length 1G, SEQ-2G, TS-2
    Client-&gt;&gt;+Server: Length 1G, SEQ-3G, TS-3
    Client-&gt;&gt;+Server: Length 1G, SEQ-4G, TS-4
    Client-&gt;&gt;+Server: Length 1G, SEQ-1G(Overflow), TS-5
    Note right of Server: OK, TS-5 &gt; TS-4
</code></pre>
<p>要注意的是時間戳記的初始值也是隨機產生的。</p>
<h4 id="問題_3">問題<a class="headerlink" href="#問題_3" title="Permanent link">¶</a></h4>
<p>Client-A 的請求通過 SNAT 被轉發到 Server，並以時間戳記 TS-A 訪問並結束連線。
Client-B 的請求在送出請求時如果也因為 SNAT 被使用到相同的 Port，此時 Client-B 可能會因為時間戳記不同而被拒絕。</p>
<h3 id="forward-rto">Forward RTO<a class="headerlink" href="#forward-rto" title="Permanent link">¶</a></h3>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc5682">RFC-5682</a></li>
<li>相關：<a href="#selective-ack">Selective ACK</a></li>
</ul>
<p><figure><img alt="網路延遲，導致錯誤的重新發送，並進而導致 Duplicated ACK" src="https://i.imgur.com/sVyxmKX.png"/><figcaption>網路延遲，導致錯誤的重新發送，並進而導致 Duplicated ACK</figcaption></figure></p>
<p>透過在一段時間內等待當下兩個 <code>ACK</code> 封包，並發現大於重傳的封包，這代表這是虛假重傳。
從而達到避免單純網路延遲導致的錯誤重送。</p>
<p><figure><img alt="當下兩個 ACK 大於重傳的封包，代表這是虛假重傳" src="https://i.imgur.com/1GmOIcc.png"/><figcaption>當下兩個 ACK 大於重傳的封包，代表這是虛假重傳</figcaption></figure></p>
<h3 id="fast-open">Fast Open<a class="headerlink" href="#fast-open" title="Permanent link">¶</a></h3>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc7413">RFC-7413</a></li>
<li><a href="https://kb.nssurge.com/surge-knowledge-base/technotes/tfo">參考</a></li>
</ul>
<p><figure><img alt="Fast Open 可以在第二次連線後省略握手階段" src="https://i.imgur.com/SKvBAHH.png"/><figcaption>Fast Open 可以在第二次連線後省略握手階段</figcaption></figure></p>
<p>接收方和發送方同時紀錄 cookie，並在下次連線時忽略握手階段。</p>
<h3 id="congestion-control">Congestion Control<a class="headerlink" href="#congestion-control" title="Permanent link">¶</a></h3>
<p>避免封包壅塞，TCP 提供幾種演算法：</p>
<ul>
<li><a href="https://github.com/evan361425/evan361425.github.io/issues/34">BBR</a></li>
<li><a href="https://sysctl-explorer.net/net/core/default_qdisc/">Queue-Discipline</a></li>
</ul>
<p>提供的指標：TBD</p>
<h3 id="特殊">特殊<a class="headerlink" href="#特殊" title="Permanent link">¶</a></h3>
<p>一些在指標上看不到的功能。</p>
<h4 id="ecn">ECN<a class="headerlink" href="#ecn" title="Permanent link">¶</a></h4>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc3168">RFC-3168</a></li>
</ul>
<p>使用顯式擁塞通知（Explicit Congestion Notification, ECN）可以測量擁塞的程度。</p>
<h2 id="有用指令">有用指令<a class="headerlink" href="#有用指令" title="Permanent link">¶</a></h2>
<p>查看為什麼 kernel reject 封包（段）：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>netstat<span class="w"> </span>-s<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>reject
<span class="m">416177</span><span class="w"> </span>passive<span class="w"> </span>connections<span class="w"> </span>rejected<span class="w"> </span>because<span class="w"> </span>of<span class="w"> </span><span class="nb">time</span><span class="w"> </span>stamp
<span class="w">    </span><span class="m">13</span><span class="w"> </span>packets<span class="w"> </span>rejects<span class="w"> </span><span class="k">in</span><span class="w"> </span>established<span class="w"> </span>connections<span class="w"> </span>because<span class="w"> </span>of<span class="w"> </span>timestamp
</code></pre></div>
<p>查看封包 kernel 設定：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sysctl<span class="w"> </span>-ae<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">'net\.ipv4\.tcp_'</span>
net.ipv4.tcp_abort_on_overflow<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
...
</code></pre></div>
<h2 id="bsd-socket-api">BSD Socket API<a class="headerlink" href="#bsd-socket-api" title="Permanent link">¶</a></h2>
<p>TCP 在 Berkeley Socket 之上的流程。</p>
<p>Socket 為包裝底層運作的 API，包括 Data Link Layer 和 Network Layer。</p>
<p><figure><img alt="TCP 在 Berkeley Socket 之上的流程，made by OnionBulb" src="https://i.imgur.com/oZrUYJQ.png"/><figcaption>TCP 在 Berkeley Socket 之上的流程，made by OnionBulb</figcaption></figure></p>
<table><caption>各流程簡介</caption>
<thead>
<tr>
<th>名稱</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>Socket</td>
<td>建立 Socket 來監聽（listen）連線</td>
</tr>
<tr>
<td>Bind</td>
<td>綁定 address 和 port，可設定 IP 遮罩</td>
</tr>
<tr>
<td>Listen</td>
<td>監聽 TCP 連線和限制連線數，UDP 不需要呼叫本函式</td>
</tr>
<tr>
<td>Accept</td>
<td>迴圈去接受連線，並進行後續的交握行為</td>
</tr>
</tbody>
</table>
<details class="note">
<summary>實作範例</summary>
<p>綁定 port 和位置（IPv4）後建立連線：</p>
<div class="highlight"><pre><span></span><code><span class="n">bzero</span><span class="p">((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr_in</span><span class="p">));</span>
<span class="n">server</span><span class="p">.</span><span class="n">sin_family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AF_INET</span><span class="p">;</span>
<span class="n">server</span><span class="p">.</span><span class="n">sin_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">htons</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="n">server</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">server</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">"Can't bind name to socket</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">listen</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span><span class="w"> </span><span class="c1">// (1)</span>

<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">client_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
<span class="w">    </span><span class="n">new_sd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accept</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">client_len</span><span class="p">);</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">new_sd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">"Can't accept client</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<ol>
<li>限制最高五個連線</li>
<li>拿 <code>new_sd</code> 去讀寫資料，<code>sd</code> 則繼續監聽連線請求。</li>
</ol>
</details>
<h2 id="問題_4">問題<a class="headerlink" href="#問題_4" title="Permanent link">¶</a></h2>
<details class="question">
<summary>為什麼會有遺失、重複寄送和失序的問題？</summary>
<p>遺失：很可能實際有送到指定位置，但是因為傳輸過程訊號被干擾了，導致<a href="https://notfalse.net/27/tcp-error-control">檢驗和</a>的檢查失敗。</p>
<p>重複寄送：建立在遺失之上的問題，當目的地收到並回傳 <code>ACK</code> 時，發送方很可能沒收到這個訊號，就誤以為沒送成功，就再送一次。</p>
<p>失序：原本是照 1,2,3,... 的順序送出去，收到卻很可能是 3,1,4,...，這可能是因爲壅塞或網路延遲造成的，甚至可能每個封包路由路徑不同（IP 的協定會決定這一系列的封包怎麼送）</p>
</details>
<details class="question">
<summary>當 TCP 連線被開滿了，會發生什麼事？</summary>
<p>需要先定義被開滿了是什麼意思，是部分進入 <code>TIME_WAIT</code> 狀態嗎，還是所有都是 Active 的狀態？</p>
<p>如果是 <code>TIME_WAIT</code> 的狀況可以考慮關閉 <code>TIME_WAIT</code> 的連線。</p>
<p>若都是 Active 的狀態，且資源的允許下則可以考慮用 Virtual IP 建立更多連線，因為 TCP 的每個連線都是以 IP 和 Port 為一個組合。詳見 <a href="https://www.phoenixframework.org/blog/the-road-to-2-million-websocket-connections">The Road to 2 Million Websocket Connections in Phoenix</a>。</p>
</details>
<details class="question">
<summary>如何關閉 TIME_WAIT 狀態的連線？</summary>
<p>你可以賦予該連線一個選項：<a href="http://www.unixguide.net/network/socketfaq/4.5.shtml"><code>SO_REUSEADDR</code></a>，在 Linux 中，你也可以調整 <a href="https://docs.ukcloud.com/articles/vmware/vmw-ref-twreuse.html"><code>TCP_TW_REUSE</code> 或 <code>TCP_TW_RECYCLE</code></a>：</p>
<blockquote>
<p>This socket option tells the kernel that even if this port is busy (in the TIME_WAIT state), go ahead and reuse it anyway. If it is busy, but with another state, you will still get an address already in use error. It is useful if your server has been shut down, and then restarted right away while sockets are still active on its port. You should be aware that if any unexpected data comes in, it may confuse your server, but while this is possible, it is not likely.</p>
</blockquote>
<p>或者調整 Maximum Segment Lifetime(MSL)：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 看一下現在狀態</span>
$<span class="w"> </span>sysctl<span class="w"> </span>net.ipv4.tcp_fin_timeout
<span class="c1"># VI 改</span>
$<span class="w"> </span>vi<span class="w"> </span>/proc/sys/net/ipv4/tcp_fin_timeout
<span class="c1"># Hot reload</span>
$<span class="w"> </span>sysctl<span class="w"> </span>-p<span class="w"> </span>/etc/sysctl.conf
</code></pre></div>
</details>
<details class="question">
<summary>什麼是 TCP Timeout？</summary>
<p>就是應用層的某些 HTTP Client 套件會寫的 Connection Timeout，通常系統層的預設為十分鐘。</p>
</details>
<p>現在有一個狀況：</p>
<ul>
<li>網路頻寬正常偏高，但沒有突破限制。</li>
<li>應用層的資源使用率低，CPU/Mem 維持在 5% 左右。</li>
<li>HTTP 的潛時非常高，數十秒</li>
</ul>
<details class="question">
<summary>請問上述狀況可能的原因？</summary>
<p>當然不能一概而論，不過有遇過這個經驗。那次的原因是因為下游的服務系統層連線數被吃滿了，但是資源使用率仍在正常的水平。</p>
<p>因為系統層連線被吃滿了，所以開始造成服務需要花很多時間才能建立連線（等待其他連線被關閉），同時下游服務會因為 TCP 天生的機制開始反壓（back-pressure），在上游仍會有一定的網路頻寬耗用率。</p>
<p>這時的解決辦法除了前面「當 TCP 連線被開滿了，會發生什麼事？」的解決之道之外，有幾個應用層面的處理機制：</p>
<ul>
<li>新增節點，恩，單純而暴力</li>
<li>分散服務，就是提供微服務</li>
<li>應用程式的調整，因為單一應用請求會打很多個不同資料庫的請求：<ul>
<li>使用<a href="../../../feedback/designing-data-intensive-applications/derived-stream/">事件機制</a>，降低前端需要定期確認資料是否更新</li>
<li>使用快取，並利用快取減少需要和多個資料庫溝通的過程</li>
<li>和資料庫的溝通中增加一個代理器，只需要和他建立連線即可</li>
<li>調整前端應用層協定<ul>
<li><a href="../../../feedback/distributed-systems-with-node.js/protocol/#graphql">GraphQL</a></li>
<li><a href="https://github.com/evan361425/evan361425.github.io/issues/27">HTTP/3</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</details>
<h2 id="referer">Referer<a class="headerlink" href="#referer" title="Permanent link">¶</a></h2>
<p><a href="https://www.rfc-editor.org/info/rfc9293">RFC-9293</a> - TCP，取代過時的 RFC-793, 879, 1011, 1122, 2873, 6093, 6429, 6528, and 6691
<a href="https://www.rfc-editor.org/info/rfc2018">RFC-2018</a> - SACK 說明
<a href="http://www.rfc-editor.org/info/rfc7323">RFC-7323</a> - TCP Options: Window Scale, Timestamp</p>
<p>之前有看到一個 RFC（忘記編號）說明棄用 TCP Timestamp，因為它佔用很多空間，故推薦其他做法，包括使用 TLS。</p>
<aside class="md-source-file">
<span class="md-source-file__fact">
<span class="md-icon" title="最後更新">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"></path></svg>
</span>
<span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2024年7月29日</span>
</span>
<span class="md-source-file__fact">
<span class="md-icon" title="建立日期">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2Z"></path></svg>
</span>
<span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2021年10月14日</span>
</span>
</aside>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"></path></svg>
  回到頂端
</button>
</main>
<footer class="md-footer">
<nav aria-label="頁腳" class="md-footer__inner md-grid">
<a aria-label="上一頁: 網路推薦書籍" class="md-footer__link md-footer__link--prev" href="../network-books/">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</div>
<div class="md-footer__title">
<span class="md-footer__direction">
                上一頁
              </span>
<div class="md-ellipsis">
                網路推薦書籍
              </div>
</div>
</a>
<a aria-label="下一頁: NTP" class="md-footer__link md-footer__link--next" href="../ntp/">
<div class="md-footer__title">
<span class="md-footer__direction">
                下一頁
              </span>
<div class="md-ellipsis">
                NTP
              </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../..", "features": ["search.suggest", "search.highlight", "navigation.top", "navigation.tabs", "navigation.indexes", "navigation.footer", "content.code.annotate", "content.action.edit"], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u8907\u88fd", "clipboard.copy": "\u8907\u88fd", "search.result.more.one": "\u6b64\u9801\u5c1a\u6709 1 \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.more.other": "\u6b64\u9801\u5c1a\u6709 # \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.none": "\u6c92\u6709\u7b26\u5408\u7684\u9805\u76ee", "search.result.one": "\u627e\u5230 1 \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.other": "\u627e\u5230 # \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.placeholder": "\u6253\u5b57\u9032\u884c\u641c\u5c0b", "search.result.term.missing": "\u7f3a\u5c11\u5b57\u8a5e", "select.version": "\u9078\u64c7\u7248\u672c"}}</script>
<script src="../../../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
<script src="../../../javascripts/custom.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@10.4.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script></body>
</html>