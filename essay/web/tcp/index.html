
<!DOCTYPE html>

<html class="no-js" lang="zh-TW">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<meta content="各種紀錄和心得" name="description"/>
<link href="https://evan361425.github.io/essay/web/tcp/" rel="canonical"/>
<link href="../network-books/" rel="prev"/>
<link href="../ntp/" rel="next"/>
<link href="../../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.5.2, mkdocs-material-9.3.1" name="generator"/>
<meta content="COb7MqeOYLfRXXUOsXWaQvnr1_Xb33a0aP_Y8UC3U5Y" name="google-site-verification"/>
<meta content="TCP" property="og:title"/>
<title>TCP - 心得與記錄</title>
<link href="../../../assets/stylesheets/main.046329b4.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.85d0ee34.min.css" rel="stylesheet"/>
<style>
    /**
    * Center the table
    */
    .md-typeset__table {
      margin-left: auto;
      margin-right: auto;
      display: table;
    }

    /**
    * Center the image
    */
    figure img {
      margin-left: auto;
      margin-right: auto;
    }

    .md-typeset :is(.admonition, details) {
      font-size: .8rem;
    }

    /**
    * It will wider than mjx-math and cause screen broken.
    * This element is for screen-reader, see detailed in
    * https://docs.mathjax.org/en/latest/basic/accessibility.html#screen-reader-support
    */
    .MathJax mjx-assistive-mml {
      display: none !important;
    }
    /**
    * Keep zoomed-in image on the top of palette
    */
    .medium-zoom-image--opened {
      z-index: 10;
    }
  </style>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=-apple-system,+BlinkMacSystemFont,+" rel="stylesheet" segoe+ui",+"helvetica+neue",+helvetica,+roboto,+arial,+"pingfang+tc",+"microsoft+jhenghei",+"微軟正黑",+sans-serif,+"apple+color+emoji",+"segoe+ui+emoji",+"segoe+ui+symbol":300,300i,400,400i,700,700i%7croboto+mono:400,400i,700,700i&display='fallback"'/>
<style>:root{--md-text-font:"-apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Helvetica, Roboto, Arial, "PingFang TC", "Microsoft JhengHei", "微軟正黑", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-P67FD9XP83"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-P67FD9XP83",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-P67FD9XP83",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>
<script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
</head>
<body data-md-color-accent="light-blue" data-md-color-primary="indigo" data-md-color-scheme="default" dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#tcp">
          跳轉到
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header" data-md-component="header">
<nav aria-label="頁首" class="md-header__inner md-grid">
<a aria-label="心得與記錄" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="心得與記錄">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            心得與記錄
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              TCP
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="黑夜降臨" class="md-option" data-md-color-accent="light-blue" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="indigo" data-md-color-scheme="default" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_2" hidden="" title="黑夜降臨">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"></path></svg>
</label>
<input aria-label="白日昇起" class="md-option" data-md-color-accent="deep-orange" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="blue-grey" data-md-color-scheme="slate" id="__palette_2" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="白日昇起">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"></path></svg>
</label>
</form>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="搜尋" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="搜尋" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="搜尋" class="md-search__options">
<button aria-label="清除" class="md-search__icon md-icon" tabindex="-1" title="清除" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
<div class="md-search__suggest" data-md-component="search-suggest"></div>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            正在初始化搜尋引擎
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/evan361425/evan361425.github.io" title="前往倉庫">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<nav aria-label="標籤" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../..">
        
  
    
  
  自我介紹

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../feedback/">
          
  
    
  
  心得

        </a>
</li>
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../../">
          
  
    
  
  隨筆

        </a>
</li>
</ul>
</div>
</nav>
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="導覽列" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="心得與記錄" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="心得與記錄">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"></path></svg>
</a>
    心得與記錄
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/evan361425/evan361425.github.io" title="前往倉庫">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
<span class="md-ellipsis">
    自我介紹
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../feedback/">
<span class="md-ellipsis">
    心得
  </span>
</a>
<label class="md-nav__link" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            心得
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_2" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/">
<span class="md-ellipsis">
    Designing Data-intensive Applications
  </span>
</a>
<label class="md-nav__link" for="__nav_2_2">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_2">
<span class="md-nav__icon md-icon"></span>
            Designing Data-intensive Applications
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/foundation-model/">
<span class="md-ellipsis">
    基礎—模型和語法
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/foundation-index/">
<span class="md-ellipsis">
    基礎—索引
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/foundation-dw/">
<span class="md-ellipsis">
    基礎—資料倉儲
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/foundation-encode/">
<span class="md-ellipsis">
    基礎—編碼和進程
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/foundation-ft/">
<span class="md-ellipsis">
    基礎—容錯
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/distributed-replication/">
<span class="md-ellipsis">
    分散式—複製
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/distributed-partition/">
<span class="md-ellipsis">
    分散式—分區
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/distributed-env/">
<span class="md-ellipsis">
    分散式—環境
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/distributed-ft/">
<span class="md-ellipsis">
    分散式—容錯
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/derived-batch/">
<span class="md-ellipsis">
    衍生—批次處理
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/derived-stream/">
<span class="md-ellipsis">
    衍生—串流處理
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/farewell/">
<span class="md-ellipsis">
    總結和整合
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/designing-data-intensive-applications/glossary/">
<span class="md-ellipsis">
    詞彙表
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_3" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../feedback/distributed-systems-with-node.js/">
<span class="md-ellipsis">
    Distributed Systems with Node.js
  </span>
</a>
<label class="md-nav__link" for="__nav_2_3">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_3">
<span class="md-nav__icon md-icon"></span>
            Distributed Systems with Node.js
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/distributed-systems-with-node.js/protocol/">
<span class="md-ellipsis">
    協定
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/distributed-systems-with-node.js/sla-and-load-testing/">
<span class="md-ellipsis">
    SLA 和負載測試
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/distributed-systems-with-node.js/observability/">
<span class="md-ellipsis">
    可觀測性
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/distributed-systems-with-node.js/container/">
<span class="md-ellipsis">
    容器化
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/distributed-systems-with-node.js/container-orchestration-and-misc/">
<span class="md-ellipsis">
    容器調度工具和其他
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_4" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../feedback/future-of-fusion-energy/">
<span class="md-ellipsis">
    （WIP）Future Of Fusion Energy
  </span>
</a>
<label class="md-nav__link" for="__nav_2_4">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_4">
<span class="md-nav__icon md-icon"></span>
            （WIP）Future Of Fusion Energy
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/future-of-fusion-energy/energy/">
<span class="md-ellipsis">
    能源
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/future-of-fusion-energy/fusion/">
<span class="md-ellipsis">
    核融合
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_5" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../feedback/site-reliability-workbook/">
<span class="md-ellipsis">
    （WIP）SRE Workbook
  </span>
</a>
<label class="md-nav__link" for="__nav_2_5">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_5">
<span class="md-nav__icon md-icon"></span>
            （WIP）SRE Workbook
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/site-reliability-workbook/toil/">
<span class="md-ellipsis">
    勞動力
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/site-reliability-workbook/simplicity/">
<span class="md-ellipsis">
    簡化系統
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/site-reliability-workbook/legacy-system/">
<span class="md-ellipsis">
    處理舊有系統
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/site-reliability-workbook/on-call/">
<span class="md-ellipsis">
    待命小組
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/site-reliability-workbook/incident-response/">
<span class="md-ellipsis">
    災難管理
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/site-reliability-workbook/postmortem-culture/">
<span class="md-ellipsis">
    事後析誤文化
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/site-reliability-workbook/managing-load/">
<span class="md-ellipsis">
    負載管理
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/site-reliability-workbook/nalsd/">
<span class="md-ellipsis">
    非抽象大型系統設計
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/site-reliability-workbook/data-pipelines/">
<span class="md-ellipsis">
    資料管線設計
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/site-reliability-workbook/configuration-best-practice/">
<span class="md-ellipsis">
    設定檔的最佳實踐
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/site-reliability-workbook/canary-release/">
<span class="md-ellipsis">
    金絲雀部署
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/release-it/">
<span class="md-ellipsis">
    Release It!
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/adaptive-concurrency/">
<span class="md-ellipsis">
    Adaptive Concurrency
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2_8" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../../feedback/physics/">
<span class="md-ellipsis">
    Physics
  </span>
</a>
<label class="md-nav__link" for="__nav_2_8">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="false" aria-labelledby="__nav_2_8_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_8">
<span class="md-nav__icon md-icon"></span>
            Physics
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/physics/astronomy/">
<span class="md-ellipsis">
    天文學
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../feedback/physics/special-relativity/">
<span class="md-ellipsis">
    （WIP）狹義相對論
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<div class="md-nav__link md-nav__container">
<a class="md-nav__link" href="../../">
<span class="md-ellipsis">
    隨筆
  </span>
</a>
<label class="md-nav__link" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-expanded="true" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            隨筆
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../2022-ai-review/">
<span class="md-ellipsis">
    2022 AI 回顧
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
<span class="md-ellipsis">
    系統架構類
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_3">
<span class="md-nav__icon md-icon"></span>
            系統架構類
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/made-container/">
<span class="md-ellipsis">
    如何製作 Docker Container
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/pki-checklist/">
<span class="md-ellipsis">
    建置 PKI 注意事項
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/replace-docker-desktop/">
<span class="md-ellipsis">
    取代 Docker Desktop
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/tomcat-max-packet-size/">
<span class="md-ellipsis">
    Tomcat 的 max_packet_size
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../architecture/tcp-socket-loss-after-dhcp/">
<span class="md-ellipsis">
    TCP socket 連線被清除的錯誤排查
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
<span class="md-ellipsis">
    程式語言類
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_4">
<span class="md-nav__icon md-icon"></span>
            程式語言類
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../code/node.js-best-practice/">
<span class="md-ellipsis">
    Node.js 最佳實作
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../code/node.js-error/">
<span class="md-ellipsis">
    Node.js 的錯誤有哪些
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../code/object-oriented-terms/">
<span class="md-ellipsis">
    物件導向名詞
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_3_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
<span class="md-ellipsis">
    網路相關
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_3_5_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_5">
<span class="md-nav__icon md-icon"></span>
            網路相關
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../network-routing/">
<span class="md-ellipsis">
    網路怎麼傳
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../network-details/">
<span class="md-ellipsis">
    網路傳了什麼
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../network-books/">
<span class="md-ellipsis">
    網路推薦書籍
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
<span class="md-ellipsis">
    TCP
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
<span class="md-ellipsis">
    TCP
  </span>
</a>
<nav aria-label="目錄" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      目錄
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#osi-中扮演的角色">
    OSI 中扮演的角色
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#內容物">
    內容物
  </a>
<nav aria-label="內容物" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#tcp-信號">
    TCP 信號
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#三次握手">
    三次握手
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#四次揮手">
    四次揮手
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tcp-選項">
    TCP 選項
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#congestion-control">
    Congestion Control
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#範例">
    範例
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#有用指令">
    有用指令
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#bsd-socket-api">
    BSD Socket API
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#問題">
    問題
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#referer">
    Referer
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../ntp/">
<span class="md-ellipsis">
    NTP
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../http/">
<span class="md-ellipsis">
    HTTP
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../retry-strategy/">
<span class="md-ellipsis">
    Retry 的策略
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../certificate-transparency/">
<span class="md-ellipsis">
    Certificate Transparency
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../url-structure/">
<span class="md-ellipsis">
    URL 長什麼樣子
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
<span class="md-ellipsis">
    網路安全
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_6_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_6">
<span class="md-nav__icon md-icon"></span>
            網路安全
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../web-security/cross-origin-resources-sharing/">
<span class="md-ellipsis">
    CORS
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../web-security/mixed-content/">
<span class="md-ellipsis">
    Mixed Content
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../web-security/owasp-api-top10/">
<span class="md-ellipsis">
    OWASP API Top 10
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../web-security/owasp-authentication-best-practice/">
<span class="md-ellipsis">
    OWASP 驗證機制最佳指南
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../web-security/owasp-mobile-risk-top10/">
<span class="md-ellipsis">
    OWASP 行動裝置風險
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3_7" type="checkbox"/>
<label class="md-nav__link" for="__nav_3_7" id="__nav_3_7_label" tabindex="0">
<span class="md-ellipsis">
    其他
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_7_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_3_7">
<span class="md-nav__icon md-icon"></span>
            其他
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../gpl-check/">
<span class="md-ellipsis">
    GPL 的檢查
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../nginx-changelog/">
<span class="md-ellipsis">
    Nginx 1.18 到 1.22 的差異
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../node-changelog-14-18/">
<span class="md-ellipsis">
    Node.js 14 到 18 的差異
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../questionnaire-principal/">
<span class="md-ellipsis">
    問卷設計指南
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="目錄" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      目錄
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#osi-中扮演的角色">
    OSI 中扮演的角色
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#內容物">
    內容物
  </a>
<nav aria-label="內容物" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#tcp-信號">
    TCP 信號
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#三次握手">
    三次握手
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#四次揮手">
    四次揮手
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#tcp-選項">
    TCP 選項
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#congestion-control">
    Congestion Control
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#範例">
    範例
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#有用指令">
    有用指令
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#bsd-socket-api">
    BSD Socket API
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#問題">
    問題
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#referer">
    Referer
  </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<a class="md-content__button md-icon" href="https://github.com/evan361425/evan361425.github.io/blob/master/src/essay/web/tcp.md" title="編輯此頁">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5m-7.86-1.75L8.85 19l.29-.74C10.43 15.06 13.5 13 17 13c1.05 0 2.06.21 3 .56V8l-6-6H6c-1.11 0-2 .89-2 2v16a2 2 0 0 0 2 2h4.5c-.55-.66-1-1.42-1.36-2.25M13 3.5 18.5 9H13V3.5Z"></path></svg>
</a>
<h1 id="tcp">TCP<a class="headerlink" href="#tcp" title="Permanent link">¶</a></h1>
<p>Transmission Control Protocol 傳輸控制協定的作用說明。</p>
<h2 id="osi-中扮演的角色">OSI 中扮演的角色<a class="headerlink" href="#osi-中扮演的角色" title="Permanent link">¶</a></h2>
<p>Network 之上，Application 之下。</p>
<p>Network 中的 IP 是一種不考慮連線的協定，他只需要負責把封包路由給指定的目的地。在此之上的 TCP
則會透過類似於 HTTP session 的機制，反復確認段（segment）裡的訊號和編號來確保兩端的連線。</p>
<p>換句話說，TCP 是被設計成雙向（bidirectional）、序列性（ordered）和可靠（reliable）的資料傳輸協定。</p>
<ul>
<li>可靠：透過反覆寄送確認信號（Acknowledge，或簡稱 ACK）</li>
<li>序列：透過 Sequence(或簡稱 SEQ) 和 Acknowledgement（）的編號確認順序</li>
<li>雙向：開啟連線時，這個連線雙方都可以寫入和讀取的</li>
</ul>
<h2 id="內容物">內容物<a class="headerlink" href="#內容物" title="Permanent link">¶</a></h2>
<p><figure><img alt="TCP 標頭格式" src="https://i.imgur.com/3nh6DOI.png"/><figcaption>TCP 標頭格式<br/>來源於：<a href="https://notfalse.net/26/tcp-seq">鄭中勝</a></figcaption></figure></p>
<p>TCP 會透過上述各種編號和訊號來完成連線所需的溝通。當建立連線（三次握手）後，雙方就不存在監聽方和發起方。兩者皆可以做監聽和送訊息，同時雙方也都可以要求中斷連線，並且雙方都要同意關閉才能真正完整關閉連線（四次揮手）。其完整生命的程如下：</p>
<p><figure><img alt="TCP 狀態流程" src="https://imgur.com/jeS7mge.png"/><figcaption>TCP 狀態流程</figcaption></figure></p>
<p>各個信號（Flags）代表意義下段展示。</p>
<h3 id="tcp-信號">TCP 信號<a class="headerlink" href="#tcp-信號" title="Permanent link">¶</a></h3>
<p>不同的 TCP 信號代表這個 TCP 段（segment）的意義是什麼，
以下依照該信號在封包的位置順序來排列：</p>
<ul>
<li>Reserved</li>
<li>Accurate echo</li>
<li>Congestion Window Reduced</li>
<li>Echo, ECH</li>
<li>Urgent, URG<ul>
<li>緊急的封包，告知接收方這個封包不需要進入佇列（queue），請直接處理</li>
<li>會出現的場景還沒看過</li>
</ul>
</li>
<li>Acknowledgment, ACK<ul>
<li>通常用來告知對方，我收到你剛剛傳的信號了；</li>
<li>有時會夾帶其他信號，表明同意某些要求，
    例如 SYN+ACK 代表我收到你的連線要求，並且同意你的連線</li>
</ul>
</li>
<li>Push, PSH<ul>
<li>添加這個信號代表接收方不需要做暫存，可以直接把資料往上傳遞</li>
<li>通常用在小段的資料，因為大資料會被分成多段，然後會有順序議題</li>
</ul>
</li>
<li>Reset, RST，已經捨棄的連線又收到訊號（例如 ACK），就會回傳<ul>
<li>埠不存在，通常是因為你請求的埠沒被打開；</li>
<li>IP 不存在，通常是因為你監聽的 IP 不是 <code>0.0.0.0:port</code>；</li>
<li>連線被棄用，對方（接收者）會出現 Connection closed by peer 的錯誤；</li>
<li>對方的佇列（queue）已經滿了；</li>
<li>防火牆清除了 session table，導致不認識這段連線，就可能回傳該訊號。</li>
</ul>
</li>
<li>Synchronize, SYN<ul>
<li>開啟連線</li>
<li>被動方會和 ACK 一起搭配</li>
</ul>
</li>
<li>Finish, FIN<ul>
<li>結束連線</li>
<li>被動方會和 ACK 一起搭配</li>
</ul>
</li>
</ul>
<h3 id="三次握手">三次握手<a class="headerlink" href="#三次握手" title="Permanent link">¶</a></h3>
<p><figure><img alt="三次握手的範例" src="https://i.imgur.com/tsr9hCN.png"/><figcaption>三次握手的範例<br/>來源於：<a href="https://notfalse.net/26/tcp-seq">鄭中勝</a></figcaption></figure></p>
<p>彼此會在三次握手中確認接下來的 <code>SEQ</code> 號碼：</p>
<ul>
<li>主動方（或稱發起方、客戶端）送出要求連線的同步信號（Synchronous 或稱 SYN）</li>
<li>監聽方（或稱服務端、私服端）允許連線（ACK）並同樣賦予同步信號（SYN）</li>
<li>主動方允許連線</li>
</ul>
<h3 id="四次揮手">四次揮手<a class="headerlink" href="#四次揮手" title="Permanent link">¶</a></h3>
<p>主動關閉（Active Close）的那方可以根據需求關閉連線，但是對被動關閉（Passive Close）的那方來說，傳送的資料可能還沒完成，這時就需要等應用層資料都送出去之後，才會再一次做關閉的動作。</p>
<p><figure><img alt="TCP 四次揮手流程" src="https://i.imgur.com/qFzjzri.png"/><figcaption>TCP 四次揮手流程</figcaption></figure></p>
<p>所以流程大致如下：</p>
<ul>
<li><em>主動方</em> 要求關閉連線 <code>FIN</code>，並進入 <code>FIN_WAIT1</code> 狀態。</li>
<li><em>被動方</em> 告知收到這個資訊 <code>ACK</code>。</li>
<li><em>主動方</em> 進入等待 <code>FIN_WAIT2</code> 狀態。</li>
<li><em>被動方</em> 確保資料都送完後，關閉連線 <code>FIN</code>。</li>
<li><em>主動方</em> 告知收到這個資訊 <code>ACK</code>，此時被動方不用管有沒有收到這個 <code>ACK</code>。</li>
<li><em>主動方</em> 進入 <code>TIME_WAIT</code> 狀態，等到超過兩次 MSL（Maximum Segment Lifetime）的時間後，關閉連線。</li>
</ul>
<p>這時你就會注意到一件事，身為主動關閉的那方，是需要付出代價的！他需要進入等待對方關閉的狀態（<code>FIN WAIT 1</code> 或 <code>FIN WAIT 2</code>）；相較而言，被動那方就只要確認關閉後，就可以瀟灑說再見了。</p>
<p>之所以要進入 <code>TIME_WAIT</code> 這個狀態是因為如果直接使用這個來源埠，下次的連線很可能會收到上次連線的重送（Retransmission）資訊。</p>
<h3 id="tcp-選項">TCP 選項<a class="headerlink" href="#tcp-選項" title="Permanent link">¶</a></h3>
<p>TCP 選項（TCP Option）大部分都是在握手階段確認的，
<a href="https://www.geeksforgeeks.org/options-field-in-tcp-header/">詳見</a>：</p>
<ul>
<li>0: End of options</li>
<li>1: no-op</li>
<li>2: MSS(Maximum TCP Segment Size)，協商段的大小</li>
<li>3: Window Scaling，提高客戶端可用頻寬</li>
<li>4: SACK（Selective ACK），避免每次都要等超時才重傳，且只重傳丟失的封包，用來加速重傳的機制</li>
<li>8: Timestamp，精準 RTT</li>
<li>34: TFO（TCP Fast Open）</li>
</ul>
<p>Kernel options 可以參考 <a href="https://sysctl-explorer.net/net/">sysctl-explorer</a></p>
<ul>
<li><code>TCP_NODELAY</code>：啟用時，當資料大於 MSS，就送出；反之則累積直到收到上一個封包的 ACK。
    缺點自然就是如果應用程式本身就是小資料送出（例如 Streaming），就會常常體驗到延遲。
    除此之外，如果對方也啟用，就可能會有鎖死（deadlock）的狀況，兩邊都在等 ACK。</li>
<li><code>TCP_CORK</code>：啟用時，只有當累積到一定的量才會送出（限制在 200ms 以下），和 <code>TCP_NODELAY</code> 差在一個是等 ACK 一個是等量到一定程度。
    當你在送出大量資料時，這會很有用，但是請小心服用。</li>
</ul>
<h3 id="congestion-control">Congestion Control<a class="headerlink" href="#congestion-control" title="Permanent link">¶</a></h3>
<p><a href="https://github.com/evan361425/evan361425.github.io/issues/34">BBR</a>, <a href="https://sysctl-explorer.net/net/core/default_qdisc/">Queue-Discipline</a></p>
<h3 id="範例">範例<a class="headerlink" href="#範例" title="Permanent link">¶</a></h3>
<p>以連線到 google.com 中產生的多個封包做說明。</p>
<blockquote>
<p>如果是 HTTP/3 就不是 TCP 了，到時要看看用什麼網站比較好。</p>
</blockquote>
<h4 id="三次握手_1">三次握手<a class="headerlink" href="#三次握手_1" title="Permanent link">¶</a></h4>
<p>MSS(Maximum TCP Segment Size) v.s. MTU(Maximum Transmission Unit):</p>
<div class="highlight"><pre><span></span><code>MTU = MSS + 40 (IP header + TCP header)
</code></pre></div>
<h4 id="sequence-number">SEQuence number<a class="headerlink" href="#sequence-number" title="Permanent link">¶</a></h4>
<p>TBD</p>
<h4 id="acknowledge-number">ACKnowledge number<a class="headerlink" href="#acknowledge-number" title="Permanent link">¶</a></h4>
<p>TBD</p>
<h4 id="options">Options<a class="headerlink" href="#options" title="Permanent link">¶</a></h4>
<p>TBD</p>
<h2 id="有用指令">有用指令<a class="headerlink" href="#有用指令" title="Permanent link">¶</a></h2>
<p>查看為什麼 kernel reject 封包（段）：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>netstat<span class="w"> </span>-s<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>reject
<span class="m">416177</span><span class="w"> </span>passive<span class="w"> </span>connections<span class="w"> </span>rejected<span class="w"> </span>because<span class="w"> </span>of<span class="w"> </span><span class="nb">time</span><span class="w"> </span>stamp
<span class="w">    </span><span class="m">13</span><span class="w"> </span>packets<span class="w"> </span>rejects<span class="w"> </span><span class="k">in</span><span class="w"> </span>established<span class="w"> </span>connections<span class="w"> </span>because<span class="w"> </span>of<span class="w"> </span>timestamp
</code></pre></div>
<p>查看封包 kernel 設定：</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>sysctl<span class="w"> </span>-ae<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">'net\.ipv4\.tcp_'</span>
net.ipv4.tcp_abort_on_overflow<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>
...
</code></pre></div>
<h2 id="bsd-socket-api">BSD Socket API<a class="headerlink" href="#bsd-socket-api" title="Permanent link">¶</a></h2>
<p>TCP 在 Berkeley Socket 之上的流程。</p>
<p>Socket 為包裝底層運作的 API，包括 Data Link Layer 和 Network Layer。</p>
<p><figure><img alt="TCP 在 Berkeley Socket 之上的流程，made by OnionBulb" src="https://i.imgur.com/oZrUYJQ.png"/><figcaption>TCP 在 Berkeley Socket 之上的流程，made by OnionBulb</figcaption></figure></p>
<table><caption>各流程簡介</caption>
<thead>
<tr>
<th>名稱</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>Socket</td>
<td>建立 Socket 來監聽（listen）連線</td>
</tr>
<tr>
<td>Bind</td>
<td>綁定 address 和 port，可設定 IP 遮罩</td>
</tr>
<tr>
<td>Listen</td>
<td>監聽 TCP 連線和限制連線數，UDP 不需要呼叫本函式</td>
</tr>
<tr>
<td>Accept</td>
<td>迴圈去接受連線，並進行後續的交握行為</td>
</tr>
</tbody>
</table>

<details class="note">
<summary>實作範例</summary>
<p>綁定 port 和位置（IPv4）後建立連線：</p>
<div class="highlight"><pre><span></span><code><span class="n">bzero</span><span class="p">((</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr_in</span><span class="p">));</span>
<span class="n">server</span><span class="p">.</span><span class="n">sin_family</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AF_INET</span><span class="p">;</span>
<span class="n">server</span><span class="p">.</span><span class="n">sin_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">htons</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="n">server</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">server</span><span class="p">))</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">"Can't bind name to socket</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="n">listen</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span><span class="w"> </span><span class="c1">// (1)</span>

<span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">client_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
<span class="w">    </span><span class="n">new_sd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">accept</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">client_len</span><span class="p">);</span><span class="w"> </span><span class="c1">// (2)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">new_sd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">"Can't accept client</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="w">        </span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>
<ol>
<li>限制最高五個連線</li>
<li>拿 <code>new_sd</code> 去讀寫資料，<code>sd</code> 則繼續監聽連線請求。</li>
</ol>
</details>
<h2 id="問題">問題<a class="headerlink" href="#問題" title="Permanent link">¶</a></h2>
<details class="question">
<summary>為什麼會有遺失、重複寄送和失序的問題？</summary>
<p>遺失：很可能實際有送到指定位置，但是因為傳輸過程訊號被干擾了，導致<a href="https://notfalse.net/27/tcp-error-control">檢驗和</a>的檢查失敗。</p>
<p>重複寄送：建立在遺失之上的問題，當目的地收到並回傳 <code>ACK</code> 時，發送方很可能沒收到這個訊號，就誤以為沒送成功，就再送一次。</p>
<p>失序：原本是照 1,2,3,... 的順序送出去，收到卻很可能是 3,1,4,...，這可能是因爲壅塞或網路延遲造成的，甚至可能每個封包路由路徑不同（IP 的協定會決定這一系列的封包怎麼送）</p>
</details>
<details class="question">
<summary>當 TCP 連線被開滿了，會發生什麼事？</summary>
<p>需要先定義被開滿了是什麼意思，是部分進入 <code>TIME_WAIT</code> 狀態嗎，還是所有都是 Active 的狀態？</p>
<p>如果是 <code>TIME_WAIT</code> 的狀況可以考慮關閉 <code>TIME_WAIT</code> 的連線。</p>
<p>若都是 Active 的狀態，且資源的允許下則可以考慮用 Virtual IP 建立更多連線，因為 TCP 的每個連線都是以 IP 和 Port 為一個組合。詳見 <a href="https://www.phoenixframework.org/blog/the-road-to-2-million-websocket-connections">The Road to 2 Million Websocket Connections in Phoenix</a>。</p>
</details>
<details class="question">
<summary>如何關閉 TIME_WAIT 狀態的連線？</summary>
<p>你可以賦予該連線一個選項：<a href="http://www.unixguide.net/network/socketfaq/4.5.shtml"><code>SO_REUSEADDR</code></a>，在 Linux 中，你也可以調整 <a href="https://docs.ukcloud.com/articles/vmware/vmw-ref-twreuse.html"><code>TCP_TW_REUSE</code> 或 <code>TCP_TW_RECYCLE</code></a>：</p>
<blockquote>
<p>This socket option tells the kernel that even if this port is busy (in the TIME_WAIT state), go ahead and reuse it anyway. If it is busy, but with another state, you will still get an address already in use error. It is useful if your server has been shut down, and then restarted right away while sockets are still active on its port. You should be aware that if any unexpected data comes in, it may confuse your server, but while this is possible, it is not likely.</p>
</blockquote>
<p>或者調整 Maximum Segment Lifetime(MSL)：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 看一下現在狀態</span>
$<span class="w"> </span>sysctl<span class="w"> </span>net.ipv4.tcp_fin_timeout
<span class="c1"># VI 改</span>
$<span class="w"> </span>vi<span class="w"> </span>/proc/sys/net/ipv4/tcp_fin_timeout
<span class="c1"># Hot reload</span>
$<span class="w"> </span>sysctl<span class="w"> </span>-p<span class="w"> </span>/etc/sysctl.conf
</code></pre></div>
</details>
<details class="question">
<summary>什麼是 TCP Timeout？</summary>
<p>就是應用層的某些 HTTP Client 套件會寫的 Connection Timeout，通常系統層的預設為十分鐘。</p>
</details>
<p>現在有一個狀況：</p>
<ul>
<li>網路頻寬正常偏高，但沒有突破限制。</li>
<li>應用層的資源使用率低，CPU/Mem 維持在 5% 左右。</li>
<li>HTTP 的延時非常高，數十秒</li>
</ul>
<details class="question">
<summary>請問上述狀況可能的原因？</summary>
<p>當然不能一概而論，不過有遇過這個經驗。那次的原因是因為下游的服務系統層連線數被吃滿了，但是資源使用率仍在正常的水平。</p>
<p>因為系統層連線被吃滿了，所以開始造成服務需要花很多時間才能建立連線（等待其他連線被關閉），同時下游服務會因為 TCP 天生的機制開始反壓（back-pressure），在上游仍會有一定的網路頻寬耗用率。</p>
<p>這時的解決辦法除了前面「當 TCP 連線被開滿了，會發生什麼事？」的解決之道之外，有幾個應用層面的處理機制：</p>
<ul>
<li>新增節點，恩，單純而暴力</li>
<li>分散服務，就是提供微服務</li>
<li>應用程式的調整，因為單一應用請求會打很多個不同資料庫的請求：<ul>
<li>使用<a href="../../../feedback/designing-data-intensive-applications/derived-stream/">事件機制</a>，降低前端需要定期確認資料是否更新</li>
<li>使用快取，並利用快取減少需要和多個資料庫溝通的過程</li>
<li>和資料庫的溝通中增加一個代理器，只需要和他建立連線即可</li>
<li>調整前端應用層協定<ul>
<li><a href="../../../feedback/distributed-systems-with-node.js/protocol/#graphql">GraphQL</a></li>
<li><a href="https://github.com/evan361425/evan361425.github.io/issues/27">HTTP/3</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</details>
<h2 id="referer">Referer<a class="headerlink" href="#referer" title="Permanent link">¶</a></h2>
<p><a href="https://www.rfc-editor.org/info/rfc9293">RFC-9293</a> - TCP，取代過時的 RFC-793, 879, 1011, 1122, 2873, 6093, 6429, 6528, and 6691
<a href="https://www.rfc-editor.org/info/rfc2018">RFC-2018</a> - SACK 說明
<a href="http://www.rfc-editor.org/info/rfc7323">RFC-7323</a> - TCP Options: Window Scale, Timestamp</p>
<p>之前有看到一個 RFC（忘記編號）說明棄用 TCP Timestamp，因為它佔用很多空間，故推薦其他做法，包括使用 TLS。</p>
<hr/>
<div class="md-source-file">
<small>
    
      最後更新:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2023年3月30日</span>
<br/>
        建立日期:
        <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2021年10月14日</span>
</small>
</div>
</article>
</div>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"></path></svg>
            回到頂端
          </button>
</main>
<footer class="md-footer">
<nav aria-label="頁腳" class="md-footer__inner md-grid">
<a aria-label="上一頁: 網路推薦書籍" class="md-footer__link md-footer__link--prev" href="../network-books/" rel="prev">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</div>
<div class="md-footer__title">
<span class="md-footer__direction">
                上一頁
              </span>
<div class="md-ellipsis">
                網路推薦書籍
              </div>
</div>
</a>
<a aria-label="下一頁: NTP" class="md-footer__link md-footer__link--next" href="../ntp/" rel="next">
<div class="md-footer__title">
<span class="md-footer__direction">
                下一頁
              </span>
<div class="md-ellipsis">
                NTP
              </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../..", "features": ["search.suggest", "search.highlight", "navigation.top", "navigation.tabs", "navigation.indexes", "navigation.footer", "content.code.annotate", "content.action.edit"], "search": "../../../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "\u5df2\u8907\u88fd", "clipboard.copy": "\u8907\u88fd", "search.result.more.one": "\u6b64\u9801\u5c1a\u6709 1 \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.more.other": "\u6b64\u9801\u5c1a\u6709 # \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.none": "\u6c92\u6709\u7b26\u5408\u7684\u9805\u76ee", "search.result.one": "\u627e\u5230 1 \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.other": "\u627e\u5230 # \u500b\u7b26\u5408\u7684\u9805\u76ee", "search.result.placeholder": "\u6253\u5b57\u9032\u884c\u641c\u5c0b", "search.result.term.missing": "\u7f3a\u5c11\u5b57\u8a5e", "select.version": "\u9078\u64c7\u7248\u672c"}}</script>
<script src="../../../assets/javascripts/bundle.dff1b7c8.min.js"></script>
<script src="../../../javascripts/custom.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js"></script>
</body>
</html>