---
tags: SRE-workbook
---

# 災難管理

災難管理和災難處理的差異在於：
處理災難代表減輕衝擊或（且）把服務恢復到以前的狀態，
而災難管理代表以有效的方式協調團隊的工作，並確保溝通（包含對外）管道的暢通。

很多事情都會有意外事件發生，不管是森林野火、火車翻覆、食品衛生新聞等等。
在面對緊急事件時，最好的處理辦法就是事前練習並規劃好有系統的指南。
即使發生了沒遇過的狀況，透過 *提前的分工* 和 *工作的結構化*，
將會讓處理人員有個依託並較為冷靜面對。

> 緊急事件的處理框架可以參考
> [PagerDuty Incident Response](https://response.pagerduty.com/)。

分工基本上分為兩大部分：*溝通* 和 *處理*。
透過主要指揮官（Incident Commander, IC）、
溝通領導（Communications Lead, CL）和處理領導（Operations Lead, Ops Lead, OL），
把相關工作劃分好。

IC 的工作保括：

-   確保命令的單一性，一個人不會聽命於 A 又同時聽命於 B；
-   分配好各個角色（包含 CL 和 OL）且角色功能定義明確，並預設所有角色還未指派；
-   所做的所有事情都做好記錄，包括除錯、介入行為等等（幫助未來思考可優化的項目）；
-   儘早並定期的宣告事件狀況，並確保溝通管道的暢通。

如果事件夠大，IC 可能會把溝通的任務指派給一個 CL，除此之外，他可能還會有這些職責：

-   統一的對外窗口，回答所有關切性問題；
-   定期整理並匯報事件給高層、全公司等等。

OL 則是專注在：

-   問題的查找；
-   急救方案的判定；
-   協助找出根治的方法。

## 儘早宣告事件

Google Home（以下簡稱 GH）是一個智能管家，當你需要請他處理事情時，例如打開客廳電燈，
需要先觸發關鍵字（*hotword*），例如 *OK Google*。
每個人在說這個關鍵字時，可能的語調和口氣都不一樣，故而使用者需要提供訓練素材來幫助辨識。
這個素材會被存放在雲端，但是訓練結果的參數會放在客戶的裝置上，
故而 GH 會需要定期去和 server 取得訓練結果。

在一次版本更新（v1.88）中，裡面有一個錯誤會導致 GH 去跟 server 要的次數變成一般的 50 倍。
在 5 月 22 號禮拜一中，
一個待命小組成為 Jasper 觀察到每秒存取量（queries per second, QPS）變高了，
故而暫停新版本的推廣，讓他停在 25% 的推廣比例（也就是線上有四分之一的用戶使用新版本）。
Jasper 開票追蹤這個異常狀態，並備註短時間的存取量來到一般情況的 50 倍。

開發者 Melinda 把這個問題連結到之前的某一張舊的票，
這個舊的票是在說明 GH 每次刷新登入狀態都會不被預期的去存取一次關鍵字的訓練結果，
而這個錯誤預期會在這次版本更新（v1.88）中被解決，
所以最終認為這個異常流量應該會是暫時性的問題，所以把流量限制拉大，並提高推廣程度。

當服務在 5 月 31 號禮拜三被推廣到 50% 時，他們發現這問題的根因並不是預期的舊錯誤，
因為提高推廣程度應該讓這個流量下降，但是卻上升了。
同一天，客服開始收到一些回報，說明 GH 在啟動時收到錯誤訊息，
而這個錯誤訊息經過開發團隊確認正是觸發限流導致的錯誤狀態。
他們再一次的把流量限制拉大，紓緩了錯誤發生，並進一步追蹤這個錯誤原因。
雖然這個錯誤是後端開發看到的錯誤，但是因為這是前端開發製造的錯誤，
所以在追蹤初期朝著的方向完全是錯誤的，也加上這個錯誤並沒有被提高等級到事件（incident），
所以前後端開發者的溝通仍有限。

開發著開始嘗試在新版本中加上一些日誌，來幫助排查問題，但是因為流量限制開大的關係，
沒有任何使用者回報限流的錯誤狀態，故而決定進一步提高推廣度。
當他們在 6 月 3 號禮拜六把推廣度提高到 100% 時，客服開始收到部分的錯誤回報，
儘管收到錯誤回報，因為在週末，開發團隊仍沒有把這錯誤提升到事件，
並依照正常處理錯誤的流程，在開票追蹤系統討論和處理。

到了隔天週日，由於錯誤回報持續上升，開發團隊終於把這個錯誤提升到最高層級，
由於錯誤率上升，待命小組請求 SRE 團隊把節點數拉大（提升負載能力）並將流量導引到新的節點，
但因為是限流錯誤，所以即使拉高負載，新的節點仍會拒絕處理高併發的單一使用者請求，
故而把問題更聚焦在限流的原因上面。
最終專案管理員再一次請求提高限流後，問題被舒緩，同時開發者也在集中溝通的情況下暸解彼此狀況，
並進一步排查出根因。

### 事後分析

因為開發者在週末仍致力於處理這個問題，所以即使在週末，這問題仍被解決了，
但這並不是一個好的處理問題方式，因為最終我們都希望公司成為一個能替員工平衡工作和生活的地方。

第一個，不要在週末把推廣程度拉高。
再來，處理問題第一步通常都是避免錯誤繼續擴散，
當錯誤狀況被紓緩時，應該要專注於排查問題的根因，而不是繼續推廣新版本。
最後，當問題排查不清時，應該將錯誤提升到事件，並召集相關人士一起來處理，這樣可以避免：

-   溝通壁壘，錯誤追蹤系統並不是良好的溝通橋樑；
-   不同角度的看待事情，會加速錯誤的排查；
-   讓不同部門的同仁面對線上錯誤有進一步的心理準備。

集中化的討論是解決事件的核心，例如召集一群人坐在一個會議室或者一場線上會議，並即時的討論和面對。
