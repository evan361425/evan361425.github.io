---
tags: SRE-workbook
---

# 事後析誤文化

在本書描述中，事後析誤是一個在 Google 中非常重要的文化（事後析誤並不是什麼新科技，而是文化）。
其核心的概念是：析誤過程中不要帶著責備。
好的事後析誤文化，會讓失誤減少，工作更高效和快樂，並減少重複性錯誤，加快錯誤恢復。
而本篇的重點則是要傳達一個訊息：推廣事後析誤文化是可行的！

以下文章將分為三大塊：

-   比較壞的和好的事後析誤文件
-   建立強健的事後析誤文化和辨識一些可能造成破壞的跡象
-   一個工具和樣板幫助開始建立

## 邊緣快取和代理器的失能

雖然 Google 大部分的伺服器都位於自己管理的資料中心，但仍會在一些地區使用租借的資料中心，
使用託管服務（Colocation centre）建立快取（cache）和代理器（proxy），
而這類的機器在 Google 內部，稱其為 *衛星*（*satellites*）。

Google 對於維運設備的運行，大部分都是依靠自動化的，
包括新機器的軟體安裝、退役、版本升級、流量洩流（drain）等等。
其中退役時的自動化稱其為 *磁碟抹除*（*dsikerase*），
一旦機器被抹除，儲存的所有資料將無法再被獲取。
而這端自動化的邏輯大致如下：

```javascript
// 得到指定資料中心（satellite）的所有在線機器
const machines = getActiveMachinesFrom(satellite);

// 透過 `filter` 把該指定資料中心的機器（而非所有資料中心的所有機器）進行退役
sendToDecom({
  candidates: getAllActiveMachines(),
  filter: machines,
});
```

當維運人員進行日常的退役工作時，自動化執行結果得知有錯（然而實際上卻已經正確進行退役），
這時維運人員為了除錯，再一次的執行這個自動化腳本：

```javascript
// 因為上一次把所有機器都退役了，所以這裡會得到空的陣列
const machines = getActiveMachinesFrom(satellite);

// `filter` 收到空陣列後，會直接選用所有的 `candidates` 而非空陣列
sendToDecom({
  candidates: getAllActiveMachines(),
  filter: machines,
});
```

由於 `filter` 是空陣列，全世界所有衛星內受託管的機器都被進行磁碟抹除，
因為衛星內的機器被判定為失能，全世界所有的流量都被導流進 Google 自己維護的資料中心。

幸虧當初的容量規劃讓 Google 有能力承載這些流量，
這次的事件雖然耗時了兩天才把所有資料中心的伺服器恢復正常，但只造成些微的潛時（latency）上升。
並且在事後數週進行健全的監控和建立阻斷器，
並確保該自動化流程是冪等的（idempotent，重複執行不會互相影響）。
三年後，類似的事件導致部分衛星的伺服器失能，
而三年前的整治手段大大降低了該事件的爆炸半徑和恢復時間。

接下來，我們就來撰寫看看這次事件的事後析誤文件，並比較兩個不同文件的差異。

### 壞的事後析誤文件

事件所有者：楊一@、李二@、陳三@、王四@

事件審閱團隊：衛星基礎設施維運團隊@

狀態：完成

事件發生日：2014-08-11

文件發布日：2014-12-30

事件概要：

-   影響：所有衛星機器都被磁碟抹除，並導致所有 Google 的邊緣運算能力失效。
-   根因：王四@ 忽略執行後的檢查，直接重複執行自動化的操作，進而觸發錯誤。

狀況總結：

-   持續時間：40 分鐘。
-   影響產品：邊緣運算資源。
-   影響比例：所有邊緣運算。
-   使用者影響：所有經過邊緣運算的請求潛時拉高。
-   收益影響：有些廣告因為潛時拉高，沒有正確投放。
-   發現於：監控告警。
-   復原於：透過人工復原邊緣運算，持續導引流量。

背景（非必要）：無。

影響：

-   使用者影響：潛時拉高。
-   收益影響：有些廣告沒辦法投放。

根因和觸發點：

> 叢集的自動化操作不是冪等的。
> 程式碼本身有避免部分機制重新執行的限制，但是無法阻止使用者重複執行程式本身。
> 荒唐的是沒有任何文件說明這個陷阱，導致團隊成員大部分都任何重複執行是可被接受的。
>
> 這便是在執行日常退役時，發生的錯誤原因。
> 我們正準備把機器進行替換時，王四@ 完全忽略了上一次操作已經正確執行，
> 因為他的不小心導致進一步觸發該陷阱。

復原操作：無

學到了什麼：

-   我們做對了：告警成功觸發、事件管理機制正確運行。
-   我們沒做好：團隊（特別是楊一@、李二@）竟然沒有撰寫文件告知大家不要重複執行程式碼。
-   我們沒做好：待命小組沒有成功阻止磁碟抹除的自動化腳本從單一叢集擴大到全部叢集，
    並且已經不是第一次反應這麼慢了。
-   幸運的事：核心運算資源能正常處理全球的流量，我不敢置信我們成功的避免災難發生！！

後續優化：

| 項目 | 種類 | 優先度 | 負責人 | 票 |
| - | - | - | - | - |
| 讓自動化更好 | 緩解 | 2 | 李二@ | |
| 優化告警 | 偵測 | 2 | | |
| 陳三@需要學習如何跨資料中心的交付協議 | 緩解 | 2 | | TICKET-123 |
| 教育訓練避免錯誤執行指令 | 預防 | 2 | | |

詞彙表：無

### 為什麼文件寫得是糟

災難的價值在於好的事後析誤，正因如此，我們花時間去撰寫這份文件，將變得至關重要。
閱讀者在看這份文件時，應該要清楚事件的脈絡，更重要的是能從事件中學到些什麼。

接下來我們分析一下為什麼上一份文件寫得很爛。

#### 背景描述的匱乏

本次事件有幾個專有名詞，
例如 *衛星* 代表用來處理邊緣運算的機器、*磁碟抹除* 代表自動化運行的腳本。
如果你需要提供一些背景知識，請額外增加一些段落來說明，例如「詞彙表」或「背景知識」。

一個缺乏清楚概絡的文件，不只會讓人看不懂，
甚至會讓人選擇忽略這份文件，進而把能從事件學到的東西直接歸零。

#### 關鍵細節的忽略

很多段落只有高層次的概觀，缺乏重要的細節，例如：

狀況總結中，我們無法從這份文件得知事件的影響範圍，如果影響範圍是多個產品，請明確給出相關的數值。
這份文件中只有持續時間是數字，如果沒有相關數值，請盡量給出個估計，
畢竟 **沒有正確的爆炸半徑，就無法正確評估是否修復完成**。

根因和觸發點是事後析誤文件中非常重要的一點。
在這份文件中，只有看到一小段落，缺乏足夠細節讓人能夠有機會思考其中的改進點。

我們通常能在復原操作段落中找到發生了什麼，怎麼被緩解以及使用者是怎麼被影響的，
然而這份文件卻完全空白。

#### 後續優化的貧乏

後續優化（Action Items, AIs）有幾個面向去評斷他的好壞，例如：

-   大部分的優化都是緩解型或預防型的，在預防過程中，不要期待人類不會犯錯，應該考慮的是如何
    「讓人類無法在此地犯錯」，其中冪等就是一個很好的特徵。
    > 讓我們假設未來參與維運本服務的人員，都和事件中的我們一樣愚蠢。
    >
    > — Dan Milstein，[Post-Mortems at HubSpot: What I Learned From 250 Whys](https://product.hubspot.com/blog/bid/64771/Post-Mortems-at-HubSpot-What-I-Learned-From-250-Whys)
-   每個優化都是相同的優先程度，會讓這個欄位失去意義。
    > 對客戶來說，一個沒有後續優化的事後析誤文件，等於沒有文件，所以任何一個會影響客戶的事件，
    > 都應該要有至少一個優先程度為為 0 或 1 的改善項目。
-   勁量避免使用「讓他更好」、「優化」等泛化的詞彙，會讓人無法分析該優化的完成度。
-   如果沒有票去追蹤相關優化，這些改善都很容易被遺忘。

#### 指責型的敘述

明確說明何人在何時何地犯錯看起來是個合理的撰寫文件方式，但是這會讓這些人更害怕犯錯，
進而選擇掩蓋錯誤，最後讓於本次事件的根因或觸發點被錯誤解釋。
常見的範例可能是：

-   把團隊成員指明出來負責，應該以團隊為單位去歸咎事件；
-   要求特定成員的教育訓練。

#### 誇張的用詞

例如：不敢置信、很荒唐地。

事後析誤文化是一個事實導向的文件，也當然允許個人的評論和質疑，
它應當是提供一個空間讓多人多角度且互相尊重地去討論本次事件。
但是過多的情緒言論會影響其他人進來參與的意願，好的方法應當是以資料為佐證去闡述相關論點。

#### 事項的歸屬人員

這個事後析誤文件找不到應該由哪個人負責撰寫、追蹤以及回答其他人的疑問，
而是提供了四個人的名字，讓大家去猜。

後續優化項目缺乏明確的負責人，這會讓這些改善很難進行後續追蹤。

#### 文件的閱讀人員

在這份文件中，只允許團隊內部人員查看，Google 建議事後析誤文件是允許公司內部所有人員查看的。
因為事後析誤文件的價值就是讓越多人從中學到越多事情越好。
更有甚者，也可以把這份文件公佈給公司外部人員查看，
因為**一個被妥善撰寫且誠實的文件也是一個恢復大家對公司信任的好方法**。

#### 文件發布的延宕

這份文件的發布已經是事件發生後的好幾個月了，團隊成員對於本次事件的記憶已經模糊，
很可能在撰寫上出現瑕疵。

### 好的事後析誤文件

接下來的範例是實際上存在的文件，雖然會把一些敏感資料藏起來，但足以檢驗何為好的事後析誤文件。

事件所有者：

-   文件撰寫：楊一@、李二@
-   資料中心自動化腳本：陳三@
-   網路管理：王四@
-   系統管理：劉五@

事件審閱團隊：所有工程員工@google.com

狀態：完成

事件發生日：2014-08-11，週一，17:10 to 17:50 PST8PDT

文件發布日：2014-08-15，週五

事件概要：

-   影響：
    -   前端請求被丟棄；
    -   一些廣告沒辦法播放；
    -   所有被衛星所服務的應用，其潛時都被拉高並持續接近兩天。
-   根因：設備退休相關的自動化有錯，導致並非特定機櫃的設備進行磁碟抹除。
    這讓全世界所有衛星的設備都被排進退休流程，最終其能提供的前端快取都無法運作了。

狀況總結：

-   持續時間：
    -   主要於 08-11，週一，17:10 到 17:50 PST8PDT；
    -   重新建置和潛時拉高的狀況持續到 08-13，周三，07:46 PST8PDT，並於此時關閉事件。
-   影響產品：前端基礎設施，特別是使用衛星的地區。
-   影響比例：所有透過衛星服務的全球性流量（一般來說約為 60% 的總流量）。
-   使用者影響：
    -   `xx` 的前端流量被丟棄並持續 40 分鐘（期間內平均的 QPS 為 `xx`，佔總流量的 `xx%`）；
    -   所有有被衛星設備服務的應用，其潛時都被拉高並持續兩天。
-   收益影響：實際收益影響目前不可知。
-   發現於：Blackbox 監控，團隊收到幾乎全球所有衛星設備的錯誤訊息：
    `satellite-a12bcd34 服務太多失敗 HTTP 請求`
-   復原於：災難發生後，所有流量迅速被導流至 Google 擁有的前端叢集中，但是相關潛時都被拉高了。

背景（非必要）：無。

## 結論

歷程大致是：
從小的專案開始，
透過工具和模板來寫好報告，
確實依據報告來做實踐和修正，
最後鼓勵且公開把這些報告分享給大家。

文中也提到一些手法來辨別在推行文化中，可能的壞味道。
